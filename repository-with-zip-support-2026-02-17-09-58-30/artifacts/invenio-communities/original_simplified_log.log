 redis Pulling 
 postgresql Pulling 
 opensearch Pulling 
 4f4fb700ef54 Already exists 
 4f4fb700ef54 Already exists 
 redis Pulled 
 postgresql Pulled 
 opensearch Pulled 
 Network docker_services_cli_default  Creating
 Network docker_services_cli_default  Created
 Container docker_services_cli-postgresql-1  Creating
 Container docker_services_cli-opensearch-1  Creating
 Container docker_services_cli-redis-1  Creating
 Container docker_services_cli-opensearch-1  Created
 Container docker_services_cli-postgresql-1  Created
 Container docker_services_cli-redis-1  Created
 Container docker_services_cli-postgresql-1  Starting
 Container docker_services_cli-redis-1  Starting
 Container docker_services_cli-opensearch-1  Starting
 Container docker_services_cli-redis-1  Started
 Container docker_services_cli-opensearch-1  Started
 Container docker_services_cli-postgresql-1  Started
============================= test session starts ==============================
platform linux -- Python 3.14.2, pytest-8.4.2, pluggy-1.6.0
rootdir: /home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original
configfile: setup.cfg
plugins: isort-4.0.0, flask-1.3.0, black-ng-0.4.1, invenio-3.4.2, github-actions-annotate-failures-0.3.0, pydocstyle-2.4.0, Faker-40.4.0, cov-7.0.0, pycodestyle-2.5.0
collected 258 items
tests/cache/test_identity_redis_cache.py ....                            [  1%]
tests/communities/test_alembic.py s                                      [  1%]
tests/communities/test_cli.py 
                                         [  2%]
tests/communities/test_community_ui_serializer.py 
                      [  3%]
tests/communities/test_components.py 
                              [  5%]
tests/communities/test_parent_community.py 
                        [  7%]
tests/communities/test_permissions.py 
                                  [  8%]
tests/communities/test_relations_organizations.py 
                 [ 10%]
tests/communities/test_relations_types.py 
                         [ 12%]
tests/communities/test_resources.py 
                  [ 20%]
tests/communities/test_services.py 
                [ 28%]
tests/communities/test_subcommunities.py 
                           [ 30%]
tests/communities/test_tombstone.py 
                              [ 33%]
tests/communities/test_ui.py 
                                           [ 33%]
tests/members/test_members_components.py E
                           [ 35%]
tests/members/test_members_no_groups.py 
                         [ 38%]
tests/members/test_members_notifications.py ::error file=workdir/tests/invenio-communities/original/tests/members/test_members_notifications.py,line=71::test_community_invitation_submit_notification%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-communities/original/tests/members/test_members_notifications.py,line=146::test_community_invitation_accept_notification%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-communities/original/tests/members/test_members_notifications.py,line=203::test_community_invitation_cancel_notification%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-communities/original/tests/members/test_members_notifications.py,line=258::test_community_invitation_decline_notification%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-communities/original/tests/members/test_members_notifications.py,line=316::test_community_invitation_expire_notification%0A%0AKeyError: 'identity'
F
                        [ 40%]
tests/members/test_members_resource.py 
::error file=workdir/tests/invenio-communities/original/tests/members/test_members_resource.py,line=108::test_invite%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-communities/original/tests/members/test_members_resource.py,line=233::test_search%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-communities/original/tests/members/test_members_resource.py,line=295::test_search_public%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-communities/original/tests/members/test_members_resource.py,line=328::test_search_invitation%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-communities/original/tests/members/test_members_resource.py,line=372::test_post_membership_requests%0A%0AKeyError: 'identity'
F
                 [ 47%]
tests/members/test_members_services.py 
::error file=workdir/tests/invenio-communities/original/tests/members/test_members_services.py,line=193::test_invite%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-communities/original/tests/members/test_members_services.py,line=249::test_invite_already_member%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-communities/original/tests/members/test_members_services.py,line=296::test_invite_view_request%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-communities/original/tests/members/test_members_services.py,line=321::test_search_members%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-communities/original/tests/members/test_members_services.py,line=344::test_scan_members%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-communities/original/tests/members/test_members_services.py,line=356::test_search_public_members%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-communities/original/tests/members/test_members_services.py,line=386::test_search_members_restricted%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-communities/original/tests/members/test_members_services.py,line=402::test_search_members_visibility_restricted%0A%0AKeyError: 'identity'
F
E [ 60%]
E
E
E
E
 [ 87%]
E
E
E
::error file=workdir/tests/invenio-communities/original/tests/members/test_members_services.py,line=1191::test_request_cancel_request_flow%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-communities/original/tests/members/test_members_services.py,line=1212::test_relation_update_propagation%0A%0AKeyError: 'identity'
F
                                                      [ 95%]
tests/records/test_mockrecords_api.py 
                        [ 99%]
tests/test_notifications.py ::error file=workdir/tests/invenio-communities/original/tests/test_notifications.py,line=25::test_user_recipient_generator%0A%0AKeyError: 'identity'
F
                                            [100%]
==================================== ERRORS ====================================
_______________ ERROR at setup of test_accept_invite_cache_clear _______________
requests_service = <invenio_requests.services.requests.service.RequestsService object at 0x7fb4c6b0c3d0>
invite_user = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c7b23750>
    @pytest.fixture(scope="function")
    def invite_request_id(requests_service, invite_user):
        """An invitation request."""
        Request.index.refresh()
        res = requests_service.search(
            invite_user.identity,
            receiver={"user": invite_user.id},
            type="community-invitation",
>       ).to_dict()
          ^^^^^^^^^
tests/members/conftest.py:94: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py:187: in to_dict
    hits = list(self.hits)
           ^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py:167: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:656: in _serialize
    return schema.dump(nested_obj, many=many)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <RequestEventSchema(many=False)>
obj = {'$schema': 'local://requestevents/requestevent-v1.0.0.json', 'payload': {'format': 'html', 'content': 'Welcome to the club!'}, 'created_by': {'user': '1'}, 'request_id': '56febeac-444d-428a-a95e-bcad5be8eeae'}
    def get_permissions(self, obj):
        """Return permissions to act on comments or empty dict."""
        is_comment = obj.type == CommentEventType
        if is_comment:
            service = current_requests.request_events_service
            return {
                "can_update_comment": service.check_permission(
>                   self.context["identity"],
                    ^^^^^^^^^^^^^^^^^^^^^^^^
                    "update_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
                "can_delete_comment": service.check_permission(
                    self.context["identity"],
                    "delete_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
            }
E           KeyError: 'identity'
venv/lib/python3.14/site-packages/invenio_requests/services/schemas.py:50: KeyError
---------------------------- Captured stderr setup -----------------------------
Flask-DebugToolbar extension not installed
[2026-02-17 10:05:19,666] DEBUG in ext: Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
------------------------------ Captured log setup ------------------------------
DEBUG    invenio:ext.py:99 Flask-DebugToolbar extension not installed
ERROR    celery.app.trace:trace.py:267 Task invenio_notifications.tasks.broadcast_notification[5c81b1ef-59d7-4435-9494-75d2b6527915] raised unexpected: KeyError('identity')
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/celery/app/trace.py", line 453, in trace_task
    R = retval = fun(*args, **kwargs)
                 ~~~^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/tasks.py", line 21, in broadcast_notification
    current_notifications_manager.handle_broadcast(Notification(**notification))
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/manager.py", line 45, in handle_broadcast
    builder.resolve_context(notification)
    ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/builders.py", line 43, in resolve_context
    ctx_func(notification)
    ~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/generators.py", line 80, in __call__
    entity = EntityResolverRegistry.resolve_entity(entity_ref)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/registry.py", line 57, in resolve_entity
    return proxy.resolve()
           ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/base.py", line 86, in resolve
    self._entity = self._resolve()
                   ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/results.py", line 28, in _resolve
    return self.service.read(system_identity, id_).to_dict()
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py", line 101, in to_dict
    res = self.data
          ^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py", line 76, in data
    self._data = self._schema.dump(
                 ~~~~~~~~~~~~~~~~~^
        self._obj,
        ^^^^^^^^^^
    ...<3 lines>
        },
        ^^
    )
    ^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py", line 118, in dump
    return self.schema(**schema_args).dump(data)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 656, in _serialize
    return schema.dump(nested_obj, many=many)
           ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 2026, in _serialize
    return self._serialize_method(obj)
           ~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/schemas.py", line 50, in get_permissions
    self.context["identity"],
    ~~~~~~~~~~~~^^^^^^^^^^^^
KeyError: 'identity'
__________________ ERROR at setup of test_search_invitations ___________________
requests_service = <invenio_requests.services.requests.service.RequestsService object at 0x7fb4ce1e2830>
invite_user = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c697cec0>
    @pytest.fixture(scope="function")
    def invite_request_id(requests_service, invite_user):
        """An invitation request."""
        Request.index.refresh()
        res = requests_service.search(
            invite_user.identity,
            receiver={"user": invite_user.id},
            type="community-invitation",
>       ).to_dict()
          ^^^^^^^^^
tests/members/conftest.py:94: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py:187: in to_dict
    hits = list(self.hits)
           ^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py:167: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:656: in _serialize
    return schema.dump(nested_obj, many=many)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <RequestEventSchema(many=False)>
obj = {'$schema': 'local://requestevents/requestevent-v1.0.0.json', 'payload': {'format': 'html', 'content': 'Welcome to the club!'}, 'created_by': {'user': '1'}, 'request_id': '13b731de-72b0-4ca7-a6a8-be35f1710ee3'}
    def get_permissions(self, obj):
        """Return permissions to act on comments or empty dict."""
        is_comment = obj.type == CommentEventType
        if is_comment:
            service = current_requests.request_events_service
            return {
                "can_update_comment": service.check_permission(
>                   self.context["identity"],
                    ^^^^^^^^^^^^^^^^^^^^^^^^
                    "update_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
                "can_delete_comment": service.check_permission(
                    self.context["identity"],
                    "delete_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
            }
E           KeyError: 'identity'
venv/lib/python3.14/site-packages/invenio_requests/services/schemas.py:50: KeyError
------------------------------ Captured log setup ------------------------------
ERROR    celery.app.trace:trace.py:267 Task invenio_notifications.tasks.broadcast_notification[a0e49059-706b-4ec9-8702-4f09a7d66597] raised unexpected: KeyError('identity')
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/celery/app/trace.py", line 453, in trace_task
    R = retval = fun(*args, **kwargs)
                 ~~~^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/tasks.py", line 21, in broadcast_notification
    current_notifications_manager.handle_broadcast(Notification(**notification))
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/manager.py", line 45, in handle_broadcast
    builder.resolve_context(notification)
    ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/builders.py", line 43, in resolve_context
    ctx_func(notification)
    ~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/generators.py", line 80, in __call__
    entity = EntityResolverRegistry.resolve_entity(entity_ref)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/registry.py", line 57, in resolve_entity
    return proxy.resolve()
           ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/base.py", line 86, in resolve
    self._entity = self._resolve()
                   ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/results.py", line 28, in _resolve
    return self.service.read(system_identity, id_).to_dict()
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py", line 101, in to_dict
    res = self.data
          ^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py", line 76, in data
    self._data = self._schema.dump(
                 ~~~~~~~~~~~~~~~~~^
        self._obj,
        ^^^^^^^^^^
    ...<3 lines>
        },
        ^^
    )
    ^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py", line 118, in dump
    return self.schema(**schema_args).dump(data)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 656, in _serialize
    return schema.dump(nested_obj, many=many)
           ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 2026, in _serialize
    return self._serialize_method(obj)
           ~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/schemas.py", line 50, in get_permissions
    self.context["identity"],
    ~~~~~~~~~~~~^^^^^^^^^^^^
KeyError: 'identity'
__________________ ERROR at setup of test_invite_accept_flow ___________________
requests_service = <invenio_requests.services.requests.service.RequestsService object at 0x7fb4ce1e2830>
invite_user = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c697cec0>
    @pytest.fixture(scope="function")
    def invite_request_id(requests_service, invite_user):
        """An invitation request."""
        Request.index.refresh()
        res = requests_service.search(
            invite_user.identity,
            receiver={"user": invite_user.id},
            type="community-invitation",
>       ).to_dict()
          ^^^^^^^^^
tests/members/conftest.py:94: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py:187: in to_dict
    hits = list(self.hits)
           ^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py:167: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:656: in _serialize
    return schema.dump(nested_obj, many=many)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <RequestEventSchema(many=False)>
obj = {'$schema': 'local://requestevents/requestevent-v1.0.0.json', 'payload': {'format': 'html', 'content': 'Welcome to the club!'}, 'created_by': {'user': '1'}, 'request_id': '0c3e684f-e2b3-4a2b-bd65-842f2e86cf82'}
    def get_permissions(self, obj):
        """Return permissions to act on comments or empty dict."""
        is_comment = obj.type == CommentEventType
        if is_comment:
            service = current_requests.request_events_service
            return {
                "can_update_comment": service.check_permission(
>                   self.context["identity"],
                    ^^^^^^^^^^^^^^^^^^^^^^^^
                    "update_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
                "can_delete_comment": service.check_permission(
                    self.context["identity"],
                    "delete_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
            }
E           KeyError: 'identity'
venv/lib/python3.14/site-packages/invenio_requests/services/schemas.py:50: KeyError
------------------------------ Captured log setup ------------------------------
ERROR    celery.app.trace:trace.py:267 Task invenio_notifications.tasks.broadcast_notification[a487c000-39b9-4838-8dc3-b9898b923af5] raised unexpected: KeyError('identity')
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/celery/app/trace.py", line 453, in trace_task
    R = retval = fun(*args, **kwargs)
                 ~~~^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/tasks.py", line 21, in broadcast_notification
    current_notifications_manager.handle_broadcast(Notification(**notification))
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/manager.py", line 45, in handle_broadcast
    builder.resolve_context(notification)
    ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/builders.py", line 43, in resolve_context
    ctx_func(notification)
    ~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/generators.py", line 80, in __call__
    entity = EntityResolverRegistry.resolve_entity(entity_ref)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/registry.py", line 57, in resolve_entity
    return proxy.resolve()
           ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/base.py", line 86, in resolve
    self._entity = self._resolve()
                   ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/results.py", line 28, in _resolve
    return self.service.read(system_identity, id_).to_dict()
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py", line 101, in to_dict
    res = self.data
          ^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py", line 76, in data
    self._data = self._schema.dump(
                 ~~~~~~~~~~~~~~~~~^
        self._obj,
        ^^^^^^^^^^
    ...<3 lines>
        },
        ^^
    )
    ^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py", line 118, in dump
    return self.schema(**schema_args).dump(data)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 656, in _serialize
    return schema.dump(nested_obj, many=many)
           ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 2026, in _serialize
    return self._serialize_method(obj)
           ~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/schemas.py", line 50, in get_permissions
    self.context["identity"],
    ~~~~~~~~~~~~^^^^^^^^^^^^
KeyError: 'identity'
__________________ ERROR at setup of test_invite_decline_flow __________________
requests_service = <invenio_requests.services.requests.service.RequestsService object at 0x7fb4ce1e2830>
invite_user = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c697cec0>
    @pytest.fixture(scope="function")
    def invite_request_id(requests_service, invite_user):
        """An invitation request."""
        Request.index.refresh()
        res = requests_service.search(
            invite_user.identity,
            receiver={"user": invite_user.id},
            type="community-invitation",
>       ).to_dict()
          ^^^^^^^^^
tests/members/conftest.py:94: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py:187: in to_dict
    hits = list(self.hits)
           ^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py:167: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:656: in _serialize
    return schema.dump(nested_obj, many=many)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <RequestEventSchema(many=False)>
obj = {'$schema': 'local://requestevents/requestevent-v1.0.0.json', 'payload': {'format': 'html', 'content': 'Welcome to the club!'}, 'created_by': {'user': '1'}, 'request_id': '45a1f424-be5a-49ea-889e-20b843b81c6e'}
    def get_permissions(self, obj):
        """Return permissions to act on comments or empty dict."""
        is_comment = obj.type == CommentEventType
        if is_comment:
            service = current_requests.request_events_service
            return {
                "can_update_comment": service.check_permission(
>                   self.context["identity"],
                    ^^^^^^^^^^^^^^^^^^^^^^^^
                    "update_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
                "can_delete_comment": service.check_permission(
                    self.context["identity"],
                    "delete_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
            }
E           KeyError: 'identity'
venv/lib/python3.14/site-packages/invenio_requests/services/schemas.py:50: KeyError
------------------------------ Captured log setup ------------------------------
ERROR    celery.app.trace:trace.py:267 Task invenio_notifications.tasks.broadcast_notification[5e1886b7-9b30-4896-a8e9-7fefd19edf50] raised unexpected: KeyError('identity')
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/celery/app/trace.py", line 453, in trace_task
    R = retval = fun(*args, **kwargs)
                 ~~~^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/tasks.py", line 21, in broadcast_notification
    current_notifications_manager.handle_broadcast(Notification(**notification))
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/manager.py", line 45, in handle_broadcast
    builder.resolve_context(notification)
    ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/builders.py", line 43, in resolve_context
    ctx_func(notification)
    ~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/generators.py", line 80, in __call__
    entity = EntityResolverRegistry.resolve_entity(entity_ref)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/registry.py", line 57, in resolve_entity
    return proxy.resolve()
           ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/base.py", line 86, in resolve
    self._entity = self._resolve()
                   ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/results.py", line 28, in _resolve
    return self.service.read(system_identity, id_).to_dict()
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py", line 101, in to_dict
    res = self.data
          ^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py", line 76, in data
    self._data = self._schema.dump(
                 ~~~~~~~~~~~~~~~~~^
        self._obj,
        ^^^^^^^^^^
    ...<3 lines>
        },
        ^^
    )
    ^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py", line 118, in dump
    return self.schema(**schema_args).dump(data)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 656, in _serialize
    return schema.dump(nested_obj, many=many)
           ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 2026, in _serialize
    return self._serialize_method(obj)
           ~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/schemas.py", line 50, in get_permissions
    self.context["identity"],
    ~~~~~~~~~~~~^^^^^^^^^^^^
KeyError: 'identity'
__________________ ERROR at setup of test_invite_cancel_flow ___________________
requests_service = <invenio_requests.services.requests.service.RequestsService object at 0x7fb4ce1e2830>
invite_user = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c697cec0>
    @pytest.fixture(scope="function")
    def invite_request_id(requests_service, invite_user):
        """An invitation request."""
        Request.index.refresh()
        res = requests_service.search(
            invite_user.identity,
            receiver={"user": invite_user.id},
            type="community-invitation",
>       ).to_dict()
          ^^^^^^^^^
tests/members/conftest.py:94: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py:187: in to_dict
    hits = list(self.hits)
           ^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py:167: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:656: in _serialize
    return schema.dump(nested_obj, many=many)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <RequestEventSchema(many=False)>
obj = {'$schema': 'local://requestevents/requestevent-v1.0.0.json', 'payload': {'format': 'html', 'content': 'Welcome to the club!'}, 'created_by': {'user': '1'}, 'request_id': 'f2a27a8e-19ef-47fe-9114-afc46ce35682'}
    def get_permissions(self, obj):
        """Return permissions to act on comments or empty dict."""
        is_comment = obj.type == CommentEventType
        if is_comment:
            service = current_requests.request_events_service
            return {
                "can_update_comment": service.check_permission(
>                   self.context["identity"],
                    ^^^^^^^^^^^^^^^^^^^^^^^^
                    "update_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
                "can_delete_comment": service.check_permission(
                    self.context["identity"],
                    "delete_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
            }
E           KeyError: 'identity'
venv/lib/python3.14/site-packages/invenio_requests/services/schemas.py:50: KeyError
------------------------------ Captured log setup ------------------------------
ERROR    celery.app.trace:trace.py:267 Task invenio_notifications.tasks.broadcast_notification[1ca19cd5-af93-40d0-9593-a9683b7b6420] raised unexpected: KeyError('identity')
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/celery/app/trace.py", line 453, in trace_task
    R = retval = fun(*args, **kwargs)
                 ~~~^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/tasks.py", line 21, in broadcast_notification
    current_notifications_manager.handle_broadcast(Notification(**notification))
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/manager.py", line 45, in handle_broadcast
    builder.resolve_context(notification)
    ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/builders.py", line 43, in resolve_context
    ctx_func(notification)
    ~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/generators.py", line 80, in __call__
    entity = EntityResolverRegistry.resolve_entity(entity_ref)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/registry.py", line 57, in resolve_entity
    return proxy.resolve()
           ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/base.py", line 86, in resolve
    self._entity = self._resolve()
                   ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/results.py", line 28, in _resolve
    return self.service.read(system_identity, id_).to_dict()
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py", line 101, in to_dict
    res = self.data
          ^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py", line 76, in data
    self._data = self._schema.dump(
                 ~~~~~~~~~~~~~~~~~^
        self._obj,
        ^^^^^^^^^^
    ...<3 lines>
        },
        ^^
    )
    ^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py", line 118, in dump
    return self.schema(**schema_args).dump(data)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 656, in _serialize
    return schema.dump(nested_obj, many=many)
           ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 2026, in _serialize
    return self._serialize_method(obj)
           ~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/schemas.py", line 50, in get_permissions
    self.context["identity"],
    ~~~~~~~~~~~~^^^^^^^^^^^^
KeyError: 'identity'
______________ ERROR at setup of test_invite_actions_permissions _______________
requests_service = <invenio_requests.services.requests.service.RequestsService object at 0x7fb4ce1e2830>
invite_user = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c697cec0>
    @pytest.fixture(scope="function")
    def invite_request_id(requests_service, invite_user):
        """An invitation request."""
        Request.index.refresh()
        res = requests_service.search(
            invite_user.identity,
            receiver={"user": invite_user.id},
            type="community-invitation",
>       ).to_dict()
          ^^^^^^^^^
tests/members/conftest.py:94: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py:187: in to_dict
    hits = list(self.hits)
           ^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py:167: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:656: in _serialize
    return schema.dump(nested_obj, many=many)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <RequestEventSchema(many=False)>
obj = {'$schema': 'local://requestevents/requestevent-v1.0.0.json', 'payload': {'format': 'html', 'content': 'Welcome to the club!'}, 'created_by': {'user': '1'}, 'request_id': '746c3c9a-3bf5-41b8-8c21-13b30ea4a599'}
    def get_permissions(self, obj):
        """Return permissions to act on comments or empty dict."""
        is_comment = obj.type == CommentEventType
        if is_comment:
            service = current_requests.request_events_service
            return {
                "can_update_comment": service.check_permission(
>                   self.context["identity"],
                    ^^^^^^^^^^^^^^^^^^^^^^^^
                    "update_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
                "can_delete_comment": service.check_permission(
                    self.context["identity"],
                    "delete_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
            }
E           KeyError: 'identity'
venv/lib/python3.14/site-packages/invenio_requests/services/schemas.py:50: KeyError
---------------------------- Captured stderr setup -----------------------------
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
[2026-02-17 10:05:52,694] ERROR in api: Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
[2026-02-17 10:05:52,697] ERROR in api: Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
------------------------------ Captured log setup ------------------------------
ERROR    invenio:api.py:376 Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
ERROR    invenio:api.py:376 Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
ERROR    celery.app.trace:trace.py:267 Task invenio_notifications.tasks.broadcast_notification[e492bd02-d43f-408b-8141-0c4e7cebd844] raised unexpected: KeyError('identity')
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/celery/app/trace.py", line 453, in trace_task
    R = retval = fun(*args, **kwargs)
                 ~~~^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/tasks.py", line 21, in broadcast_notification
    current_notifications_manager.handle_broadcast(Notification(**notification))
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/manager.py", line 45, in handle_broadcast
    builder.resolve_context(notification)
    ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/builders.py", line 43, in resolve_context
    ctx_func(notification)
    ~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/generators.py", line 80, in __call__
    entity = EntityResolverRegistry.resolve_entity(entity_ref)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/registry.py", line 57, in resolve_entity
    return proxy.resolve()
           ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/base.py", line 86, in resolve
    self._entity = self._resolve()
                   ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/results.py", line 28, in _resolve
    return self.service.read(system_identity, id_).to_dict()
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py", line 101, in to_dict
    res = self.data
          ^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py", line 76, in data
    self._data = self._schema.dump(
                 ~~~~~~~~~~~~~~~~~^
        self._obj,
        ^^^^^^^^^^
    ...<3 lines>
        },
        ^^
    )
    ^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py", line 118, in dump
    return self.schema(**schema_args).dump(data)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 656, in _serialize
    return schema.dump(nested_obj, many=many)
           ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 2026, in _serialize
    return self._serialize_method(obj)
           ~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/schemas.py", line 50, in get_permissions
    self.context["identity"],
    ~~~~~~~~~~~~^^^^^^^^^^^^
KeyError: 'identity'
__________ ERROR at setup of test_update_declined_invitation[decline] __________
requests_service = <invenio_requests.services.requests.service.RequestsService object at 0x7fb4ce1e2830>
invite_user = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c697cec0>
    @pytest.fixture(scope="function")
    def invite_request_id(requests_service, invite_user):
        """An invitation request."""
        Request.index.refresh()
        res = requests_service.search(
            invite_user.identity,
            receiver={"user": invite_user.id},
            type="community-invitation",
>       ).to_dict()
          ^^^^^^^^^
tests/members/conftest.py:94: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py:187: in to_dict
    hits = list(self.hits)
           ^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py:167: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:656: in _serialize
    return schema.dump(nested_obj, many=many)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <RequestEventSchema(many=False)>
obj = {'$schema': 'local://requestevents/requestevent-v1.0.0.json', 'payload': {'format': 'html', 'content': 'Welcome to the club!'}, 'created_by': {'user': '1'}, 'request_id': '4838859c-5f67-4421-b4ba-d7683e68d6d4'}
    def get_permissions(self, obj):
        """Return permissions to act on comments or empty dict."""
        is_comment = obj.type == CommentEventType
        if is_comment:
            service = current_requests.request_events_service
            return {
                "can_update_comment": service.check_permission(
>                   self.context["identity"],
                    ^^^^^^^^^^^^^^^^^^^^^^^^
                    "update_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
                "can_delete_comment": service.check_permission(
                    self.context["identity"],
                    "delete_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
            }
E           KeyError: 'identity'
venv/lib/python3.14/site-packages/invenio_requests/services/schemas.py:50: KeyError
------------------------------ Captured log setup ------------------------------
ERROR    celery.app.trace:trace.py:267 Task invenio_notifications.tasks.broadcast_notification[719d0a1e-a8ec-4ccc-bafd-7cdb844fecb0] raised unexpected: KeyError('identity')
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/celery/app/trace.py", line 453, in trace_task
    R = retval = fun(*args, **kwargs)
                 ~~~^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/tasks.py", line 21, in broadcast_notification
    current_notifications_manager.handle_broadcast(Notification(**notification))
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/manager.py", line 45, in handle_broadcast
    builder.resolve_context(notification)
    ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/builders.py", line 43, in resolve_context
    ctx_func(notification)
    ~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/generators.py", line 80, in __call__
    entity = EntityResolverRegistry.resolve_entity(entity_ref)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/registry.py", line 57, in resolve_entity
    return proxy.resolve()
           ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/base.py", line 86, in resolve
    self._entity = self._resolve()
                   ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/results.py", line 28, in _resolve
    return self.service.read(system_identity, id_).to_dict()
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py", line 101, in to_dict
    res = self.data
          ^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py", line 76, in data
    self._data = self._schema.dump(
                 ~~~~~~~~~~~~~~~~~^
        self._obj,
        ^^^^^^^^^^
    ...<3 lines>
        },
        ^^
    )
    ^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py", line 118, in dump
    return self.schema(**schema_args).dump(data)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 656, in _serialize
    return schema.dump(nested_obj, many=many)
           ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 2026, in _serialize
    return self._serialize_method(obj)
           ~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/schemas.py", line 50, in get_permissions
    self.context["identity"],
    ~~~~~~~~~~~~^^^^^^^^^^^^
KeyError: 'identity'
__________ ERROR at setup of test_update_declined_invitation[cancel] ___________
requests_service = <invenio_requests.services.requests.service.RequestsService object at 0x7fb4ce1e2830>
invite_user = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c697cec0>
    @pytest.fixture(scope="function")
    def invite_request_id(requests_service, invite_user):
        """An invitation request."""
        Request.index.refresh()
        res = requests_service.search(
            invite_user.identity,
            receiver={"user": invite_user.id},
            type="community-invitation",
>       ).to_dict()
          ^^^^^^^^^
tests/members/conftest.py:94: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py:187: in to_dict
    hits = list(self.hits)
           ^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py:167: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:656: in _serialize
    return schema.dump(nested_obj, many=many)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <RequestEventSchema(many=False)>
obj = {'$schema': 'local://requestevents/requestevent-v1.0.0.json', 'payload': {'format': 'html', 'content': 'Welcome to the club!'}, 'created_by': {'user': '1'}, 'request_id': 'e3da079a-64ff-4a5d-bef7-a1d959f4c195'}
    def get_permissions(self, obj):
        """Return permissions to act on comments or empty dict."""
        is_comment = obj.type == CommentEventType
        if is_comment:
            service = current_requests.request_events_service
            return {
                "can_update_comment": service.check_permission(
>                   self.context["identity"],
                    ^^^^^^^^^^^^^^^^^^^^^^^^
                    "update_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
                "can_delete_comment": service.check_permission(
                    self.context["identity"],
                    "delete_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
            }
E           KeyError: 'identity'
venv/lib/python3.14/site-packages/invenio_requests/services/schemas.py:50: KeyError
------------------------------ Captured log setup ------------------------------
ERROR    celery.app.trace:trace.py:267 Task invenio_notifications.tasks.broadcast_notification[46308ccd-22ca-485d-bc36-57c91f737ac6] raised unexpected: KeyError('identity')
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/celery/app/trace.py", line 453, in trace_task
    R = retval = fun(*args, **kwargs)
                 ~~~^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/tasks.py", line 21, in broadcast_notification
    current_notifications_manager.handle_broadcast(Notification(**notification))
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/manager.py", line 45, in handle_broadcast
    builder.resolve_context(notification)
    ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/builders.py", line 43, in resolve_context
    ctx_func(notification)
    ~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/generators.py", line 80, in __call__
    entity = EntityResolverRegistry.resolve_entity(entity_ref)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/registry.py", line 57, in resolve_entity
    return proxy.resolve()
           ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/base.py", line 86, in resolve
    self._entity = self._resolve()
                   ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/results.py", line 28, in _resolve
    return self.service.read(system_identity, id_).to_dict()
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py", line 101, in to_dict
    res = self.data
          ^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py", line 76, in data
    self._data = self._schema.dump(
                 ~~~~~~~~~~~~~~~~~^
        self._obj,
        ^^^^^^^^^^
    ...<3 lines>
        },
        ^^
    )
    ^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py", line 118, in dump
    return self.schema(**schema_args).dump(data)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 656, in _serialize
    return schema.dump(nested_obj, many=many)
           ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 2026, in _serialize
    return self._serialize_method(obj)
           ~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/schemas.py", line 50, in get_permissions
    self.context["identity"],
    ~~~~~~~~~~~~^^^^^^^^^^^^
KeyError: 'identity'
__________ ERROR at setup of test_update_declined_invitation[expire] ___________
requests_service = <invenio_requests.services.requests.service.RequestsService object at 0x7fb4ce1e2830>
invite_user = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c697cec0>
    @pytest.fixture(scope="function")
    def invite_request_id(requests_service, invite_user):
        """An invitation request."""
        Request.index.refresh()
        res = requests_service.search(
            invite_user.identity,
            receiver={"user": invite_user.id},
            type="community-invitation",
>       ).to_dict()
          ^^^^^^^^^
tests/members/conftest.py:94: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py:187: in to_dict
    hits = list(self.hits)
           ^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py:167: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:656: in _serialize
    return schema.dump(nested_obj, many=many)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <RequestEventSchema(many=False)>
obj = {'$schema': 'local://requestevents/requestevent-v1.0.0.json', 'payload': {'format': 'html', 'content': 'Welcome to the club!'}, 'created_by': {'user': '1'}, 'request_id': '06952603-0b18-4148-8e60-135d20164fd2'}
    def get_permissions(self, obj):
        """Return permissions to act on comments or empty dict."""
        is_comment = obj.type == CommentEventType
        if is_comment:
            service = current_requests.request_events_service
            return {
                "can_update_comment": service.check_permission(
>                   self.context["identity"],
                    ^^^^^^^^^^^^^^^^^^^^^^^^
                    "update_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
                "can_delete_comment": service.check_permission(
                    self.context["identity"],
                    "delete_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
            }
E           KeyError: 'identity'
venv/lib/python3.14/site-packages/invenio_requests/services/schemas.py:50: KeyError
------------------------------ Captured log setup ------------------------------
ERROR    celery.app.trace:trace.py:267 Task invenio_notifications.tasks.broadcast_notification[7871b3c1-6176-4d89-84f2-61b3ded0e6f9] raised unexpected: KeyError('identity')
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/celery/app/trace.py", line 453, in trace_task
    R = retval = fun(*args, **kwargs)
                 ~~~^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/tasks.py", line 21, in broadcast_notification
    current_notifications_manager.handle_broadcast(Notification(**notification))
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/manager.py", line 45, in handle_broadcast
    builder.resolve_context(notification)
    ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/builders.py", line 43, in resolve_context
    ctx_func(notification)
    ~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/generators.py", line 80, in __call__
    entity = EntityResolverRegistry.resolve_entity(entity_ref)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/registry.py", line 57, in resolve_entity
    return proxy.resolve()
           ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/base.py", line 86, in resolve
    self._entity = self._resolve()
                   ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/results.py", line 28, in _resolve
    return self.service.read(system_identity, id_).to_dict()
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py", line 101, in to_dict
    res = self.data
          ^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py", line 76, in data
    self._data = self._schema.dump(
                 ~~~~~~~~~~~~~~~~~^
        self._obj,
        ^^^^^^^^^^
    ...<3 lines>
        },
        ^^
    )
    ^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py", line 118, in dump
    return self.schema(**schema_args).dump(data)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 656, in _serialize
    return schema.dump(nested_obj, many=many)
           ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 2026, in _serialize
    return self._serialize_method(obj)
           ~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/schemas.py", line 50, in get_permissions
    self.context["identity"],
    ~~~~~~~~~~~~^^^^^^^^^^^^
KeyError: 'identity'
=================================== FAILURES ===================================
________________ test_community_invitation_submit_notification _________________
member_service = <invenio_communities.members.services.service.MemberService object at 0x7fb4c6973350>
requests_service = <invenio_requests.services.requests.service.RequestsService object at 0x7fb4c68ae510>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fb4c6599a90>
owner = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c66deba0>
new_user = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c651a360>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7fb4c650a3c0>
app = <Flask 'invenio'>, clean_index = True
    def test_community_invitation_submit_notification(
        member_service,
        requests_service,
        community,
        owner,
        new_user,
        db,
        monkeypatch,
        app,
        clean_index,
    ):
        """Test notifcation being built on community invitation submit."""
        original_builder = CommunityInvitationSubmittedNotificationBuilder
        # mock build to observe calls
        mock_build = MagicMock()
        mock_build.side_effect = original_builder.build
        monkeypatch.setattr(original_builder, "build", mock_build)
        # setting specific builder for test case
        monkeypatch.setattr(
            current_notifications_manager,
            "builders",
            {
                **current_notifications_manager.builders,
                original_builder.type: original_builder,
            },
        )
        assert not mock_build.called
        mail = app.extensions.get("mail")
        assert mail
        with mail.record_messages() as outbox:
            # Validate that email was sent
            role = "reader"
            message = "<p>invitation message</p>"
            data = {
                "members": [{"type": "user", "id": str(new_user.id)}],
                "role": role,
                "message": message,
            }
            member_service.invite(owner.identity, community.id, data)
            # ensure that the invited user request has been indexed
>           res = member_service.search_invitations(owner.identity, community.id).to_dict()
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/members/test_members_notifications.py:71: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:237: in to_dict
    hits = list(self.hits)
           ^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:206: in hits
    projection = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
invenio_communities/members/services/schemas.py:116: in get_member
    return self.get_user_member(obj["user"])
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <InvitationDumpSchema(many=False)>
user = {'@v': '5::0', 'active': True, 'confirmed': True, 'email': 'newuser@newuser.org', ...}
    def get_user_member(self, user):
        """Get a user member."""
        profile = user.get("profile", {})
        name = profile.get("full_name") or user.get("username") or _("Untitled")
        description = profile.get("affiliations") or ""
        fake_user_obj = SimpleNamespace(id=user["id"])
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_communities/members/services/schemas.py:126: KeyError
---------------------------- Captured stderr setup -----------------------------
Flask-DebugToolbar extension not installed
[2026-02-17 10:05:32,823] DEBUG in ext: Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
------------------------------ Captured log setup ------------------------------
DEBUG    invenio:ext.py:99 Flask-DebugToolbar extension not installed
------------------------------ Captured log call -------------------------------
ERROR    celery.app.trace:trace.py:267 Task invenio_notifications.tasks.broadcast_notification[48138d41-fc50-4b8a-873f-c137256c1b87] raised unexpected: KeyError('identity')
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/celery/app/trace.py", line 453, in trace_task
    R = retval = fun(*args, **kwargs)
                 ~~~^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/tasks.py", line 21, in broadcast_notification
    current_notifications_manager.handle_broadcast(Notification(**notification))
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/manager.py", line 45, in handle_broadcast
    builder.resolve_context(notification)
    ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/builders.py", line 43, in resolve_context
    ctx_func(notification)
    ~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/generators.py", line 80, in __call__
    entity = EntityResolverRegistry.resolve_entity(entity_ref)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/registry.py", line 57, in resolve_entity
    return proxy.resolve()
           ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/base.py", line 86, in resolve
    self._entity = self._resolve()
                   ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/results.py", line 28, in _resolve
    return self.service.read(system_identity, id_).to_dict()
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py", line 101, in to_dict
    res = self.data
          ^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py", line 76, in data
    self._data = self._schema.dump(
                 ~~~~~~~~~~~~~~~~~^
        self._obj,
        ^^^^^^^^^^
    ...<3 lines>
        },
        ^^
    )
    ^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py", line 118, in dump
    return self.schema(**schema_args).dump(data)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 656, in _serialize
    return schema.dump(nested_obj, many=many)
           ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 2026, in _serialize
    return self._serialize_method(obj)
           ~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/schemas.py", line 50, in get_permissions
    self.context["identity"],
    ~~~~~~~~~~~~^^^^^^^^^^^^
KeyError: 'identity'
________________ test_community_invitation_accept_notification _________________
member_service = <invenio_communities.members.services.service.MemberService object at 0x7fb4c6973350>
requests_service = <invenio_requests.services.requests.service.RequestsService object at 0x7fb4c68ae510>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fb4c6599a90>
new_user = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c651a360>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7fb4c64bd9b0>
app = <Flask 'invenio'>
members = {'curator': <pytest_invenio.user.UserFixtureBase object at 0x7fb4c6aa7d80>, 'manager': <pytest_invenio.user.UserFixtur...er.UserFixtureBase object at 0x7fb4c66deba0>, 'reader': <pytest_invenio.user.UserFixtureBase object at 0x7fb4c66df5f0>}
clean_index = True
    def test_community_invitation_accept_notification(
        member_service,
        requests_service,
        community,
        new_user,
        db,
        monkeypatch,
        app,
        members,
        clean_index,
    ):
        """Test notifcation sent on community invitation accept."""
        original_builder = CommunityInvitationAcceptNotificationBuilder
        owner = members["owner"]
        # mock build to observe calls
        mock_build = MagicMock()
        mock_build.side_effect = original_builder.build
        monkeypatch.setattr(original_builder, "build", mock_build)
        assert not mock_build.called
        mail = app.extensions.get("mail")
        assert mail
        role = "reader"
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": role,
        }
        member_service.invite(owner.identity, community.id, data)
>       res = member_service.search_invitations(owner.identity, community.id).to_dict()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/members/test_members_notifications.py:146: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:237: in to_dict
    hits = list(self.hits)
           ^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:206: in hits
    projection = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
invenio_communities/members/services/schemas.py:116: in get_member
    return self.get_user_member(obj["user"])
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <InvitationDumpSchema(many=False)>
user = {'@v': '5::0', 'active': True, 'confirmed': True, 'email': 'newuser@newuser.org', ...}
    def get_user_member(self, user):
        """Get a user member."""
        profile = user.get("profile", {})
        name = profile.get("full_name") or user.get("username") or _("Untitled")
        description = profile.get("affiliations") or ""
        fake_user_obj = SimpleNamespace(id=user["id"])
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_communities/members/services/schemas.py:126: KeyError
------------------------------ Captured log call -------------------------------
ERROR    celery.app.trace:trace.py:267 Task invenio_notifications.tasks.broadcast_notification[19377a82-c61c-49c5-b17b-089b1f602127] raised unexpected: KeyError('identity')
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/celery/app/trace.py", line 453, in trace_task
    R = retval = fun(*args, **kwargs)
                 ~~~^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/tasks.py", line 21, in broadcast_notification
    current_notifications_manager.handle_broadcast(Notification(**notification))
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/manager.py", line 45, in handle_broadcast
    builder.resolve_context(notification)
    ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/builders.py", line 43, in resolve_context
    ctx_func(notification)
    ~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/generators.py", line 80, in __call__
    entity = EntityResolverRegistry.resolve_entity(entity_ref)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/registry.py", line 57, in resolve_entity
    return proxy.resolve()
           ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/base.py", line 86, in resolve
    self._entity = self._resolve()
                   ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/results.py", line 28, in _resolve
    return self.service.read(system_identity, id_).to_dict()
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_users_resources/services/users/results.py", line 81, in to_dict
    res = self.data
          ^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_users_resources/services/users/results.py", line 61, in data
    self._data = self._schema.dump(
                 ~~~~~~~~~~~~~~~~~^
        self._obj,
        ^^^^^^^^^^
    ...<3 lines>
        },
        ^^
    )
    ^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py", line 118, in dump
    return self.schema(**schema_args).dump(data)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 2026, in _serialize
    return self._serialize_method(obj)
           ~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_users_resources/services/schemas.py", line 130, in is_self
    current_identity = self.context["identity"]
                       ~~~~~~~~~~~~^^^^^^^^^^^^
KeyError: 'identity'
________________ test_community_invitation_cancel_notification _________________
member_service = <invenio_communities.members.services.service.MemberService object at 0x7fb4c6973350>
requests_service = <invenio_requests.services.requests.service.RequestsService object at 0x7fb4c68ae510>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fb4c6599a90>
owner = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c66deba0>
new_user = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c651a360>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7fb4c62b4050>
app = <Flask 'invenio'>, clean_index = True
    def test_community_invitation_cancel_notification(
        member_service,
        requests_service,
        community,
        owner,
        new_user,
        db,
        monkeypatch,
        app,
        clean_index,
    ):
        """Test notifcation sent on community invitation cancel."""
        original_builder = CommunityInvitationCancelNotificationBuilder
        # mock build to observe calls
        mock_build = MagicMock()
        mock_build.side_effect = original_builder.build
        monkeypatch.setattr(original_builder, "build", mock_build)
        assert not mock_build.called
        mail = app.extensions.get("mail")
        assert mail
        role = "reader"
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": role,
        }
        member_service.invite(owner.identity, community.id, data)
>       res = member_service.search_invitations(owner.identity, community.id).to_dict()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/members/test_members_notifications.py:203: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:237: in to_dict
    hits = list(self.hits)
           ^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:206: in hits
    projection = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
invenio_communities/members/services/schemas.py:116: in get_member
    return self.get_user_member(obj["user"])
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <InvitationDumpSchema(many=False)>
user = {'@v': '5::0', 'active': True, 'confirmed': True, 'email': 'newuser@newuser.org', ...}
    def get_user_member(self, user):
        """Get a user member."""
        profile = user.get("profile", {})
        name = profile.get("full_name") or user.get("username") or _("Untitled")
        description = profile.get("affiliations") or ""
        fake_user_obj = SimpleNamespace(id=user["id"])
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_communities/members/services/schemas.py:126: KeyError
------------------------------ Captured log call -------------------------------
ERROR    celery.app.trace:trace.py:267 Task invenio_notifications.tasks.broadcast_notification[3e495328-4070-4408-96cf-f26d79ed7da1] raised unexpected: KeyError('identity')
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/celery/app/trace.py", line 453, in trace_task
    R = retval = fun(*args, **kwargs)
                 ~~~^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/tasks.py", line 21, in broadcast_notification
    current_notifications_manager.handle_broadcast(Notification(**notification))
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/manager.py", line 45, in handle_broadcast
    builder.resolve_context(notification)
    ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/builders.py", line 43, in resolve_context
    ctx_func(notification)
    ~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/generators.py", line 80, in __call__
    entity = EntityResolverRegistry.resolve_entity(entity_ref)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/registry.py", line 57, in resolve_entity
    return proxy.resolve()
           ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/base.py", line 86, in resolve
    self._entity = self._resolve()
                   ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/results.py", line 28, in _resolve
    return self.service.read(system_identity, id_).to_dict()
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_users_resources/services/users/results.py", line 81, in to_dict
    res = self.data
          ^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_users_resources/services/users/results.py", line 61, in data
    self._data = self._schema.dump(
                 ~~~~~~~~~~~~~~~~~^
        self._obj,
        ^^^^^^^^^^
    ...<3 lines>
        },
        ^^
    )
    ^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py", line 118, in dump
    return self.schema(**schema_args).dump(data)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 2026, in _serialize
    return self._serialize_method(obj)
           ~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_users_resources/services/schemas.py", line 130, in is_self
    current_identity = self.context["identity"]
                       ~~~~~~~~~~~~^^^^^^^^^^^^
KeyError: 'identity'
________________ test_community_invitation_decline_notification ________________
member_service = <invenio_communities.members.services.service.MemberService object at 0x7fb4c6973350>
requests_service = <invenio_requests.services.requests.service.RequestsService object at 0x7fb4c68ae510>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fb4c6599a90>
new_user = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c651a360>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7fb4c62b5080>
app = <Flask 'invenio'>
members = {'curator': <pytest_invenio.user.UserFixtureBase object at 0x7fb4c6aa7d80>, 'manager': <pytest_invenio.user.UserFixtur...er.UserFixtureBase object at 0x7fb4c66deba0>, 'reader': <pytest_invenio.user.UserFixtureBase object at 0x7fb4c66df5f0>}
clean_index = True
    def test_community_invitation_decline_notification(
        member_service,
        requests_service,
        community,
        new_user,
        db,
        monkeypatch,
        app,
        members,
        clean_index,
    ):
        """Test notifcation sent on community invitation decline."""
        owner = members["owner"]
        original_builder = CommunityInvitationDeclineNotificationBuilder
        # mock build to observe calls
        mock_build = MagicMock()
        mock_build.side_effect = original_builder.build
        monkeypatch.setattr(original_builder, "build", mock_build)
        assert not mock_build.called
        mail = app.extensions.get("mail")
        assert mail
        role = "reader"
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": role,
        }
        member_service.invite(owner.identity, community.id, data)
>       res = member_service.search_invitations(owner.identity, community.id).to_dict()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/members/test_members_notifications.py:258: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:237: in to_dict
    hits = list(self.hits)
           ^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:206: in hits
    projection = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
invenio_communities/members/services/schemas.py:116: in get_member
    return self.get_user_member(obj["user"])
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <InvitationDumpSchema(many=False)>
user = {'@v': '5::0', 'active': True, 'confirmed': True, 'email': 'newuser@newuser.org', ...}
    def get_user_member(self, user):
        """Get a user member."""
        profile = user.get("profile", {})
        name = profile.get("full_name") or user.get("username") or _("Untitled")
        description = profile.get("affiliations") or ""
        fake_user_obj = SimpleNamespace(id=user["id"])
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_communities/members/services/schemas.py:126: KeyError
------------------------------ Captured log call -------------------------------
ERROR    celery.app.trace:trace.py:267 Task invenio_notifications.tasks.broadcast_notification[8eccdfd7-dfa1-4e67-8684-34fb70c54c5a] raised unexpected: KeyError('identity')
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/celery/app/trace.py", line 453, in trace_task
    R = retval = fun(*args, **kwargs)
                 ~~~^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/tasks.py", line 21, in broadcast_notification
    current_notifications_manager.handle_broadcast(Notification(**notification))
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/manager.py", line 45, in handle_broadcast
    builder.resolve_context(notification)
    ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/builders.py", line 43, in resolve_context
    ctx_func(notification)
    ~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/generators.py", line 80, in __call__
    entity = EntityResolverRegistry.resolve_entity(entity_ref)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/registry.py", line 57, in resolve_entity
    return proxy.resolve()
           ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/base.py", line 86, in resolve
    self._entity = self._resolve()
                   ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/results.py", line 28, in _resolve
    return self.service.read(system_identity, id_).to_dict()
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_users_resources/services/users/results.py", line 81, in to_dict
    res = self.data
          ^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_users_resources/services/users/results.py", line 61, in data
    self._data = self._schema.dump(
                 ~~~~~~~~~~~~~~~~~^
        self._obj,
        ^^^^^^^^^^
    ...<3 lines>
        },
        ^^
    )
    ^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py", line 118, in dump
    return self.schema(**schema_args).dump(data)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 2026, in _serialize
    return self._serialize_method(obj)
           ~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_users_resources/services/schemas.py", line 130, in is_self
    current_identity = self.context["identity"]
                       ~~~~~~~~~~~~^^^^^^^^^^^^
KeyError: 'identity'
________________ test_community_invitation_expire_notification _________________
member_service = <invenio_communities.members.services.service.MemberService object at 0x7fb4c6973350>
requests_service = <invenio_requests.services.requests.service.RequestsService object at 0x7fb4c68ae510>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fb4c6599a90>
new_user = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c651a360>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7fb4c5ee22e0>
app = <Flask 'invenio'>
members = {'curator': <pytest_invenio.user.UserFixtureBase object at 0x7fb4c6aa7d80>, 'manager': <pytest_invenio.user.UserFixtur...er.UserFixtureBase object at 0x7fb4c66deba0>, 'reader': <pytest_invenio.user.UserFixtureBase object at 0x7fb4c66df5f0>}
clean_index = True
    def test_community_invitation_expire_notification(
        member_service,
        requests_service,
        community,
        new_user,
        db,
        monkeypatch,
        app,
        members,
        clean_index,
    ):
        """Test notifcation sent on community invitation decline."""
        owner = members["owner"]
        original_builder = CommunityInvitationExpireNotificationBuilder
        # mock build to observe calls
        mock_build = MagicMock()
        mock_build.side_effect = original_builder.build
        monkeypatch.setattr(original_builder, "build", mock_build)
        assert not mock_build.called
        mail = app.extensions.get("mail")
        assert mail
        role = "reader"
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": role,
        }
        member_service.invite(owner.identity, community.id, data)
>       res = member_service.search_invitations(owner.identity, community.id).to_dict()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/members/test_members_notifications.py:316: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:237: in to_dict
    hits = list(self.hits)
           ^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:206: in hits
    projection = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
invenio_communities/members/services/schemas.py:116: in get_member
    return self.get_user_member(obj["user"])
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <InvitationDumpSchema(many=False)>
user = {'@v': '5::0', 'active': True, 'confirmed': True, 'email': 'newuser@newuser.org', ...}
    def get_user_member(self, user):
        """Get a user member."""
        profile = user.get("profile", {})
        name = profile.get("full_name") or user.get("username") or _("Untitled")
        description = profile.get("affiliations") or ""
        fake_user_obj = SimpleNamespace(id=user["id"])
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_communities/members/services/schemas.py:126: KeyError
------------------------------ Captured log call -------------------------------
ERROR    celery.app.trace:trace.py:267 Task invenio_notifications.tasks.broadcast_notification[eb5a5588-c822-482b-b802-f73e751b0849] raised unexpected: KeyError('identity')
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/celery/app/trace.py", line 453, in trace_task
    R = retval = fun(*args, **kwargs)
                 ~~~^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/tasks.py", line 21, in broadcast_notification
    current_notifications_manager.handle_broadcast(Notification(**notification))
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/manager.py", line 45, in handle_broadcast
    builder.resolve_context(notification)
    ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/builders.py", line 43, in resolve_context
    ctx_func(notification)
    ~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/generators.py", line 80, in __call__
    entity = EntityResolverRegistry.resolve_entity(entity_ref)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/registry.py", line 57, in resolve_entity
    return proxy.resolve()
           ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/base.py", line 86, in resolve
    self._entity = self._resolve()
                   ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/results.py", line 28, in _resolve
    return self.service.read(system_identity, id_).to_dict()
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_users_resources/services/users/results.py", line 81, in to_dict
    res = self.data
          ^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_users_resources/services/users/results.py", line 61, in data
    self._data = self._schema.dump(
                 ~~~~~~~~~~~~~~~~~^
        self._obj,
        ^^^^^^^^^^
    ...<3 lines>
        },
        ^^
    )
    ^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py", line 118, in dump
    return self.schema(**schema_args).dump(data)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 2026, in _serialize
    return self._serialize_method(obj)
           ~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_users_resources/services/schemas.py", line 130, in is_self
    current_identity = self.context["identity"]
                       ~~~~~~~~~~~~^^^^^^^^^^^^
KeyError: 'identity'
_________________________________ test_invite __________________________________
client = <FlaskClient <Flask 'invenio'>>
headers = {'accept': 'application/json', 'content-type': 'application/json'}
community_id = UUID('487919a0-3cf9-40df-8ebb-b7fc78ac03ee')
owner = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c5aaf6a0>
new_user_data = {'members': [{'id': '5', 'type': 'user'}], 'message': 'Welcome to the club!', 'role': 'reader'}
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>
    def test_invite(client, headers, community_id, owner, new_user_data, db):
        """Test invite REST API."""
        client = owner.login(client)
        r = client.post(
            f"/communities/{community_id}/invitations",
            headers=headers,
            json=new_user_data,
        )
        assert r.status_code == 204
        RequestEvent.index.refresh()
>       r = client.get(f"/communities/{community_id}/invitations", headers=headers)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/members/test_members_resource.py:108: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/werkzeug/test.py:1162: in get
    return self.open(*args, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/testing.py:235: in open
    response = super().open(
venv/lib/python3.14/site-packages/werkzeug/test.py:1116: in open
    response_parts = self.run_wsgi_app(request.environ, buffered=buffered)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:988: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:1264: in run_wsgi_app
    app_rv = app(environ, start_response)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1536: in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1514: in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1511: in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:919: in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:917: in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:902: in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/resources.py:65: in view
    return view_meth()
           ^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/content_negotiation.py:116: in inner_content_negotiation
    return f(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:51: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:51: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/responses.py:39: in inner
    res = f(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^
invenio_communities/members/resources/resource.py:78: in search_invitations
    return hits.to_dict(), 200
           ^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:237: in to_dict
    hits = list(self.hits)
           ^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:206: in hits
    projection = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
invenio_communities/members/services/schemas.py:116: in get_member
    return self.get_user_member(obj["user"])
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <InvitationDumpSchema(many=False)>
user = {'@v': '5::1', 'active': True, 'confirmed': True, 'email': 'newuser@newuser.org', ...}
    def get_user_member(self, user):
        """Get a user member."""
        profile = user.get("profile", {})
        name = profile.get("full_name") or user.get("username") or _("Untitled")
        description = profile.get("affiliations") or ""
        fake_user_obj = SimpleNamespace(id=user["id"])
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_communities/members/services/schemas.py:126: KeyError
------------------------------ Captured log call -------------------------------
ERROR    celery.app.trace:trace.py:267 Task invenio_notifications.tasks.broadcast_notification[f9e39f53-2656-4043-b33c-a87f844b42c4] raised unexpected: KeyError('identity')
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/celery/app/trace.py", line 453, in trace_task
    R = retval = fun(*args, **kwargs)
                 ~~~^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/tasks.py", line 21, in broadcast_notification
    current_notifications_manager.handle_broadcast(Notification(**notification))
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/manager.py", line 45, in handle_broadcast
    builder.resolve_context(notification)
    ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/builders.py", line 43, in resolve_context
    ctx_func(notification)
    ~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/generators.py", line 80, in __call__
    entity = EntityResolverRegistry.resolve_entity(entity_ref)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/registry.py", line 57, in resolve_entity
    return proxy.resolve()
           ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/base.py", line 86, in resolve
    self._entity = self._resolve()
                   ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/results.py", line 28, in _resolve
    return self.service.read(system_identity, id_).to_dict()
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py", line 101, in to_dict
    res = self.data
          ^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py", line 76, in data
    self._data = self._schema.dump(
                 ~~~~~~~~~~~~~~~~~^
        self._obj,
        ^^^^^^^^^^
    ...<3 lines>
        },
        ^^
    )
    ^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py", line 118, in dump
    return self.schema(**schema_args).dump(data)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 656, in _serialize
    return schema.dump(nested_obj, many=many)
           ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 2026, in _serialize
    return self._serialize_method(obj)
           ~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/schemas.py", line 50, in get_permissions
    self.context["identity"],
    ~~~~~~~~~~~~^^^^^^^^^^^^
KeyError: 'identity'
_________________________________ test_search __________________________________
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>
clean_index = True, client = <FlaskClient <Flask 'invenio'>>
headers = {'accept': 'application/json', 'content-type': 'application/json'}
extra_user = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c59d3cd0>
community_id = UUID('487919a0-3cf9-40df-8ebb-b7fc78ac03ee')
owner = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c5aaf6a0>
public_reader = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c5b66a40>
    def test_search(
        db,
        clean_index,
        client,
        headers,
        extra_user,
        community_id,
        owner,
        public_reader,
    ):
        """Search."""
        client = owner.login(client)
>       r = client.get(
            f"/communities/{community_id}/members",
            headers=headers,
        )
tests/members/test_members_resource.py:233: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/werkzeug/test.py:1162: in get
    return self.open(*args, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/testing.py:235: in open
    response = super().open(
venv/lib/python3.14/site-packages/werkzeug/test.py:1116: in open
    response_parts = self.run_wsgi_app(request.environ, buffered=buffered)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:988: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:1264: in run_wsgi_app
    app_rv = app(environ, start_response)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1536: in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1514: in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1511: in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:919: in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:917: in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:902: in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/resources.py:65: in view
    return view_meth()
           ^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/content_negotiation.py:116: in inner_content_negotiation
    return f(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:51: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:51: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/responses.py:39: in inner
    res = f(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^
invenio_communities/members/resources/resource.py:52: in search
    return hits.to_dict(), 200
           ^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:237: in to_dict
    hits = list(self.hits)
           ^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:206: in hits
    projection = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
invenio_communities/members/services/schemas.py:116: in get_member
    return self.get_user_member(obj["user"])
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <MemberDumpSchema(many=False)>
user = {'@v': '5::1', 'active': True, 'confirmed': True, 'email': 'newuser@newuser.org', ...}
    def get_user_member(self, user):
        """Get a user member."""
        profile = user.get("profile", {})
        name = profile.get("full_name") or user.get("username") or _("Untitled")
        description = profile.get("affiliations") or ""
        fake_user_obj = SimpleNamespace(id=user["id"])
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_communities/members/services/schemas.py:126: KeyError
______________________________ test_search_public ______________________________
client = <FlaskClient <Flask 'invenio'>>
headers = {'accept': 'application/json', 'content-type': 'application/json'}
community_id = UUID('487919a0-3cf9-40df-8ebb-b7fc78ac03ee')
new_user = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c5b66a40>
public_reader = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c5b66a40>
clean_index = True
    def test_search_public(
        client, headers, community_id, new_user, public_reader, clean_index
    ):
        """Search public members."""
        client = new_user.login(client)
>       r = client.get(
            f"/communities/{community_id}/members/public",
            headers=headers,
        )
tests/members/test_members_resource.py:295: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/werkzeug/test.py:1162: in get
    return self.open(*args, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/testing.py:235: in open
    response = super().open(
venv/lib/python3.14/site-packages/werkzeug/test.py:1116: in open
    response_parts = self.run_wsgi_app(request.environ, buffered=buffered)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:988: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:1264: in run_wsgi_app
    app_rv = app(environ, start_response)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1536: in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1514: in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1511: in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:919: in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:917: in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:902: in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/resources.py:65: in view
    return view_meth()
           ^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/content_negotiation.py:116: in inner_content_negotiation
    return f(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:51: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:51: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/responses.py:39: in inner
    res = f(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^
invenio_communities/members/resources/resource.py:65: in search_public
    return hits.to_dict(), 200
           ^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:237: in to_dict
    hits = list(self.hits)
           ^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:206: in hits
    projection = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
invenio_communities/members/services/schemas.py:116: in get_member
    return self.get_user_member(obj["user"])
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <PublicDumpSchema(many=False)>
user = {'@v': '5::1', 'active': True, 'confirmed': True, 'email': 'newuser@newuser.org', ...}
    def get_user_member(self, user):
        """Get a user member."""
        profile = user.get("profile", {})
        name = profile.get("full_name") or user.get("username") or _("Untitled")
        description = profile.get("affiliations") or ""
        fake_user_obj = SimpleNamespace(id=user["id"])
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_communities/members/services/schemas.py:126: KeyError
____________________________ test_search_invitation ____________________________
client = <FlaskClient <Flask 'invenio'>>
headers = {'accept': 'application/json', 'content-type': 'application/json'}
community_id = UUID('487919a0-3cf9-40df-8ebb-b7fc78ac03ee')
owner = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c5aaf6a0>
invite_user = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c5b66a40>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>
clean_index = True
    def test_search_invitation(
        client, headers, community_id, owner, invite_user, db, clean_index
    ):
        """Search invitations."""
        client = owner.login(client)
>       r = client.get(
            f"/communities/{community_id}/invitations",
            headers=headers,
        )
tests/members/test_members_resource.py:328: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/werkzeug/test.py:1162: in get
    return self.open(*args, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/testing.py:235: in open
    response = super().open(
venv/lib/python3.14/site-packages/werkzeug/test.py:1116: in open
    response_parts = self.run_wsgi_app(request.environ, buffered=buffered)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:988: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:1264: in run_wsgi_app
    app_rv = app(environ, start_response)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1536: in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1514: in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1511: in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:919: in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:917: in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:902: in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/resources.py:65: in view
    return view_meth()
           ^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/content_negotiation.py:116: in inner_content_negotiation
    return f(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:51: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:51: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/responses.py:39: in inner
    res = f(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^
invenio_communities/members/resources/resource.py:78: in search_invitations
    return hits.to_dict(), 200
           ^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:237: in to_dict
    hits = list(self.hits)
           ^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:206: in hits
    projection = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
invenio_communities/members/services/schemas.py:116: in get_member
    return self.get_user_member(obj["user"])
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <InvitationDumpSchema(many=False)>
user = {'@v': '5::1', 'active': True, 'confirmed': True, 'email': 'newuser@newuser.org', ...}
    def get_user_member(self, user):
        """Get a user member."""
        profile = user.get("profile", {})
        name = profile.get("full_name") or user.get("username") or _("Untitled")
        description = profile.get("affiliations") or ""
        fake_user_obj = SimpleNamespace(id=user["id"])
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_communities/members/services/schemas.py:126: KeyError
------------------------------ Captured log setup ------------------------------
ERROR    celery.app.trace:trace.py:267 Task invenio_notifications.tasks.broadcast_notification[9c6faf59-7d52-4e14-a36e-94577e8eca09] raised unexpected: KeyError('identity')
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/celery/app/trace.py", line 453, in trace_task
    R = retval = fun(*args, **kwargs)
                 ~~~^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/tasks.py", line 21, in broadcast_notification
    current_notifications_manager.handle_broadcast(Notification(**notification))
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/manager.py", line 45, in handle_broadcast
    builder.resolve_context(notification)
    ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/builders.py", line 43, in resolve_context
    ctx_func(notification)
    ~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/generators.py", line 80, in __call__
    entity = EntityResolverRegistry.resolve_entity(entity_ref)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/registry.py", line 57, in resolve_entity
    return proxy.resolve()
           ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/base.py", line 86, in resolve
    self._entity = self._resolve()
                   ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/results.py", line 28, in _resolve
    return self.service.read(system_identity, id_).to_dict()
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py", line 101, in to_dict
    res = self.data
          ^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py", line 76, in data
    self._data = self._schema.dump(
                 ~~~~~~~~~~~~~~~~~^
        self._obj,
        ^^^^^^^^^^
    ...<3 lines>
        },
        ^^
    )
    ^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py", line 118, in dump
    return self.schema(**schema_args).dump(data)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 656, in _serialize
    return schema.dump(nested_obj, many=many)
           ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 2026, in _serialize
    return self._serialize_method(obj)
           ~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/schemas.py", line 50, in get_permissions
    self.context["identity"],
    ~~~~~~~~~~~~^^^^^^^^^^^^
KeyError: 'identity'
________________________ test_post_membership_requests _________________________
app = <Flask 'invenio'>, client = <FlaskClient <Flask 'invenio'>>
headers = {'accept': 'application/json', 'content-type': 'application/json'}
community_id = UUID('487919a0-3cf9-40df-8ebb-b7fc78ac03ee')
create_user = <function create_user.<locals>._create_user at 0x7fb4c7265e80>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>
    def test_post_membership_requests(app, client, headers, community_id, create_user, db):
        user = create_user({"email": "user_foo@example.org", "username": "user_foo"})
        client = user.login(client)
        # Post membership request
>       r = client.post(
            f"/communities/{community_id}/membership-requests",
            headers=headers,
            json={"message": "Can I join the club?"},
        )
tests/members/test_members_resource.py:372: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/werkzeug/test.py:1167: in post
    return self.open(*args, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/testing.py:235: in open
    response = super().open(
venv/lib/python3.14/site-packages/werkzeug/test.py:1116: in open
    response_parts = self.run_wsgi_app(request.environ, buffered=buffered)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:988: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:1264: in run_wsgi_app
    app_rv = app(environ, start_response)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1536: in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1514: in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1511: in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:919: in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:917: in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:902: in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/resources.py:65: in view
    return view_meth()
           ^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/content_negotiation.py:116: in inner_content_negotiation
    return f(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:51: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:90: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
invenio_communities/members/resources/resource.py:111: in request_membership
    return request.to_dict(), 201
           ^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py:101: in to_dict
    res = self.data
          ^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py:76: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:656: in _serialize
    return schema.dump(nested_obj, many=many)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <RequestEventSchema(many=False)>
obj = {'$schema': 'local://requestevents/requestevent-v1.0.0.json', 'payload': {'format': 'html', 'content': 'Can I join the club?'}, 'created_by': {'user': '7'}, 'request_id': '9cdc20bb-3ef8-4563-9244-396c38d26ba0'}
    def get_permissions(self, obj):
        """Return permissions to act on comments or empty dict."""
        is_comment = obj.type == CommentEventType
        if is_comment:
            service = current_requests.request_events_service
            return {
                "can_update_comment": service.check_permission(
>                   self.context["identity"],
                    ^^^^^^^^^^^^^^^^^^^^^^^^
                    "update_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
                "can_delete_comment": service.check_permission(
                    self.context["identity"],
                    "delete_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
            }
E           KeyError: 'identity'
venv/lib/python3.14/site-packages/invenio_requests/services/schemas.py:50: KeyError
----------------------------- Captured stderr call -----------------------------
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
[2026-02-17 10:05:43,266] ERROR in api: Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
------------------------------ Captured log call -------------------------------
ERROR    invenio:api.py:376 Failed to index record 6
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 370, in _actionsiter
    yield self._index_action(payload)
          ~~~~~~~~~~~~~~~~~~^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 416, in _index_action
    index = self.record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_indexer/api.py", line 114, in record_to_index
    result = self._record_to_index(record)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/service.py", line 67, in record_to_index
    return record.index._name
           ^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'index'
_________________________________ test_invite __________________________________
member_service = <invenio_communities.members.services.service.MemberService object at 0x7fb4c8313c20>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fb4c66f16d0>
owner = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c5e4e2b0>
new_user = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c697cec0>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>
    def test_invite(member_service, community, owner, new_user, db):
        """Invite a user."""
        data = {
            "members": [{"type": "user", "id": str(new_user.id)}],
            "role": "reader",
        }
        member_service.invite(owner.identity, community._record.id, data)
        # ensure that the invited user request has been indexed
        res = member_service.search_invitations(
            owner.identity, community._record.id
>       ).to_dict()
          ^^^^^^^^^
tests/members/test_members_services.py:193: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:237: in to_dict
    hits = list(self.hits)
           ^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:206: in hits
    projection = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
invenio_communities/members/services/schemas.py:116: in get_member
    return self.get_user_member(obj["user"])
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <InvitationDumpSchema(many=False)>
user = {'@v': '5::0', 'active': True, 'confirmed': True, 'email': 'newuser@newuser.org', ...}
    def get_user_member(self, user):
        """Get a user member."""
        profile = user.get("profile", {})
        name = profile.get("full_name") or user.get("username") or _("Untitled")
        description = profile.get("affiliations") or ""
        fake_user_obj = SimpleNamespace(id=user["id"])
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_communities/members/services/schemas.py:126: KeyError
------------------------------ Captured log call -------------------------------
ERROR    celery.app.trace:trace.py:267 Task invenio_notifications.tasks.broadcast_notification[b5362e6e-ea2c-4302-8141-31df0ebf3c1f] raised unexpected: KeyError('identity')
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/celery/app/trace.py", line 453, in trace_task
    R = retval = fun(*args, **kwargs)
                 ~~~^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/tasks.py", line 21, in broadcast_notification
    current_notifications_manager.handle_broadcast(Notification(**notification))
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/manager.py", line 45, in handle_broadcast
    builder.resolve_context(notification)
    ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/builders.py", line 43, in resolve_context
    ctx_func(notification)
    ~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/generators.py", line 80, in __call__
    entity = EntityResolverRegistry.resolve_entity(entity_ref)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/registry.py", line 57, in resolve_entity
    return proxy.resolve()
           ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/base.py", line 86, in resolve
    self._entity = self._resolve()
                   ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/results.py", line 28, in _resolve
    return self.service.read(system_identity, id_).to_dict()
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_users_resources/services/users/results.py", line 81, in to_dict
    res = self.data
          ^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_users_resources/services/users/results.py", line 61, in data
    self._data = self._schema.dump(
                 ~~~~~~~~~~~~~~~~~^
        self._obj,
        ^^^^^^^^^^
    ...<3 lines>
        },
        ^^
    )
    ^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py", line 118, in dump
    return self.schema(**schema_args).dump(data)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 2026, in _serialize
    return self._serialize_method(obj)
           ~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_users_resources/services/schemas.py", line 130, in is_self
    current_identity = self.context["identity"]
                       ~~~~~~~~~~~~^^^^^^^^^^^^
KeyError: 'identity'
__________________________ test_invite_already_member __________________________
member_service = <invenio_communities.members.services.service.MemberService object at 0x7fb4c8313c20>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fb4c66f16d0>
owner = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c5e4e2b0>
new_user = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c697cec0>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>
    def test_invite_already_member(member_service, community, owner, new_user, db):
        """Invite a user."""
>       res = member_service.search(owner.identity, community._record.id).to_dict()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/members/test_members_services.py:249: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:237: in to_dict
    hits = list(self.hits)
           ^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:206: in hits
    projection = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
invenio_communities/members/services/schemas.py:116: in get_member
    return self.get_user_member(obj["user"])
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <MemberDumpSchema(many=False)>
user = {'@v': '5::0', 'active': True, 'confirmed': True, 'email': 'newuser@newuser.org', ...}
    def get_user_member(self, user):
        """Get a user member."""
        profile = user.get("profile", {})
        name = profile.get("full_name") or user.get("username") or _("Untitled")
        description = profile.get("affiliations") or ""
        fake_user_obj = SimpleNamespace(id=user["id"])
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_communities/members/services/schemas.py:126: KeyError
___________________________ test_invite_view_request ___________________________
events_service = <invenio_requests.services.events.service.RequestEventsService object at 0x7fb4ce1e3070>
requests_service = <invenio_requests.services.requests.service.RequestsService object at 0x7fb4ce1e2830>
invite_user = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c697cec0>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>
clean_index = True
    def test_invite_view_request(
        events_service, requests_service, invite_user, db, clean_index
    ):
        """A request should have been created."""
        res = requests_service.search(
            invite_user.identity,
            receiver={"user": invite_user.id},
            type="community-invitation",
>       ).to_dict()
          ^^^^^^^^^
tests/members/test_members_services.py:296: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py:187: in to_dict
    hits = list(self.hits)
           ^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py:167: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:656: in _serialize
    return schema.dump(nested_obj, many=many)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <RequestEventSchema(many=False)>
obj = {'$schema': 'local://requestevents/requestevent-v1.0.0.json', 'payload': {'format': 'html', 'content': 'Welcome to the club!'}, 'created_by': {'user': '1'}, 'request_id': '8a661af5-3b8c-4362-854c-49b55d795a0b'}
    def get_permissions(self, obj):
        """Return permissions to act on comments or empty dict."""
        is_comment = obj.type == CommentEventType
        if is_comment:
            service = current_requests.request_events_service
            return {
                "can_update_comment": service.check_permission(
>                   self.context["identity"],
                    ^^^^^^^^^^^^^^^^^^^^^^^^
                    "update_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
                "can_delete_comment": service.check_permission(
                    self.context["identity"],
                    "delete_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
            }
E           KeyError: 'identity'
venv/lib/python3.14/site-packages/invenio_requests/services/schemas.py:50: KeyError
------------------------------ Captured log setup ------------------------------
ERROR    celery.app.trace:trace.py:267 Task invenio_notifications.tasks.broadcast_notification[fff455b4-aa45-4edf-bb0d-52c650d0fea6] raised unexpected: KeyError('identity')
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/celery/app/trace.py", line 453, in trace_task
    R = retval = fun(*args, **kwargs)
                 ~~~^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/tasks.py", line 21, in broadcast_notification
    current_notifications_manager.handle_broadcast(Notification(**notification))
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/manager.py", line 45, in handle_broadcast
    builder.resolve_context(notification)
    ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/builders.py", line 43, in resolve_context
    ctx_func(notification)
    ~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/generators.py", line 80, in __call__
    entity = EntityResolverRegistry.resolve_entity(entity_ref)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/registry.py", line 57, in resolve_entity
    return proxy.resolve()
           ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/base.py", line 86, in resolve
    self._entity = self._resolve()
                   ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/results.py", line 28, in _resolve
    return self.service.read(system_identity, id_).to_dict()
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py", line 101, in to_dict
    res = self.data
          ^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py", line 76, in data
    self._data = self._schema.dump(
                 ~~~~~~~~~~~~~~~~~^
        self._obj,
        ^^^^^^^^^^
    ...<3 lines>
        },
        ^^
    )
    ^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py", line 118, in dump
    return self.schema(**schema_args).dump(data)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 656, in _serialize
    return schema.dump(nested_obj, many=many)
           ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 2026, in _serialize
    return self._serialize_method(obj)
           ~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_requests/services/schemas.py", line 50, in get_permissions
    self.context["identity"],
    ~~~~~~~~~~~~^^^^^^^^^^^^
KeyError: 'identity'
_____________________________ test_search_members ______________________________
member_service = <invenio_communities.members.services.service.MemberService object at 0x7fb4c8313c20>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fb4c66f16d0>
owner = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c5e4e2b0>
public_reader = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c697cec0>
anon_identity = <AnonymousIdentity id="None" auth_type="None" provides={Need(method='system_role', value='any_user')}>
clean_index = True
    def test_search_members(
        member_service, community, owner, public_reader, anon_identity, clean_index
    ):
        """Members can see all members, anyone can only see public."""
        # Members can see all other members
        res = member_service.search(owner.identity, community._record.id)
>       assert res.to_dict()["hits"]["total"] == 2
               ^^^^^^^^^^^^^
tests/members/test_members_services.py:321: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:237: in to_dict
    hits = list(self.hits)
           ^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:206: in hits
    projection = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
invenio_communities/members/services/schemas.py:116: in get_member
    return self.get_user_member(obj["user"])
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <MemberDumpSchema(many=False)>
user = {'@v': '5::0', 'active': True, 'confirmed': True, 'email': 'newuser@newuser.org', ...}
    def get_user_member(self, user):
        """Get a user member."""
        profile = user.get("profile", {})
        name = profile.get("full_name") or user.get("username") or _("Untitled")
        description = profile.get("affiliations") or ""
        fake_user_obj = SimpleNamespace(id=user["id"])
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_communities/members/services/schemas.py:126: KeyError
______________________________ test_scan_members _______________________________
member_service = <invenio_communities.members.services.service.MemberService object at 0x7fb4c8313c20>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fb4c66f16d0>
owner = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c5e4e2b0>
clean_index = True
    def test_scan_members(member_service, community, owner, clean_index):
        """Scan should work the same as search."""
        res_search = member_service.search(owner.identity, community._record.id)
        # scan members (pagination not possible with scan)
        res_scan = member_service.scan(owner.identity, community._record.id)
>       scan_hits = res_scan.to_dict()["hits"]["hits"]
                    ^^^^^^^^^^^^^^^^^^
tests/members/test_members_services.py:344: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:237: in to_dict
    hits = list(self.hits)
           ^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:206: in hits
    projection = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
invenio_communities/members/services/schemas.py:116: in get_member
    return self.get_user_member(obj["user"])
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <MemberDumpSchema(many=False)>
user = {'@v': '1::0', 'active': True, 'confirmed': True, 'email': 'owner@owner.org', ...}
    def get_user_member(self, user):
        """Get a user member."""
        profile = user.get("profile", {})
        name = profile.get("full_name") or user.get("username") or _("Untitled")
        description = profile.get("affiliations") or ""
        fake_user_obj = SimpleNamespace(id=user["id"])
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_communities/members/services/schemas.py:126: KeyError
__________________________ test_search_public_members __________________________
member_service = <invenio_communities.members.services.service.MemberService object at 0x7fb4c8313c20>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fb4c66f16d0>
owner = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c5e4e2b0>
public_reader = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c697cec0>
anon_identity = <AnonymousIdentity id="None" auth_type="None" provides={Need(method='system_role', value='any_user')}>
clean_index = True
    def test_search_public_members(
        member_service, community, owner, public_reader, anon_identity, clean_index
    ):
        """Members can see all members, anyone can only see public."""
        # Anyone else can only see public members
        res = member_service.search_public(anon_identity, community._record.id)
>       assert res.to_dict()["hits"]["total"] == 1
               ^^^^^^^^^^^^^
tests/members/test_members_services.py:356: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:237: in to_dict
    hits = list(self.hits)
           ^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:206: in hits
    projection = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
invenio_communities/members/services/schemas.py:116: in get_member
    return self.get_user_member(obj["user"])
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <PublicDumpSchema(many=False)>
user = {'@v': '5::0', 'active': True, 'confirmed': True, 'email': 'newuser@newuser.org', ...}
    def get_user_member(self, user):
        """Get a user member."""
        profile = user.get("profile", {})
        name = profile.get("full_name") or user.get("username") or _("Untitled")
        description = profile.get("affiliations") or ""
        fake_user_obj = SimpleNamespace(id=user["id"])
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_communities/members/services/schemas.py:126: KeyError
________________________ test_search_members_restricted ________________________
member_service = <invenio_communities.members.services.service.MemberService object at 0x7fb4c8313c20>
restricted_community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fb4c75b6210>
owner = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c5e4e2b0>
anon_identity = <AnonymousIdentity id="None" auth_type="None" provides={Need(method='system_role', value='any_user')}>
clean_index = True
    def test_search_members_restricted(
        member_service, restricted_community, owner, anon_identity, clean_index
    ):
        """Restricted communities can only be searched by members."""
        c = restricted_community
        # Members can see all other members
        res = member_service.search(owner.identity, c._record.id)
>       assert res.to_dict()["hits"]["total"] == 1
               ^^^^^^^^^^^^^
tests/members/test_members_services.py:386: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:237: in to_dict
    hits = list(self.hits)
           ^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:206: in hits
    projection = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
invenio_communities/members/services/schemas.py:116: in get_member
    return self.get_user_member(obj["user"])
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <MemberDumpSchema(many=False)>
user = {'@v': '1::0', 'active': True, 'confirmed': True, 'email': 'owner@owner.org', ...}
    def get_user_member(self, user):
        """Get a user member."""
        profile = user.get("profile", {})
        name = profile.get("full_name") or user.get("username") or _("Untitled")
        description = profile.get("affiliations") or ""
        fake_user_obj = SimpleNamespace(id=user["id"])
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_communities/members/services/schemas.py:126: KeyError
__________________ test_search_members_visibility_restricted ___________________
member_service = <invenio_communities.members.services.service.MemberService object at 0x7fb4c8313c20>
restricted_members_community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fb4c75b76b0>
owner = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c5e4e2b0>
anon_identity = <AnonymousIdentity id="None" auth_type="None" provides={Need(method='system_role', value='any_user')}>
clean_index = True
    def test_search_members_visibility_restricted(
        member_service, restricted_members_community, owner, anon_identity, clean_index
    ):
        """Restricted members communities can only be searched by members."""
        c = restricted_members_community
        # Members can see all other members
        res = member_service.search(owner.identity, c._record.id)
>       assert res.to_dict()["hits"]["total"] == 1
               ^^^^^^^^^^^^^
tests/members/test_members_services.py:402: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:237: in to_dict
    hits = list(self.hits)
           ^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:206: in hits
    projection = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
invenio_communities/members/services/schemas.py:116: in get_member
    return self.get_user_member(obj["user"])
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <MemberDumpSchema(many=False)>
user = {'@v': '1::0', 'active': True, 'confirmed': True, 'email': 'owner@owner.org', ...}
    def get_user_member(self, user):
        """Get a user member."""
        profile = user.get("profile", {})
        name = profile.get("full_name") or user.get("username") or _("Untitled")
        description = profile.get("affiliations") or ""
        fake_user_obj = SimpleNamespace(id=user["id"])
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_communities/members/services/schemas.py:126: KeyError
_______________________ test_request_cancel_request_flow _______________________
member_service = <invenio_communities.members.services.service.MemberService object at 0x7fb4c8313c20>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fb4c66f16d0>
create_user = <function create_user.<locals>._create_user at 0x7fb4c7016c40>
requests_service = <invenio_requests.services.requests.service.RequestsService object at 0x7fb4ce1e2830>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>
search_clear = <OpenSearch([{'host': 'localhost', 'port': 9200}])>
    def test_request_cancel_request_flow(
        member_service,
        community,
        create_user,
        requests_service,
        db,
        search_clear,
    ):
        """Check creation of membership request after first creation closed
        This tests a temporary business rule that should be revisited later
        """
        # Create membership request
        user = create_user()
        data = {
            "message": "Can I join the club?",
        }
        membership_request = member_service.request_membership(
            user.identity,
            community._record.id,
            data,
        )
        # Close request - here via cancel
        request = requests_service.execute_action(
            user.identity, membership_request.id, "cancel"
>       ).to_dict()
          ^^^^^^^^^
tests/members/test_members_services.py:1191: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py:101: in to_dict
    res = self.data
          ^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_requests/services/requests/results.py:76: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:656: in _serialize
    return schema.dump(nested_obj, many=many)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <RequestEventSchema(many=False)>
obj = {'$schema': 'local://requestevents/requestevent-v1.0.0.json', 'payload': {'format': 'html', 'content': 'Can I join the club?'}, 'created_by': {'user': '8'}, 'request_id': 'ae087224-3776-4ca2-8bc6-14264b053a85'}
    def get_permissions(self, obj):
        """Return permissions to act on comments or empty dict."""
        is_comment = obj.type == CommentEventType
        if is_comment:
            service = current_requests.request_events_service
            return {
                "can_update_comment": service.check_permission(
>                   self.context["identity"],
                    ^^^^^^^^^^^^^^^^^^^^^^^^
                    "update_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
                "can_delete_comment": service.check_permission(
                    self.context["identity"],
                    "delete_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
            }
E           KeyError: 'identity'
venv/lib/python3.14/site-packages/invenio_requests/services/schemas.py:50: KeyError
_______________________ test_relation_update_propagation _______________________
app = <Flask 'invenio'>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>
clean_index = True
public_reader = <pytest_invenio.user.UserFixtureBase object at 0x7fb4c697cec0>
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fb4c66f16d0>
member_service = <invenio_communities.members.services.service.MemberService object at 0x7fb4c8313c20>
    def test_relation_update_propagation(
        app, db, clean_index, public_reader, community, member_service
    ):
        comm_uuid = community._record.id
        # there is no .read() implementation
        comm_members = member_service.search_public(system_identity, comm_uuid)
        assert comm_members.total == 1
>       member = list(comm_members.hits)[0]
                 ^^^^^^^^^^^^^^^^^^^^^^^
tests/members/test_members_services.py:1212: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:206: in hits
    projection = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
invenio_communities/members/services/schemas.py:116: in get_member
    return self.get_user_member(obj["user"])
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <PublicDumpSchema(many=False)>
user = {'@v': '5::0', 'active': True, 'confirmed': True, 'email': 'newuser@newuser.org', ...}
    def get_user_member(self, user):
        """Get a user member."""
        profile = user.get("profile", {})
        name = profile.get("full_name") or user.get("username") or _("Untitled")
        description = profile.get("affiliations") or ""
        fake_user_obj = SimpleNamespace(id=user["id"])
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_communities/members/services/schemas.py:126: KeyError
________________________ test_user_recipient_generator _________________________
community = <invenio_communities.communities.services.results.CommunityItem object at 0x7fb4c5cc9db0>
members = {'curator': <pytest_invenio.user.UserFixtureBase object at 0x7fb4c57c66d0>, 'manager': <pytest_invenio.user.UserFixtur...er.UserFixtureBase object at 0x7fb4c7509650>, 'reader': <pytest_invenio.user.UserFixtureBase object at 0x7fb4c4a37800>}
    def test_user_recipient_generator(community, members):
        """Add community members based on provided roles."""
        n = Notification(
            type="",
            context={"community": community.to_dict()},
        )
        # get all members of the community
        recipients = {}
>       CommunityMembersRecipient(key="community")(n, recipients=recipients)
tests/test_notifications.py:25: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_communities/notifications/generators.py:41: in __call__
    for m in members:
             ^^^^^^^
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:206: in hits
    projection = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
invenio_communities/members/services/schemas.py:116: in get_member
    return self.get_user_member(obj["user"])
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <MemberDumpSchema(many=False)>
user = {'@v': '1::0', 'active': True, 'confirmed': True, 'email': 'owner@owner.org', ...}
    def get_user_member(self, user):
        """Get a user member."""
        profile = user.get("profile", {})
        name = profile.get("full_name") or user.get("username") or _("Untitled")
        description = profile.get("affiliations") or ""
        fake_user_obj = SimpleNamespace(id=user["id"])
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_communities/members/services/schemas.py:126: KeyError
---------------------------- Captured stderr setup -----------------------------
Flask-DebugToolbar extension not installed
[2026-02-17 10:06:10,362] DEBUG in ext: Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
Flask-DebugToolbar extension not installed
------------------------------ Captured log setup ------------------------------
DEBUG    invenio:ext.py:99 Flask-DebugToolbar extension not installed
=============================== warnings summary ===============================
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:9
    pyparsing.ParserElement.enablePackrat()
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:52
    oneThru12 = oneOf(["%.2d" % i for i in range(1, 13)])
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:53
    oneThru13 = oneOf(["%.2d" % i for i in range(1, 14)])
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:54
    oneThru23 = oneOf(["%.2d" % i for i in range(1, 24)])
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:55
    zeroThru23 = oneOf(["%.2d" % i for i in range(0, 24)])
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:56
    oneThru29 = oneOf(["%.2d" % i for i in range(1, 30)])
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:57
    oneThru30 = oneOf(["%.2d" % i for i in range(1, 31)])
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:58
    oneThru31 = oneOf(["%.2d" % i for i in range(1, 32)])
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:59
    oneThru59 = oneOf(["%.2d" % i for i in range(1, 60)])
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:60
    zeroThru59 = oneOf(["%.2d" % i for i in range(0, 60)])
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:63
    positiveDigit = Word(nums, exact=1, excludeChars="0")
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:73
    (oneOf("01 03 05 07 08 10 12")("month") + "-" + oneThru31("day"))
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:74
    ^ (oneOf("04 06 09 11")("month") + "-" + oneThru30("day"))
    p.addParseAction(cls.parse_action)
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:119
    UASymbol = Combine(oneOf("? ~ %"))
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:122
    seasonNumber = oneOf("21 22 23 24")
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:155
    l1Start.addParseAction(f)
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:157
    l1End.addParseAction(f)
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:199
    monthWithX = Combine(oneOf("0X 1X") ^ ("X" + digitOrX))("month")
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:303
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:303
    earlier = L("..").addParseAction(f)("lower") + date("upper").addParseAction(f)
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:304
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:304
    later = date("lower").addParseAction(f) + L("..").addParseAction(f)("upper")
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:325
    seasonL2Number = oneOf("21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41")
venv/lib/python3.14/site-packages/invenio_records/resolver.py:14
venv/lib/python3.14/site-packages/invenio_records/resolver.py:14
    from jsonschema import RefResolutionError, RefResolver
venv/lib/python3.14/site-packages/invenio_records/resolver.py:14
venv/lib/python3.14/site-packages/invenio_records/resolver.py:14
    from jsonschema import RefResolutionError, RefResolver
venv/lib/python3.14/site-packages/invenio_users_resources/services/domains/config.py:91
    "self": Link("{+api}/domains/{domain}", vars=domainvar),
venv/lib/python3.14/site-packages/invenio_users_resources/services/domains/config.py:92
    "admin_self_html": Link(
venv/lib/python3.14/site-packages/invenio_users_resources/services/domains/config.py:95
    "admin_users_html": Link(
venv/lib/python3.14/site-packages/invenio_users_resources/services/domains/config.py:99
    links_search = pagination_links("{+api}/domains{?args*}")
    "prev": Link(
    "self": Link(tpl),
    "next": Link(
venv/lib/python3.14/site-packages/invenio_users_resources/services/groups/config.py:78
    "self": Link("{+api}/groups/{id}"),
venv/lib/python3.14/site-packages/invenio_users_resources/services/groups/config.py:79
    "avatar": Link("{+api}/groups/{id}/avatar.svg"),
venv/lib/python3.14/site-packages/invenio_users_resources/services/groups/config.py:81
    links_search = pagination_links("{+api}/groups{?args*}")
venv/lib/python3.14/site-packages/invenio_users_resources/services/users/config.py:203
    "self": Link("{+api}/users/{id}"),
venv/lib/python3.14/site-packages/invenio_users_resources/services/users/config.py:204
    "avatar": Link("{+api}/users/{id}/avatar.svg"),
venv/lib/python3.14/site-packages/invenio_users_resources/services/users/config.py:205
    "records_html": Link("{+ui}/search/records?q=parent.access.owned_by.user:{id}"),
venv/lib/python3.14/site-packages/invenio_users_resources/services/users/config.py:206
    "admin_records_html": Link(
venv/lib/python3.14/site-packages/invenio_users_resources/services/users/config.py:210
    "admin_drafts_html": Link(
venv/lib/python3.14/site-packages/invenio_users_resources/services/users/config.py:214
    "admin_moderation_html": Link(
venv/lib/python3.14/site-packages/invenio_users_resources/services/users/config.py:219
    links_search = pagination_links("{+api}/users{?args*}")
venv/lib/python3.14/site-packages/invenio_requests/services/events/config.py:109
    "self": RequestEventLink("{+api}/requests/{request_id}/comments/{id}"),
venv/lib/python3.14/site-packages/invenio_requests/services/events/config.py:110
    "self_html": RequestEventLink("{+ui}/requests/{request_id}#commentevent-{id}"),
venv/lib/python3.14/site-packages/invenio_requests/services/events/config.py:112
    links_search = pagination_links("{+api}/requests/{request_id}/timeline{?args*}")
venv/lib/python3.14/site-packages/invenio_requests/services/requests/config.py:107
    "self": RequestLink("{+api}/requests/{id}"),
venv/lib/python3.14/site-packages/invenio_requests/services/requests/config.py:108
    "self_html": RequestLink("{+ui}/requests/{id}"),
venv/lib/python3.14/site-packages/invenio_requests/services/requests/config.py:109
    "comments": RequestLink("{+api}/requests/{id}/comments"),
venv/lib/python3.14/site-packages/invenio_requests/services/requests/config.py:110
    "timeline": RequestLink("{+api}/requests/{id}/timeline"),
venv/lib/python3.14/site-packages/invenio_requests/services/requests/config.py:111
    "timeline_focused": RequestLink("{+api}/requests/{id}/timeline_focused"),
venv/lib/python3.14/site-packages/invenio_requests/services/requests/config.py:112
    "lock": RequestLink("{+api}/requests/{id}/lock"),
venv/lib/python3.14/site-packages/invenio_requests/services/requests/config.py:113
    "unlock": RequestLink("{+api}/requests/{id}/unlock"),
venv/lib/python3.14/site-packages/invenio_requests/services/requests/config.py:115
    links_search = pagination_links("{+api}/requests{?args*}")
venv/lib/python3.14/site-packages/invenio_requests/services/requests/config.py:116
    links_user_requests_search = pagination_links("{+api}/user/requests{?args*}")
venv/lib/python3.14/site-packages/invenio_requests/services/requests/config.py:117
    action_link = RequestLink(
venv/lib/python3.14/site-packages/invenio_vocabularies/config.py:15
    from idutils import is_doi, is_gnd, is_isni, is_orcid, is_ror, is_url
venv/lib/python3.14/site-packages/marshmallow/utils.py:361
venv/lib/python3.14/site-packages/marshmallow/utils.py:361
  /home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/marshmallow/utils.py:361: ChangedInMarshmallow4Warning: `Field` should not be instantiated. Use `fields.Raw` or  another field subclass instead
    return cls_or_instance()
venv/lib/python3.14/site-packages/invenio_jobs/services/config.py:73
    links_search = pagination_links("{+api}/tasks{?args*}")
venv/lib/python3.14/site-packages/invenio_jobs/services/config.py:108
    "self": JobLink("{+api}/jobs/{id}"),
venv/lib/python3.14/site-packages/invenio_jobs/services/config.py:109
    "runs": JobLink("{+api}/jobs/{id}/runs"),
venv/lib/python3.14/site-packages/invenio_jobs/services/config.py:110
    "self_admin_html": JobLink("{+ui}/administration/jobs/{id}"),
venv/lib/python3.14/site-packages/invenio_jobs/services/config.py:113
    links_search = pagination_links("{+api}/jobs{?args*}")
venv/lib/python3.14/site-packages/invenio_jobs/services/config.py:148
    "self": RunLink("{+api}/jobs/{job_id}/runs/{id}"),
venv/lib/python3.14/site-packages/invenio_jobs/services/config.py:149
    "stop": RunLink("{+api}/jobs/{job_id}/runs/{id}/actions/stop"),
venv/lib/python3.14/site-packages/invenio_jobs/services/config.py:150
    "logs": RunLink("{+api}/logs/jobs?q={id}"),
venv/lib/python3.14/site-packages/invenio_jobs/services/config.py:153
    links_search = pagination_links("{+api}/jobs/{job_id}{?args*}")
venv/lib/python3.14/site-packages/invenio_vocabularies/services/config.py:127
    "self": Link(
venv/lib/python3.14/site-packages/invenio_vocabularies/services/config.py:138
    links_search = pagination_links("{+api}/vocabularies/{type}{?args*}")
venv/lib/python3.14/site-packages/invenio_vocabularies/services/config.py:153
    if_=Link(
venv/lib/python3.14/site-packages/invenio_vocabularies/services/config.py:157
    else_=Link(
venv/lib/python3.14/site-packages/invenio_vocabularies/services/config.py:173
    links_search = pagination_links("{+api}/vocabularies/{type}{?args*}")
venv/lib/python3.14/site-packages/flask_resources/serializers/base.py:59
tests/communities/test_community_ui_serializer.py::test_ui_serializer
    warn(
    self.init_app(app)
    warnings.warn(
    self._set_cache(app, config)
    return util.wrap_callable(lambda ctx: fn(), fn)  # type: ignore
    self._confirmed = datetime.utcnow() if confirmed else None
    datetime.utcnow()
  /home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/flask_security/datastore.py:235: LegacyAPIWarning: The Query.get() method is considered legacy as of the 1.x series of SQLAlchemy and becomes a legacy construct in 2.0. The method is now available as Session.get() (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    return self.user_model.query.get(identifier)
    target.updated = datetime.utcnow()
    target.updated = datetime.utcnow()
    now_ = datetime.utcnow()
tests/communities/test_community_ui_serializer.py::test_ui_serializer
  /home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/flask_resources/serializers/base.py:56: RemovedInMarshmallow4Warning: The `context` parameter is deprecated and will be removed in marshmallow 4.0. Use `contextvars.ContextVar` to pass context instead
    self.object_schema = object_schema_cls(
tests/communities/test_community_ui_serializer.py::test_ui_serializer
  /home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/flask_resources/parsers/schema.py:61: RemovedInMarshmallow4Warning: The `context` parameter is deprecated and will be removed in marshmallow 4.0. Use `contextvars.ContextVar` to pass context instead
    super().__init__(**kwargs)
tests/communities/test_community_ui_serializer.py::test_ui_serializer
    warn(
tests/communities/test_components.py::test_oai_set_create_community
tests/communities/test_components.py::test_oai_set_delete_community
tests/communities/test_components.py::test_oai_set_renamed
tests/communities/test_components.py::test_oai_set_update
tests/communities/test_components.py::test_children_component_without_children
    slug=str(datetime.utcnow().timestamp()).replace(".", "-")
tests/communities/test_components.py::test_oai_set_create_community
tests/communities/test_components.py::test_oai_set_delete_community
tests/communities/test_components.py::test_oai_set_renamed
tests/communities/test_components.py::test_oai_set_update
    slug=str(datetime.utcnow().timestamp()).replace(".", "-")
    value = datetime.utcnow()
    warnings.warn(
    _security.datetime_factory(),
    created = datetime.utcnow()
    return cls(int(id_s, 16), datetime.utcfromtimestamp(int(created_s, 16)))
    now = now or datetime.utcnow()
tests/communities/test_resources.py::test_simple_flow
tests/communities/test_subcommunities.py::test_subcommunity_simple_flow
    current_app.logger.warn(
    target.updated = datetime.utcnow()
tests/communities/test_resources.py::test_logo_flow
    __import__("pkg_resources").declare_namespace(__name__)  # type: ignore
tests/communities/test_resources.py::test_logo_flow
  Implementing implicit namespace packages (as specified in PEP 420) is preferred to `pkg_resources.declare_namespace`. See https://setuptools.pypa.io/en/latest/references/keywords.html#keyword-namespace-packages
    declare_namespace(pkg)
tests/communities/test_resources.py::test_logo_flow
  Implementing implicit namespace packages (as specified in PEP 420) is preferred to `pkg_resources.declare_namespace`. See https://setuptools.pypa.io/en/latest/references/keywords.html#keyword-namespace-packages
    __import__("pkg_resources").declare_namespace(__name__)  # type: ignore
tests/communities/test_resources.py::test_logo_flow
  Implementing implicit namespace packages (as specified in PEP 420) is preferred to `pkg_resources.declare_namespace`. See https://setuptools.pypa.io/en/latest/references/keywords.html#keyword-namespace-packages
    __import__("pkg_resources").declare_namespace(__name__)  # type: ignore
tests/communities/test_resources.py::test_logo_flow
  Implementing implicit namespace packages (as specified in PEP 420) is preferred to `pkg_resources.declare_namespace`. See https://setuptools.pypa.io/en/latest/references/keywords.html#keyword-namespace-packages
    declare_namespace(parent)
    slug=str(datetime.utcnow().timestamp()).replace(".", "-")
tests/communities/test_services.py::test_search_featured
    "start_date": datetime.utcnow().isoformat(),
tests/communities/test_services.py::test_search_featured
    "start_date": (datetime.utcnow() + timedelta(days=1)).isoformat(),
tests/communities/test_services.py::test_search_featured
    data["start_date"] = (datetime.utcnow() - timedelta(days=1)).isoformat()
tests/communities/test_services.py::test_search_featured
    data["start_date"] = datetime.utcnow().isoformat()
tests/communities/test_services.py::test_reindex_featured_entries_task
    "start_date": (datetime.utcnow() + timedelta(days=1)).isoformat(),
tests/communities/test_services.py::test_reindex_featured_entries_task
    datetime.utcnow() + timedelta(seconds=near_future_difference)
tests/communities/test_services.py::test_reindex_featured_entries_task
    now = datetime.utcnow().isoformat()
tests/communities/test_services.py::test_create_featured
    slug=str(datetime.utcnow().timestamp()).replace(".", "-")
tests/communities/test_services.py::test_create_featured
    "start_date": datetime.utcnow().isoformat(),
tests/communities/test_services.py::test_get_featured
    "start_date": datetime.utcnow().isoformat(),
tests/communities/test_services.py::test_get_featured
    "start_date": (datetime.utcnow() + timedelta(days=1)).isoformat(),
tests/communities/test_services.py::test_delete_featured
    "start_date": datetime.utcnow().isoformat(),
tests/communities/test_services.py::test_delete_featured
    "start_date": (datetime.utcnow() + timedelta(days=1)).isoformat(),
tests/communities/test_services.py::test_update_featured
    "start_date": datetime.utcnow().isoformat(),
tests/communities/test_services.py::test_update_featured
    "start_date": (datetime.utcnow() + timedelta(days=1)).isoformat(),
tests/communities/test_services.py::test_community_deletion
    assert arrow.get(tombstone.removal_date).date() == datetime.utcnow().date()
tests/communities/test_tombstone.py::test_tombstone_creation
    "removal_date": datetime.datetime.utcnow(),
tests/communities/test_tombstone.py::test_tombstone_invalid_removed_by
    for invalid_value in [[], datetime.datetime.utcnow()]:
    datetime.utcnow().replace(tzinfo=timezone.utc)
    now = datetime.utcnow()
tests/records/test_mockrecords_api.py::test_record_create_empty
    warnings.warn(
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.14.2-final-0 ________________
Name                                                                             Stmts   Miss  Cover   Missing
invenio_communities/__init__.py                                                      4      0   100%
invenio_communities/administration/__init__.py                                       0      0   100%
invenio_communities/administration/communities.py                                   42      1    98%   78
invenio_communities/alembic/02cd82910727_update_role_id_type_upgrade.py             13      5    62%   33-55, 67
invenio_communities/alembic/5b478fe7ef7f_create_featured_communities_table.py       12      2    83%   24, 54
invenio_communities/alembic/5c68d45c80f0_add_deletion_status_to_communities.py      27     18    33%   22-43, 49-62, 67
invenio_communities/alembic/37b21951084c_update_role_id_type_downgrade.py           13      5    62%   22, 27-51
invenio_communities/alembic/72b37bb4119c_create_indeces_for_bucket_id.py            11      4    64%   21-27, 37-40
invenio_communities/alembic/90642d415317_create_communities_branch.py                8      2    75%   20, 25
invenio_communities/alembic/__init__.py                                              0      0   100%
invenio_communities/alembic/a3f5a8635cbb_remove_version_table.py                    22     12    45%   24-40, 48-111
invenio_communities/alembic/de9c14cbb0b2_create_communities_tables.py               24     14    42%   25-171, 178-193
invenio_communities/alembic/f701a32e6fbe_create_communities_members_table.py        14      4    71%   24-65, 75-76
invenio_communities/alembic/fbe746957cfc_create_member_tables.py                    36     26    28%   27-147, 157-196
invenio_communities/cache/__init__.py                                                0      0   100%
invenio_communities/cache/cache.py                                                  18      0   100%
invenio_communities/cache/redis.py                                                  29      1    97%   64
invenio_communities/cli.py                                                          76     21    72%   47-49, 56-62, 69-74, 99-100, 108-112, 124-126
invenio_communities/communities/__init__.py                                          3      0   100%
invenio_communities/communities/dumpers/__init__.py                                  0      0   100%
invenio_communities/communities/dumpers/featured.py                                 16      0   100%
invenio_communities/communities/entity_resolvers.py                                 32      9    72%   35-48, 69, 80
invenio_communities/communities/records/__init__.py                                  0      0   100%
invenio_communities/communities/records/api.py                                      45      0   100%
invenio_communities/communities/records/jsonschemas/__init__.py                      0      0   100%
invenio_communities/communities/records/mappings/__init__.py                         0      0   100%
invenio_communities/communities/records/mappings/os-v1/__init__.py                   0      0   100%
invenio_communities/communities/records/mappings/os-v2/__init__.py                   0      0   100%
invenio_communities/communities/records/mappings/v7/__init__.py                      0      0   100%
invenio_communities/communities/records/models.py                                   23      0   100%
invenio_communities/communities/records/systemfields/__init__.py                     0      0   100%
invenio_communities/communities/records/systemfields/access.py                     148     14    91%   136, 148, 154, 159, 170, 182, 194, 240, 264, 284-291, 304
invenio_communities/communities/records/systemfields/children.py                    50      3    94%   31, 74, 77
invenio_communities/communities/records/systemfields/deletion_status.py             59      6    90%   57, 61, 70, 75-78
invenio_communities/communities/records/systemfields/is_verified.py                 11      0   100%
invenio_communities/communities/records/systemfields/parent_community.py            53      2    96%   63-64
invenio_communities/communities/records/systemfields/pidslug.py                     44      3    93%   41, 51, 67
invenio_communities/communities/records/systemfields/tombstone.py                   96      4    96%   43, 139, 145, 177
invenio_communities/communities/resources/__init__.py                                3      0   100%
invenio_communities/communities/resources/args.py                                    5      0   100%
invenio_communities/communities/resources/config.py                                 21      0   100%
invenio_communities/communities/resources/resource.py                               91      6    93%   73-78, 89-96, 162-168
invenio_communities/communities/resources/serializer.py                              5      0   100%
invenio_communities/communities/resources/ui_schema.py                              75     17    77%   34-35, 50-61, 121-125, 132
invenio_communities/communities/schema.py                                          124      0   100%
invenio_communities/communities/services/__init__.py                                 4      0   100%
invenio_communities/communities/services/components.py                             188     10    95%   46, 57, 65, 80, 257, 283-284, 327, 331, 348
invenio_communities/communities/services/config.py                                  52      2    96%   81-85
invenio_communities/communities/services/facets.py                                   6      0   100%
invenio_communities/communities/services/links.py                                   34      1    97%   75
invenio_communities/communities/services/results.py                                 45      4    91%   76, 80, 100, 119
invenio_communities/communities/services/search_params.py                           14      1    93%   27
invenio_communities/communities/services/service.py                                258     21    92%   127, 305-306, 473, 480, 520-547, 634-638, 674-680, 716
invenio_communities/communities/services/sort.py                                    10      2    80%   32-33
invenio_communities/communities/services/uow.py                                     14      0   100%
invenio_communities/config.py                                                       50      0   100%
invenio_communities/errors.py                                                       29      1    97%   67
invenio_communities/ext.py                                                          73     10    86%   138-139, 144-189
invenio_communities/fixtures/__init__.py                                             0      0   100%
invenio_communities/fixtures/demo.py                                                 5      0   100%
invenio_communities/fixtures/tasks.py                                               42     13    69%   38-39, 42-43, 45-50, 76-79
invenio_communities/generators.py                                                  182     25    86%   74, 105-110, 150-151, 219-224, 228-229, 233-234, 254, 258, 281, 291, 295, 309, 365, 379, 397
invenio_communities/members/__init__.py                                              4      0   100%
invenio_communities/members/errors.py                                                3      0   100%
invenio_communities/members/records/__init__.py                                      3      0   100%
invenio_communities/members/records/api.py                                          94      6    94%   98-101, 216-219
invenio_communities/members/records/mappings/__init__.py                             0      0   100%
invenio_communities/members/records/mappings/os-v1/__init__.py                       0      0   100%
invenio_communities/members/records/mappings/os-v2/__init__.py                       0      0   100%
invenio_communities/members/records/mappings/v7/__init__.py                          0      0   100%
invenio_communities/members/records/models.py                                       55      4    93%   100-101, 159-160
invenio_communities/members/resources/__init__.py                                    3      0   100%
invenio_communities/members/resources/config.py                                     13      0   100%
invenio_communities/members/resources/resource.py                                   57      0   100%
invenio_communities/members/services/__init__.py                                     3      0   100%
invenio_communities/members/services/components.py                                  45     10    78%   34, 37, 41-48, 58, 69
invenio_communities/members/services/config.py                                      46      0   100%
invenio_communities/members/services/facets.py                                       7      0   100%
invenio_communities/members/services/fields.py                                      22      8    64%   38-45
invenio_communities/members/services/request.py                                     53     12    77%   50-56, 64-70, 78-84, 92-98
invenio_communities/members/services/schemas.py                                     81     20    75%   117-118, 127-131, 141-146, 170-177, 181, 185-198, 216-219
invenio_communities/members/services/service.py                                    239     26    89%   352, 379, 546, 671-688, 694-700, 711, 715, 719, 723, 828, 833, 839
invenio_communities/notifications/__init__.py                                        0      0   100%
invenio_communities/notifications/builders.py                                       85      5    94%   78, 100, 122, 144, 309
invenio_communities/notifications/generators.py                                     28     11    61%   43-57
invenio_communities/permissions.py                                                  49      0   100%
invenio_communities/proxies.py                                                       8      0   100%
invenio_communities/records/__init__.py                                              0      0   100%
invenio_communities/records/records/__init__.py                                      0      0   100%
invenio_communities/records/records/models.py                                       17      0   100%
invenio_communities/records/records/systemfields/__init__.py                         2      0   100%
invenio_communities/records/records/systemfields/communities/__init__.py             0      0   100%
invenio_communities/records/records/systemfields/communities/context.py              4      1    75%   28
invenio_communities/records/records/systemfields/communities/field.py               40     14    65%   59, 64-111, 115-118
invenio_communities/records/records/systemfields/communities/manager.py             99      2    98%   167, 208
invenio_communities/requests/user_moderation/__init__.py                             2      0   100%
invenio_communities/requests/user_moderation/actions.py                             40     28    30%   32-60, 70-85, 95-99, 108-117
invenio_communities/requests/user_moderation/tasks.py                               16      8    50%   19-25, 31-35
invenio_communities/roles.py                                                        61      1    98%   80
invenio_communities/searchapp.py                                                     5      1    80%   18
invenio_communities/subcommunities/__init__.py                                       3      0   100%
invenio_communities/subcommunities/resources/__init__.py                             3      0   100%
invenio_communities/subcommunities/resources/config.py                              20      0   100%
invenio_communities/subcommunities/resources/resource.py                            18      0   100%
invenio_communities/subcommunities/services/__init__.py                              4      0   100%
invenio_communities/subcommunities/services/config.py                               22      0   100%
invenio_communities/subcommunities/services/errors.py                                2      0   100%
invenio_communities/subcommunities/services/request.py                              67     16    76%   50-57, 96-108, 116-128, 137-144, 187, 200
invenio_communities/subcommunities/services/schema.py                               16      1    94%   49
invenio_communities/subcommunities/services/service.py                              62     11    82%   45, 55, 84, 119, 136, 166-175
invenio_communities/tasks.py                                                         5      1    80%   22
invenio_communities/utils.py                                                        55      5    91%   107, 110-113
invenio_communities/views/__init__.py                                                3      0   100%
invenio_communities/views/api.py                                                    11      0   100%
invenio_communities/views/communities.py                                           172    107    38%   169, 179-191, 196, 201, 209-210, 218-219, 231-260, 269-277, 296-309, 329-334, 346-371, 388-392, 404-414, 433-437, 455-459, 471-475, 489-492, 505-509, 522-525, 537-546
invenio_communities/views/decorators.py                                             27     10    63%   28-38, 51-57
invenio_communities/views/template_loader.py                                        24      2    92%   46-47
invenio_communities/views/ui.py                                                     84     34    60%   54, 59-70, 81-84, 89, 100-103, 108-111, 116-123, 243-245, 250-260
invenio_communities/webpack.py                                                       2      0   100%
TOTAL                                                                             4043    613    85%
=========================== short test summary info ============================
FAILED tests/members/test_members_notifications.py::test_community_invitation_submit_notification - KeyError: 'identity'
FAILED tests/members/test_members_notifications.py::test_community_invitation_accept_notification - KeyError: 'identity'
FAILED tests/members/test_members_notifications.py::test_community_invitation_cancel_notification - KeyError: 'identity'
FAILED tests/members/test_members_notifications.py::test_community_invitation_decline_notification - KeyError: 'identity'
FAILED tests/members/test_members_notifications.py::test_community_invitation_expire_notification - KeyError: 'identity'
FAILED tests/members/test_members_resource.py::test_invite - KeyError: 'identity'
FAILED tests/members/test_members_resource.py::test_search - KeyError: 'identity'
FAILED tests/members/test_members_resource.py::test_search_public - KeyError: 'identity'
FAILED tests/members/test_members_resource.py::test_search_invitation - KeyError: 'identity'
FAILED tests/members/test_members_resource.py::test_post_membership_requests - KeyError: 'identity'
FAILED tests/members/test_members_services.py::test_invite - KeyError: 'identity'
FAILED tests/members/test_members_services.py::test_invite_already_member - KeyError: 'identity'
FAILED tests/members/test_members_services.py::test_invite_view_request - KeyError: 'identity'
FAILED tests/members/test_members_services.py::test_search_members - KeyError: 'identity'
FAILED tests/members/test_members_services.py::test_scan_members - KeyError: 'identity'
FAILED tests/members/test_members_services.py::test_search_public_members - KeyError: 'identity'
FAILED tests/members/test_members_services.py::test_search_members_restricted - KeyError: 'identity'
FAILED tests/members/test_members_services.py::test_search_members_visibility_restricted - KeyError: 'identity'
FAILED tests/members/test_members_services.py::test_request_cancel_request_flow - KeyError: 'identity'
FAILED tests/members/test_members_services.py::test_relation_update_propagation - KeyError: 'identity'
FAILED tests/test_notifications.py::test_user_recipient_generator - KeyError: 'identity'
ERROR tests/members/test_members_components.py::test_accept_invite_cache_clear - KeyError: 'identity'
ERROR tests/members/test_members_services.py::test_search_invitations - KeyError: 'identity'
ERROR tests/members/test_members_services.py::test_invite_accept_flow - KeyError: 'identity'
ERROR tests/members/test_members_services.py::test_invite_decline_flow - KeyError: 'identity'
ERROR tests/members/test_members_services.py::test_invite_cancel_flow - KeyError: 'identity'
ERROR tests/members/test_members_services.py::test_invite_actions_permissions - KeyError: 'identity'
ERROR tests/members/test_members_services.py::test_update_declined_invitation[decline] - KeyError: 'identity'
ERROR tests/members/test_members_services.py::test_update_declined_invitation[cancel] - KeyError: 'identity'
ERROR tests/members/test_members_services.py::test_update_declined_invitation[expire] - KeyError: 'identity'
= 21 failed, 227 passed, 1 skipped, 4716 warnings, 9 errors in 159.40s (0:02:39) =
Exception ignored while closing generator <generator object scan at 0x7fb4c8747440>:
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/opensearchpy/helpers/actions.py", line 625, in scan
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/werkzeug/local.py", line 318, in __get__
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/werkzeug/local.py", line 526, in _get_current_object
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_search/proxies.py", line 22, in _get_current_search_client
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/invenio_search/proxies.py", line 17, in _get_current_search
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/werkzeug/local.py", line 318, in __get__
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-communities/original/.venv/lib/python3.14/site-packages/werkzeug/local.py", line 519, in _get_current_object
RuntimeError: Working outside of application context
This typically means that you attempted to use functionality that needed
the current application. To solve this, set up an application context
with app.app_context(). See the documentation for more information
 Container docker_services_cli-postgresql-1  Stopping
 Container docker_services_cli-opensearch-1  Stopping
 Container docker_services_cli-redis-1  Stopping
 Container docker_services_cli-redis-1  Stopped
 Container docker_services_cli-redis-1  Removing
 Container docker_services_cli-redis-1  Removed
 Container docker_services_cli-postgresql-1  Stopped
 Container docker_services_cli-postgresql-1  Removing
 Container docker_services_cli-postgresql-1  Removed
 Container docker_services_cli-opensearch-1  Stopped
 Container docker_services_cli-opensearch-1  Removing
 Container docker_services_cli-opensearch-1  Removed
 Network docker_services_cli_default  Removing
 Network docker_services_cli_default  Removed
