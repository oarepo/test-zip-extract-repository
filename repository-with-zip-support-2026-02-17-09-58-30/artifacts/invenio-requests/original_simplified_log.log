 opensearch Pulling 
 redis Pulling 
 postgresql Pulling 
 4f4fb700ef54 Already exists 
 4f4fb700ef54 Already exists 
 redis Pulled 
 postgresql Pulled 
 opensearch Pulled 
 Network docker_services_cli_default  Creating
 Network docker_services_cli_default  Created
 Container docker_services_cli-postgresql-1  Creating
 Container docker_services_cli-redis-1  Creating
 Container docker_services_cli-opensearch-1  Creating
 Container docker_services_cli-postgresql-1  Created
 Container docker_services_cli-opensearch-1  Created
 Container docker_services_cli-redis-1  Created
 Container docker_services_cli-opensearch-1  Starting
 Container docker_services_cli-postgresql-1  Starting
 Container docker_services_cli-redis-1  Starting
 Container docker_services_cli-redis-1  Started
 Container docker_services_cli-postgresql-1  Started
 Container docker_services_cli-opensearch-1  Started
============================= test session starts ==============================
platform linux -- Python 3.14.2, pytest-8.4.2, pluggy-1.6.0
rootdir: /home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original
configfile: setup.cfg
testpaths: docs, tests, invenio_requests
plugins: time-machine-2.19.0, isort-4.0.0, flask-1.3.0, black-ng-0.4.1, invenio-3.4.2, github-actions-annotate-failures-0.3.0, pydocstyle-2.4.0, cov-7.0.0, pycodestyle-2.5.0
collected 116 items
tests/customizations/test_request_types.py 
                           [  2%]
tests/records/events/test_api.py 
                                       [  3%]
tests/records/systemfields/test_calculated_systemfield.py 
             [  5%]
tests/records/systemfields/test_last_activity_field.py 
::error file=workdir/tests/invenio-requests/original/tests/records/systemfields/test_last_activity_field.py,line=68::test_last_activity_search%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-requests/original/tests/records/systemfields/test_last_activity_field.py,line=120::test_last_activity_sorting%0A%0AKeyError: 'identity'
F               [  7%]
tests/records/systemfields/test_last_reply_field.py 
::error file=workdir/tests/invenio-requests/original/tests/records/systemfields/test_last_reply_field.py,line=54::test_last_reply_search%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-requests/original/tests/records/systemfields/test_last_reply_field.py,line=124::test_search_index_last_reply%0A%0AKeyError: 'identity'
F
                 [ 11%]
tests/records/test_request_api.py 
                                      [ 12%]
tests/records/test_request_numberseq.py 
                                [ 12%]
tests/records/test_systemfield_relatedrecord.py 
                    [ 17%]
tests/resources/events/test_request_events_resources.py ::error file=workdir/tests/invenio-requests/original/tests/resources/events/test_request_events_resources.py,line=46::test_simple_comment_flow%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-requests/original/tests/resources/events/test_request_events_resources.py,line=154::test_timeline_links%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-requests/original/tests/resources/events/test_request_events_resources.py,line=210::test_empty_comment%0A%0AKeyError: 'identity'
F
             [ 20%]
tests/resources/requests/test_requests_resources.py 
               [ 25%]
tests/resources/user_moderation/test_user_moderation_resources.py 
 [ 31%]
                                                                    [ 35%]
tests/services/components/test_request_reviewers_component.py 
 [ 43%]
                                                                  [ 50%]
tests/services/events/test_event_permissions.py 
::error file=workdir/tests/invenio-requests/original/tests/services/events/test_event_permissions.py,line=130::test_creator_can_see_timeline%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-requests/original/tests/services/events/test_event_permissions.py,line=155::test_receiver_can_see_timeline_of_open_request%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-requests/original/tests/services/events/test_event_permissions.py,line=179::test_commenting_on_locked_request%0A%0AKeyError: 'identity'
F
                   [ 55%]
tests/services/events/test_request_events_service.py 
::error file=workdir/tests/invenio-requests/original/tests/services/events/test_request_events_service.py,line=55::test_simple_flow%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-requests/original/tests/services/events/test_request_events_service.py,line=138::test_cannot_change_event_type%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-requests/original/tests/services/events/test_request_events_service.py,line=172::test_events_are_searchable%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-requests/original/tests/services/events/test_request_events_service.py,line=194::test_comment_request_event_notification%0A%0Aassert 0 == 1%0A +  where 0 = len([])
F
::error file=workdir/tests/invenio-requests/original/tests/services/events/test_request_events_service.py,line=217::test_notification_without_profile%0A%0Aassert 0 == 1%0A +  where 0 = len([])
F
::error file=workdir/tests/invenio-requests/original/tests/services/events/test_request_events_service.py,line=339::test_create_component_called%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-requests/original/tests/services/events/test_request_events_service.py,line=371::test_update_component_called%0A%0AKeyError: 'identity'
F
          [ 63%]
tests/services/events/test_request_events_service_config.py 
           [ 65%]
tests/services/requests/test_request_permissions.py 
::error file=workdir/tests/invenio-requests/original/tests/services/requests/test_request_permissions.py,line=260::test_only_system_can_update_closed_request%0A%0AKeyError: 'identity'
F
        [ 76%]
tests/services/requests/test_request_search_permissions.py 
             [ 77%]
tests/services/requests/test_requests_schemas.py 
                      [ 79%]
tests/services/requests/test_requests_service.py ::error file=workdir/tests/invenio-requests/original/tests/services/requests/test_requests_service.py,line=27::test_submit_request%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-requests/original/tests/services/requests/test_requests_service.py,line=146::test_update_request%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-requests/original/tests/services/requests/test_requests_service.py,line=164::test_search_user_requests%0A%0AKeyError: 'identity'
F
                [ 86%]
tests/services/requests/test_requests_service_config.py 
               [ 87%]
tests/services/requests/test_requests_tasks.py ::error file=workdir/tests/invenio-requests/original/tests/services/requests/test_requests_tasks.py,line=80::test_check_expired_requests%0A%0AKeyError: 'identity'
F
                         [ 88%]
tests/services/user_moderation/test_user_moderation_service.py 
::error file=workdir/tests/invenio-requests/original/tests/services/user_moderation/test_user_moderation_service.py,line=68::test_search_moderation%0A%0AKeyError: 'identity'
F
   [ 94%]
tests/test_alembic.py 
                                                  [ 95%]
tests/test_invenio_requests.py ..                                        [ 97%]
tests/test_type_registry.py ...                                          [100%]
=================================== FAILURES ===================================
__________________________ test_last_activity_search ___________________________
search = <OpenSearch([{'host': 'localhost', 'port': 9200}])>
database = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>
example_request = {'type': 'base-request', 'title': 'Foo bar', 'topic': None, 'status': 'submitted', '$schema': 'local://requests/request-v1.0.0.json', 'receiver': {'user': '2'}, 'created_by': {'user': '1'}}
user1 = <pytest_invenio.user.UserFixtureBase object at 0x7f6abacb3bd0>
    def test_last_activity_search(search, database, example_request, user1):
        """Test that search calls properly handle last_activity_at."""
        results = requests_service.search(user1.identity, expand=True).to_dict()
        assert results["hits"]["total"] == 1
        hit = results["hits"]["hits"][0]
        assert hit["last_activity_at"] is not None
        # Should equal the request's model.updated timestamp initially
        assert (
            hit["last_activity_at"]
            == example_request.model.updated.replace(tzinfo=timezone.utc).isoformat()
        )
        # Add a comment from user1 at a later time
        initial_updated = example_request.model.updated
        with time_machine.travel(initial_updated + timedelta(seconds=30)):
            comment1 = add_comment(example_request, user1.identity, "First comment")
        example_request = Request.get_record(example_request.id)
        # Should reflect the new last activity
>       results = requests_service.search(user1.identity, expand=True).to_dict()
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/records/systemfields/test_last_activity_field.py:68: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_requests/services/requests/results.py:187: in to_dict
    hits = list(self.hits)
           ^^^^^^^^^^^^^^^
invenio_requests/services/requests/results.py:167: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:656: in _serialize
    return schema.dump(nested_obj, many=many)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <RequestEventSchema(many=False)>
obj = {'$schema': 'local://requestevents/requestevent-v1.0.0.json', 'payload': {'format': 'html', 'content': 'First comment'}, 'created_by': {'user': '1'}, 'request_id': 'd338ead7-ab40-4551-b49c-6c7fd699f83d'}
    def get_permissions(self, obj):
        """Return permissions to act on comments or empty dict."""
        is_comment = obj.type == CommentEventType
        if is_comment:
            service = current_requests.request_events_service
            return {
                "can_update_comment": service.check_permission(
>                   self.context["identity"],
                    ^^^^^^^^^^^^^^^^^^^^^^^^
                    "update_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
                "can_delete_comment": service.check_permission(
                    self.context["identity"],
                    "delete_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
            }
E           KeyError: 'identity'
invenio_requests/services/schemas.py:50: KeyError
__________________________ test_last_activity_sorting __________________________
database = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>
search_clear = <OpenSearch([{'host': 'localhost', 'port': 9200}])>
user1 = <pytest_invenio.user.UserFixtureBase object at 0x7f6abacb3bd0>
user2 = <pytest_invenio.user.UserFixtureBase object at 0x7f6abacb0f30>
    def test_last_activity_sorting(database, search_clear, user1, user2):
        """Test sorting by last activity."""
        with time_machine.travel(
            datetime(2025, 1, 1, 12, 0, 0, tzinfo=timezone.utc)
        ) as traveller:
            # Create first request with a comment
            request_1 = create_request(database, user1, user2, title="Request 1")
            traveller.shift(timedelta(seconds=30))
            add_comment(request_1, user1.identity, "Comment on request 1")
            # Create second request with no comments
            traveller.shift(timedelta(seconds=30))
            request_2 = create_request(database, user1, user2, title="Request 2")
            # Create third request with a new comment
            traveller.shift(timedelta(seconds=30))
            request_3 = create_request(database, user1, user2, title="Request 3")
            traveller.shift(timedelta(seconds=30))
            add_comment(request_3, user1.identity, "Comment on request 3")
            # Test newest activity sort (should be 3, 2, 1)
            results = requests_service.search(
                system_identity, params={"sort": "newestactivity"}, expand=True
>           ).to_dict()
              ^^^^^^^^^
tests/records/systemfields/test_last_activity_field.py:120: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_requests/services/requests/results.py:187: in to_dict
    hits = list(self.hits)
           ^^^^^^^^^^^^^^^
invenio_requests/services/requests/results.py:167: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:656: in _serialize
    return schema.dump(nested_obj, many=many)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <RequestEventSchema(many=False)>
obj = {'$schema': 'local://requestevents/requestevent-v1.0.0.json', 'payload': {'format': 'html', 'content': 'Comment on request 3'}, 'created_by': {'user': '1'}, 'request_id': 'e2abbf3c-4a82-466a-93f4-0397cd83f91e'}
    def get_permissions(self, obj):
        """Return permissions to act on comments or empty dict."""
        is_comment = obj.type == CommentEventType
        if is_comment:
            service = current_requests.request_events_service
            return {
                "can_update_comment": service.check_permission(
>                   self.context["identity"],
                    ^^^^^^^^^^^^^^^^^^^^^^^^
                    "update_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
                "can_delete_comment": service.check_permission(
                    self.context["identity"],
                    "delete_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
            }
E           KeyError: 'identity'
invenio_requests/services/schemas.py:50: KeyError
____________________________ test_last_reply_search ____________________________
search = <OpenSearch([{'host': 'localhost', 'port': 9200}])>
example_request = {'type': 'base-request', 'title': 'Foo bar', 'topic': None, 'status': 'submitted', '$schema': 'local://requests/request-v1.0.0.json', 'receiver': {'user': '2'}, 'created_by': {'user': '1'}}
user1 = <pytest_invenio.user.UserFixtureBase object at 0x7f6aba73f590>
    def test_last_reply_search(search, example_request, user1):
        """Test that search calls use the pre-dumped last reply."""
        results = requests_service.search(user1.identity, expand=True).to_dict()
        assert results["hits"]["total"] == 1
        hit = results["hits"]["hits"][0]
        assert hit["last_reply"] is None
        # Add a comment from user1 (the creator)
        comment1 = add_comment(example_request, user1.identity, "First comment")
        example_request = Request.get_record(example_request.id)
        # Should reflect the last reply
>       results = requests_service.search(user1.identity, expand=True).to_dict()
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/records/systemfields/test_last_reply_field.py:54: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_requests/services/requests/results.py:187: in to_dict
    hits = list(self.hits)
           ^^^^^^^^^^^^^^^
invenio_requests/services/requests/results.py:167: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:656: in _serialize
    return schema.dump(nested_obj, many=many)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <RequestEventSchema(many=False)>
obj = {'$schema': 'local://requestevents/requestevent-v1.0.0.json', 'payload': {'format': 'html', 'content': 'First comment'}, 'created_by': {'user': '1'}, 'request_id': '9cb37d1c-9c39-4f69-a117-5b10d78d87eb'}
    def get_permissions(self, obj):
        """Return permissions to act on comments or empty dict."""
        is_comment = obj.type == CommentEventType
        if is_comment:
            service = current_requests.request_events_service
            return {
                "can_update_comment": service.check_permission(
>                   self.context["identity"],
                    ^^^^^^^^^^^^^^^^^^^^^^^^
                    "update_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
                "can_delete_comment": service.check_permission(
                    self.context["identity"],
                    "delete_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
            }
E           KeyError: 'identity'
invenio_requests/services/schemas.py:50: KeyError
_________________________ test_search_index_last_reply _________________________
example_request = {'$schema': 'local://requests/request-v1.0.0.json', 'type': 'base-request', 'title': 'Foo bar', 'receiver': {'user': '2'}, 'created_by': {'user': '1'}, 'topic': None, 'status': 'submitted'}
user2 = <pytest_invenio.user.UserFixtureBase object at 0x7f6abaa07cd0>
search_clear = <OpenSearch([{'host': 'localhost', 'port': 9200}])>
    def test_search_index_last_reply(example_request, user2, search_clear):
        """Test that last reply object is properly indexed."""
        # Add comment
        comment_event = add_comment(example_request, user2.identity, "Reply")
        def _assert_hit_eq(hit):
            assert hit["id"] == str(example_request.id)
            assert hit["last_reply"] is not None
            assert hit["last_reply"]["created_by"]["user"] == str(user2.user.id)
            assert (
                hit["last_reply"]["created"]
                == comment_event.created.replace(tzinfo=timezone.utc).isoformat()
            )
            assert hit["last_reply"]["id"] == str(comment_event.id)
            expanded = hit["expanded"]["last_reply"]
            assert expanded is not None
            assert expanded["created_by"]["id"] == str(user2.user.id)
            assert {"profile", "email", "username"} <= expanded["created_by"].keys()
        # Search by all requests first to check indexing
>       results = requests_service.search(system_identity, expand=True).to_dict()
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/records/systemfields/test_last_reply_field.py:124: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_requests/services/requests/results.py:187: in to_dict
    hits = list(self.hits)
           ^^^^^^^^^^^^^^^
invenio_requests/services/requests/results.py:167: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:656: in _serialize
    return schema.dump(nested_obj, many=many)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <RequestEventSchema(many=False)>
obj = {'$schema': 'local://requestevents/requestevent-v1.0.0.json', 'payload': {'format': 'html', 'content': 'Reply'}, 'created_by': {'user': '2'}, 'request_id': 'e300b138-25c5-4be5-979c-d8ab717751a5'}
    def get_permissions(self, obj):
        """Return permissions to act on comments or empty dict."""
        is_comment = obj.type == CommentEventType
        if is_comment:
            service = current_requests.request_events_service
            return {
                "can_update_comment": service.check_permission(
>                   self.context["identity"],
                    ^^^^^^^^^^^^^^^^^^^^^^^^
                    "update_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
                "can_delete_comment": service.check_permission(
                    self.context["identity"],
                    "delete_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
            }
E           KeyError: 'identity'
invenio_requests/services/schemas.py:50: KeyError
___________________________ test_simple_comment_flow ___________________________
app = <Flask 'invenio'>
client_logged_as = <function client_logged_as.<locals>.log_user at 0x7f6aba030eb0>
headers = {'accept': 'application/json', 'content-type': 'application/json'}
events_resource_data = {'payload': {'content': 'This is a comment.', 'format': 'html'}}
example_request = {'$schema': 'local://requests/request-v1.0.0.json', 'type': 'base-request', 'title': 'Foo bar', 'receiver': {'user': '2'}, 'created_by': {'user': '1'}, 'topic': None, 'status': 'created'}
    def test_simple_comment_flow(
        app, client_logged_as, headers, events_resource_data, example_request
    ):
        request_id = example_request.id
        # User 2 cannot comment yet (the record's still a draft)
        client = client_logged_as("user2@example.org")
        response = client.post(
            f"/requests/{request_id}/comments", headers=headers, json=events_resource_data
        )
        assert response.status_code == 403
        # User 1 comments (the creator is allowed to comment on their draft requests)
        client = client_logged_as("user1@example.org")
>       response = client.post(
            f"/requests/{request_id}/comments", headers=headers, json=events_resource_data
        )
tests/resources/events/test_request_events_resources.py:46: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/werkzeug/test.py:1167: in post
    return self.open(*args, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/testing.py:235: in open
    response = super().open(
venv/lib/python3.14/site-packages/werkzeug/test.py:1116: in open
    response_parts = self.run_wsgi_app(request.environ, buffered=buffered)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:988: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:1264: in run_wsgi_app
    app_rv = app(environ, start_response)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1536: in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1514: in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1511: in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:919: in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:917: in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:902: in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/resources.py:65: in view
    return view_meth()
           ^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/content_negotiation.py:116: in inner_content_negotiation
    return f(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:51: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:51: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:90: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/responses.py:39: in inner
    res = f(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^
invenio_requests/resources/events/resource.py:81: in create
    return item.to_dict(), 201
           ^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:106: in to_dict
    res = self.data
          ^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:78: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <GeneratedSchema(many=False)>
obj = {'$schema': 'local://requestevents/requestevent-v1.0.0.json', 'request_id': 'ffab3e28-22cc-45af-88f8-e038c76abc41', 'payload': {'content': 'This is a comment.', 'format': 'html'}, 'created_by': {'user': '1'}}
    def get_permissions(self, obj):
        """Return permissions to act on comments or empty dict."""
        is_comment = obj.type == CommentEventType
        if is_comment:
            service = current_requests.request_events_service
            return {
                "can_update_comment": service.check_permission(
>                   self.context["identity"],
                    ^^^^^^^^^^^^^^^^^^^^^^^^
                    "update_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
                "can_delete_comment": service.check_permission(
                    self.context["identity"],
                    "delete_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
            }
E           KeyError: 'identity'
invenio_requests/services/schemas.py:50: KeyError
---------------------------- Captured stderr setup -----------------------------
JSONSCHEMAS_HOST is set to localhost
[2026-02-17 10:01:46,582] WARNING in ext: JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
------------------------------ Captured log setup ------------------------------
WARNING  invenio:ext.py:291 JSONSCHEMAS_HOST is set to localhost
_____________________________ test_timeline_links ______________________________
client_logged_as = <function client_logged_as.<locals>.log_user at 0x7f6ab9ec6140>
events_resource_data = {'payload': {'content': 'This is a comment.', 'format': 'html'}}
example_request = {'$schema': 'local://requests/request-v1.0.0.json', 'type': 'base-request', 'title': 'Foo bar', 'receiver': {'user': '2'}, 'created_by': {'user': '1'}, 'topic': None, 'status': 'created'}
headers = {'accept': 'application/json', 'content-type': 'application/json'}
    def test_timeline_links(
        client_logged_as, events_resource_data, example_request, headers
    ):
        """Tests the links for the timeline (search) endpoint."""
        client = client_logged_as("user1@example.org")
        request_id = example_request.id
>       client.post(
            f"/requests/{request_id}/comments", headers=headers, json=events_resource_data
        )
tests/resources/events/test_request_events_resources.py:154: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/werkzeug/test.py:1167: in post
    return self.open(*args, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/testing.py:235: in open
    response = super().open(
venv/lib/python3.14/site-packages/werkzeug/test.py:1116: in open
    response_parts = self.run_wsgi_app(request.environ, buffered=buffered)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:988: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:1264: in run_wsgi_app
    app_rv = app(environ, start_response)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1536: in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1514: in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1511: in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:919: in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:917: in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:902: in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/resources.py:65: in view
    return view_meth()
           ^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/content_negotiation.py:116: in inner_content_negotiation
    return f(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:51: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:51: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:90: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/responses.py:39: in inner
    res = f(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^
invenio_requests/resources/events/resource.py:81: in create
    return item.to_dict(), 201
           ^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:106: in to_dict
    res = self.data
          ^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:78: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <GeneratedSchema(many=False)>
obj = {'$schema': 'local://requestevents/requestevent-v1.0.0.json', 'request_id': '65051ad7-938e-4411-a286-d6994f4ac45e', 'payload': {'content': 'This is a comment.', 'format': 'html'}, 'created_by': {'user': '1'}}
    def get_permissions(self, obj):
        """Return permissions to act on comments or empty dict."""
        is_comment = obj.type == CommentEventType
        if is_comment:
            service = current_requests.request_events_service
            return {
                "can_update_comment": service.check_permission(
>                   self.context["identity"],
                    ^^^^^^^^^^^^^^^^^^^^^^^^
                    "update_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
                "can_delete_comment": service.check_permission(
                    self.context["identity"],
                    "delete_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
            }
E           KeyError: 'identity'
invenio_requests/services/schemas.py:50: KeyError
______________________________ test_empty_comment ______________________________
app = <Flask 'invenio'>
client_logged_as = <function client_logged_as.<locals>.log_user at 0x7f6abc4a0670>
headers = {'accept': 'application/json', 'content-type': 'application/json'}
events_resource_data = {'payload': {'content': 'This is a comment.', 'format': 'html'}}
example_request = {'$schema': 'local://requests/request-v1.0.0.json', 'type': 'base-request', 'title': 'Foo bar', 'receiver': {'user': '2'}, 'created_by': {'user': '1'}, 'topic': None, 'status': 'created'}
    def test_empty_comment(
        app, client_logged_as, headers, events_resource_data, example_request
    ):
        client = client_logged_as("user1@example.org")
        request_id = example_request.id
        # Comment no payload is an error
        response = client.post(f"/requests/{request_id}/comments", headers=headers)
        expected_json = {
            "errors": [
                {"field": "payload", "messages": ["Missing data for required field."]}
            ],
            "message": "A validation error occurred.",
            "status": 400,
        }
        assert 400 == response.status_code
        assert expected_json == response.json
        # Comment {} is an error
        response = client.post(f"/requests/{request_id}/comments", headers=headers, json={})
        assert 400 == response.status_code
        assert expected_json == response.json
        # Comment empty content is an error
        data = copy.deepcopy(events_resource_data)
        data["payload"]["content"] = ""
        response = client.post(
            f"/requests/{request_id}/comments", headers=headers, json=data
        )
        assert 400 == response.status_code
        expected_json = {
            **expected_json,
            "errors": [
                {"field": "payload.content", "messages": ["Shorter than minimum length 1."]}
            ],
        }
        assert expected_json == response.json
        # Update with empty comment is an error
        # (first create one correctly)
        data["payload"]["content"] = "This is a comment."
>       response = client.post(
            f"/requests/{request_id}/comments", headers=headers, json=data
        )
tests/resources/events/test_request_events_resources.py:210: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/werkzeug/test.py:1167: in post
    return self.open(*args, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/testing.py:235: in open
    response = super().open(
venv/lib/python3.14/site-packages/werkzeug/test.py:1116: in open
    response_parts = self.run_wsgi_app(request.environ, buffered=buffered)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:988: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:1264: in run_wsgi_app
    app_rv = app(environ, start_response)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1536: in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1514: in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1511: in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:919: in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:917: in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:902: in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/resources.py:65: in view
    return view_meth()
           ^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/content_negotiation.py:116: in inner_content_negotiation
    return f(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:51: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:51: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:90: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/responses.py:39: in inner
    res = f(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^
invenio_requests/resources/events/resource.py:81: in create
    return item.to_dict(), 201
           ^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:106: in to_dict
    res = self.data
          ^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:78: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <GeneratedSchema(many=False)>
obj = {'$schema': 'local://requestevents/requestevent-v1.0.0.json', 'request_id': '312ca1f2-9a39-4522-8c5a-ee30055c6165', 'payload': {'content': 'This is a comment.', 'format': 'html'}, 'created_by': {'user': '1'}}
    def get_permissions(self, obj):
        """Return permissions to act on comments or empty dict."""
        is_comment = obj.type == CommentEventType
        if is_comment:
            service = current_requests.request_events_service
            return {
                "can_update_comment": service.check_permission(
>                   self.context["identity"],
                    ^^^^^^^^^^^^^^^^^^^^^^^^
                    "update_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
                "can_delete_comment": service.check_permission(
                    self.context["identity"],
                    "delete_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
            }
E           KeyError: 'identity'
invenio_requests/services/schemas.py:50: KeyError
________________________ test_creator_can_see_timeline _________________________
app = <Flask 'invenio'>
identity_simple = <Identity id="1" auth_type="None" provides={Need(method='system_role', value='authenticated_user'), Need(method='id', value=1), Need(method='system_role', value='any_user')}>
identity_simple_2 = <Identity id="2" auth_type="None" provides={Need(method='system_role', value='authenticated_user'), Need(method='id', value=2), Need(method='system_role', value='any_user')}>
identity_stranger = <Identity id="4" auth_type="None" provides={Need(method='system_role', value='any_user'), Need(method='id', value=4)}>
request_events_service = <invenio_requests.services.events.service.RequestEventsService object at 0x7f6ab8c2e350>
events_service_data = {'comment': {'payload': {'content': 'This is a comment.', 'format': 'html'}, 'type': 'C'}, 'log': {'payload': {'content': 'This is a log event.', 'event': 'LOG_EVENT', 'format': 'html'}, 'type': 'L'}}
example_request = {'$schema': 'local://requests/request-v1.0.0.json', 'type': 'base-request', 'title': 'Foo bar', 'receiver': {'user': '2'}, 'created_by': {'user': '1'}, 'topic': None, 'status': 'created'}
    def test_creator_can_see_timeline(
        app,
        identity_simple,
        identity_simple_2,
        identity_stranger,
        request_events_service,
        events_service_data,
        example_request,
    ):
        request_id = example_request.id
        comment = events_service_data["comment"]
        request_events_service.create(
            identity_simple, request_id, comment, CommentEventType
        )
        RequestEvent.index.refresh()
        # Stranger
        with pytest.raises(PermissionDeniedError):
            request_events_service.search(identity_stranger, request_id)
        # Receiver
        with pytest.raises(PermissionDeniedError):
            request_events_service.search(identity_simple_2, request_id)
        # Creator
>       assert list(request_events_service.search(identity_simple, request_id))
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/services/events/test_event_permissions.py:130: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_requests/services/events/config.py:63: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <GeneratedSchema(many=False)>
obj = {'$schema': 'local://requestevents/requestevent-v1.0.0.json', 'request_id': '03b0aa5e-7aa8-48ba-85d4-e002fe7d992d', 'payload': {'content': 'This is a comment.', 'format': 'html'}, 'created_by': {'user': '1'}}
    def get_permissions(self, obj):
        """Return permissions to act on comments or empty dict."""
        is_comment = obj.type == CommentEventType
        if is_comment:
            service = current_requests.request_events_service
            return {
                "can_update_comment": service.check_permission(
>                   self.context["identity"],
                    ^^^^^^^^^^^^^^^^^^^^^^^^
                    "update_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
                "can_delete_comment": service.check_permission(
                    self.context["identity"],
                    "delete_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
            }
E           KeyError: 'identity'
invenio_requests/services/schemas.py:50: KeyError
________________ test_receiver_can_see_timeline_of_open_request ________________
app = <Flask 'invenio'>
identity_simple = <Identity id="1" auth_type="None" provides={Need(method='system_role', value='authenticated_user'), Need(method='id', value=1), Need(method='system_role', value='any_user')}>
identity_simple_2 = <Identity id="2" auth_type="None" provides={Need(method='system_role', value='authenticated_user'), Need(method='id', value=2), Need(method='system_role', value='any_user')}>
identity_stranger = <Identity id="4" auth_type="None" provides={Need(method='system_role', value='any_user'), Need(method='id', value=4)}>
request_events_service = <invenio_requests.services.events.service.RequestEventsService object at 0x7f6ab8c2e350>
events_service_data = {'comment': {'payload': {'content': 'This is a comment.', 'format': 'html'}, 'type': 'C'}, 'log': {'payload': {'content': 'This is a log event.', 'event': 'LOG_EVENT', 'format': 'html'}, 'type': 'L'}}
submit_request = <function submit_request.<locals>._submit_request at 0x7f6ab8accca0>
    def test_receiver_can_see_timeline_of_open_request(
        app,
        identity_simple,
        identity_simple_2,
        identity_stranger,
        request_events_service,
        events_service_data,
        submit_request,
    ):
        request = submit_request(identity_simple)
        request_id = request.id
        comment = events_service_data["comment"]
        request_events_service.create(
            identity_simple, request_id, comment, CommentEventType
        )
        RequestEvent.index.refresh()
        # Stranger
        with pytest.raises(PermissionDeniedError):
            request_events_service.search(identity_stranger, request_id)
        # Receiver
>       assert list(request_events_service.search(identity_simple_2, request_id))
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/services/events/test_event_permissions.py:155: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_requests/services/events/config.py:63: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <GeneratedSchema(many=False)>
obj = {'$schema': 'local://requestevents/requestevent-v1.0.0.json', 'request_id': 'abdfe7e8-16b5-4421-b496-02aa13d40bf9', 'payload': {'content': 'Can I belong to the community?', 'format': 'html'}, 'created_by': {'user': '1'}}
    def get_permissions(self, obj):
        """Return permissions to act on comments or empty dict."""
        is_comment = obj.type == CommentEventType
        if is_comment:
            service = current_requests.request_events_service
            return {
                "can_update_comment": service.check_permission(
>                   self.context["identity"],
                    ^^^^^^^^^^^^^^^^^^^^^^^^
                    "update_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
                "can_delete_comment": service.check_permission(
                    self.context["identity"],
                    "delete_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
            }
E           KeyError: 'identity'
invenio_requests/services/schemas.py:50: KeyError
______________________ test_commenting_on_locked_request _______________________
app = <Flask 'invenio'>
identity_simple = <Identity id="1" auth_type="None" provides={Need(method='system_role', value='authenticated_user'), Need(method='id', value=1), Need(method='system_role', value='any_user')}>
identity_simple_2 = <Identity id="2" auth_type="None" provides={Need(method='system_role', value='authenticated_user'), Need(method='id', value=2), Need(method='system_role', value='any_user')}>
identity_stranger = <Identity id="4" auth_type="None" provides={Need(method='system_role', value='any_user'), Need(method='id', value=4)}>
request_events_service = <invenio_requests.services.events.service.RequestEventsService object at 0x7f6ab8c2e350>
requests_service = <invenio_requests.services.requests.service.RequestsService object at 0x7f6ab8c2e0b0>
events_service_data = {'comment': {'payload': {'content': 'This is a comment.', 'format': 'html'}, 'type': 'C'}, 'log': {'payload': {'content': 'This is a log event.', 'event': 'LOG_EVENT', 'format': 'html'}, 'type': 'L'}}
request_with_locking_enabled = {'$schema': 'local://requests/request-v1.0.0.json', 'type': 'base-request', 'title': 'Foo bar', 'receiver': {'user': '2'}, 'is_locked': False, 'created_by': {'user': '1'}, 'topic': None, 'status': 'submitted'}
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7f6ab8a81780>
    def test_commenting_on_locked_request(
        app,
        identity_simple,
        identity_simple_2,
        identity_stranger,
        request_events_service,
        requests_service,
        events_service_data,
        request_with_locking_enabled,
        monkeypatch,
    ):
        monkeypatch.setitem(app.config, "REQUESTS_LOCKING_ENABLED", True)
        request = request_with_locking_enabled
        comment = events_service_data["comment"]
        # Creator can submit comment
        item = request_events_service.create(
            identity_simple, request.id, comment, CommentEventType
        )
        comment_id = item.id
>       requests_service.lock_request(identity_simple_2, request.id)
tests/services/events/test_event_permissions.py:179: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/invenio_db/uow.py:251: in inner
    res = f(self, *args, **kwargs)
          ^^^^^^^^^^^^^^^^^^^^^^^^
invenio_requests/services/requests/service.py:324: in lock_request
    if request.data.get("is_locked", False):
       ^^^^^^^^^^^^
invenio_requests/services/requests/results.py:76: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:656: in _serialize
    return schema.dump(nested_obj, many=many)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <RequestEventSchema(many=False)>
obj = {'$schema': 'local://requestevents/requestevent-v1.0.0.json', 'payload': {'format': 'html', 'content': 'This is a comment.'}, 'created_by': {'user': '1'}, 'request_id': '32b74578-9553-4eb9-9f99-6679ac8b1434'}
    def get_permissions(self, obj):
        """Return permissions to act on comments or empty dict."""
        is_comment = obj.type == CommentEventType
        if is_comment:
            service = current_requests.request_events_service
            return {
                "can_update_comment": service.check_permission(
>                   self.context["identity"],
                    ^^^^^^^^^^^^^^^^^^^^^^^^
                    "update_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
                "can_delete_comment": service.check_permission(
                    self.context["identity"],
                    "delete_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
            }
E           KeyError: 'identity'
invenio_requests/services/schemas.py:50: KeyError
_______________________________ test_simple_flow _______________________________
app = <Flask 'invenio'>
identity_simple = <Identity id="1" auth_type="None" provides={Need(method='system_role', value='authenticated_user'), Need(method='id', value=1), Need(method='system_role', value='any_user')}>
events_service_data = {'comment': {'payload': {'content': 'This is a comment.', 'format': 'html'}, 'type': 'C'}, 'log': {'payload': {'content': 'This is a log event.', 'event': 'LOG_EVENT', 'format': 'html'}, 'type': 'L'}}
create_request = <function create_request.<locals>._create_request at 0x7f6ab85422a0>
request_events_service = <invenio_requests.services.events.service.RequestEventsService object at 0x7f6ab89ff770>
    def test_simple_flow(
        app, identity_simple, events_service_data, create_request, request_events_service
    ):
        """Interact with comment events."""
        request = create_request(identity_simple)
        request_id = request.id
        comment = events_service_data["comment"]
        # Create a comment
        item = request_events_service.create(
            identity_simple, request_id, dict(**comment), CommentEventType
        )
>       item_dict = item.to_dict()
                    ^^^^^^^^^^^^^^
tests/services/events/test_request_events_service.py:55: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:106: in to_dict
    res = self.data
          ^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:78: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <GeneratedSchema(many=False)>
obj = {'$schema': 'local://requestevents/requestevent-v1.0.0.json', 'request_id': '9f66b446-ca6a-44b8-a152-69f58252b5b5', 'payload': {'content': 'This is a comment.', 'format': 'html'}, 'created_by': {'user': '1'}}
    def get_permissions(self, obj):
        """Return permissions to act on comments or empty dict."""
        is_comment = obj.type == CommentEventType
        if is_comment:
            service = current_requests.request_events_service
            return {
                "can_update_comment": service.check_permission(
>                   self.context["identity"],
                    ^^^^^^^^^^^^^^^^^^^^^^^^
                    "update_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
                "can_delete_comment": service.check_permission(
                    self.context["identity"],
                    "delete_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
            }
E           KeyError: 'identity'
invenio_requests/services/schemas.py:50: KeyError
________________________ test_cannot_change_event_type _________________________
identity_simple = <Identity id="1" auth_type="None" provides={Need(method='system_role', value='authenticated_user'), Need(method='id', value=1), Need(method='system_role', value='any_user')}>
events_service_data = {'comment': {'payload': {'content': 'This is a comment.', 'format': 'html'}, 'type': 'C'}, 'log': {'payload': {'content': 'This is a log event.', 'event': 'LOG_EVENT', 'format': 'html'}, 'type': 'L'}}
example_request = {'$schema': 'local://requests/request-v1.0.0.json', 'type': 'base-request', 'title': 'Foo bar', 'receiver': {'user': '2'}, 'created_by': {'user': '1'}, 'topic': None, 'status': 'created'}
    def test_cannot_change_event_type(
        identity_simple, events_service_data, example_request
    ):
        # The `update`` service method can't be used to change the type
        events_service = current_requests.request_events_service
        comment = events_service_data["comment"]
        request_id = example_request.id
        item = events_service.create(identity_simple, request_id, comment, CommentEventType)
        comment_id = item.id
        data = {**comment, "type": LogEventType.type_id}
>       updated_event = events_service.update(identity_simple, comment_id, data).to_dict()
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/services/events/test_request_events_service.py:138: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:106: in to_dict
    res = self.data
          ^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:78: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <GeneratedSchema(many=False)>
obj = {'$schema': 'local://requestevents/requestevent-v1.0.0.json', 'payload': {'format': 'html', 'content': 'This is a comment.'}, 'created_by': {'user': '1'}, 'request_id': '4f4b5c5e-9b9b-47bc-b159-c71999706af6'}
    def get_permissions(self, obj):
        """Return permissions to act on comments or empty dict."""
        is_comment = obj.type == CommentEventType
        if is_comment:
            service = current_requests.request_events_service
            return {
                "can_update_comment": service.check_permission(
>                   self.context["identity"],
                    ^^^^^^^^^^^^^^^^^^^^^^^^
                    "update_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
                "can_delete_comment": service.check_permission(
                    self.context["identity"],
                    "delete_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
            }
E           KeyError: 'identity'
invenio_requests/services/schemas.py:50: KeyError
__________________________ test_events_are_searchable __________________________
app = <Flask 'invenio'>
identity_simple = <Identity id="1" auth_type="None" provides={Need(method='system_role', value='authenticated_user'), Need(method='id', value=1), Need(method='system_role', value='any_user')}>
events_service_data = {'comment': {'payload': {'content': 'This is a comment.', 'format': 'html'}, 'type': 'C'}, 'log': {'payload': {'content': 'This is a log event.', 'event': 'LOG_EVENT', 'format': 'html'}, 'type': 'L'}}
create_request = <function create_request.<locals>._create_request at 0x7f6ab862bb60>
request_events_service = <invenio_requests.services.events.service.RequestEventsService object at 0x7f6ab89ff770>
    def test_events_are_searchable(
        app, identity_simple, events_service_data, create_request, request_events_service
    ):
        """Search all type of events."""
        request = create_request(identity_simple)
        request_id = request.id
        comment = events_service_data["comment"]
        log_event = events_service_data["log"]
        # Create a comment
        request_events_service.create(
            identity_simple, request_id, comment, CommentEventType
        )
        # Create a log event
        request_events_service.create(identity_simple, request_id, log_event, LogEventType)
        # Refresh to make changes live
        RequestEvent.index.refresh()
        # search all events
        searched_items = request_events_service.search(
            identity_simple,
            request_id,
            size=10,
            page=1,
        )
        assert 2 == searched_items.total
>       search_comment = list(searched_items.hits)[0]
                         ^^^^^^^^^^^^^^^^^^^^^^^^^
tests/services/events/test_request_events_service.py:172: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_requests/services/events/config.py:63: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <GeneratedSchema(many=False)>
obj = {'$schema': 'local://requestevents/requestevent-v1.0.0.json', 'request_id': 'b8fc0523-b333-4c43-9d74-450491d4f406', 'payload': {'content': 'This is a comment.', 'format': 'html'}, 'created_by': {'user': '1'}}
    def get_permissions(self, obj):
        """Return permissions to act on comments or empty dict."""
        is_comment = obj.type == CommentEventType
        if is_comment:
            service = current_requests.request_events_service
            return {
                "can_update_comment": service.check_permission(
>                   self.context["identity"],
                    ^^^^^^^^^^^^^^^^^^^^^^^^
                    "update_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
                "can_delete_comment": service.check_permission(
                    self.context["identity"],
                    "delete_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
            }
E           KeyError: 'identity'
invenio_requests/services/schemas.py:50: KeyError
___________________ test_comment_request_event_notification ____________________
app = <Flask 'invenio'>
events_service_data = {'comment': {'payload': {'content': 'This is a comment.', 'format': 'html'}, 'type': 'C'}, 'log': {'payload': {'content': 'This is a log event.', 'event': 'LOG_EVENT', 'format': 'html'}, 'type': 'L'}}
submit_request = <function submit_request.<locals>._submit_request at 0x7f6ab86aa350>
request_events_service = <invenio_requests.services.events.service.RequestEventsService object at 0x7f6ab89ff770>
user1 = <pytest_invenio.user.UserFixtureBase object at 0x7f6ab858d180>
user2 = <pytest_invenio.user.UserFixtureBase object at 0x7f6ab8ace990>
superuser = <pytest_invenio.user.UserFixtureBase object at 0x7f6ab858e620>
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7f6ab86456a0>
    def test_comment_request_event_notification(
        app,
        events_service_data,
        submit_request,
        request_events_service,
        user1,
        user2,
        superuser,
        monkeypatch,
    ):
        """Test notification being sent on request comment create."""
>       _test_comment_request_event_notification(
            app,
            events_service_data,
            submit_request,
            request_events_service,
            user1,
            user2,
            superuser,
            monkeypatch,
        )
tests/services/events/test_request_events_service.py:194: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
app = <Flask 'invenio'>
events_service_data = {'comment': {'payload': {'content': 'This is a comment.', 'format': 'html'}, 'type': 'C'}, 'log': {'payload': {'content': 'This is a log event.', 'event': 'LOG_EVENT', 'format': 'html'}, 'type': 'L'}}
submit_request = <function submit_request.<locals>._submit_request at 0x7f6ab86aa350>
request_events_service = <invenio_requests.services.events.service.RequestEventsService object at 0x7f6ab89ff770>
user1 = <pytest_invenio.user.UserFixtureBase object at 0x7f6ab858d180>
user2 = <pytest_invenio.user.UserFixtureBase object at 0x7f6ab8ace990>
superuser = <pytest_invenio.user.UserFixtureBase object at 0x7f6ab858e620>
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7f6ab86456a0>
    def _test_comment_request_event_notification(
        app,
        events_service_data,
        submit_request,
        request_events_service,
        user1,
        user2,
        superuser,
        monkeypatch,
    ):
        original_builder = CommentRequestEventCreateNotificationBuilder
        # mock build to observe calls
        mock_build = MagicMock()
        mock_build.side_effect = original_builder.build
        monkeypatch.setattr(original_builder, "build", mock_build)
        # setting specific builder for test case
        monkeypatch.setattr(
            current_notifications_manager,
            "builders",
            {
                **current_notifications_manager.builders,
                original_builder.type: original_builder,
            },
        )
        assert not mock_build.called
        mail = app.extensions.get("mail")
        assert mail
        request = submit_request(user2.identity, receiver=user1.user)
        request_id = request.id
        comment = events_service_data["comment"]
        with mail.record_messages() as outbox:
            # Create a comment as creator
            request_events_service.create(
                user2.identity, request_id, dict(**comment), CommentEventType
            )
            # check notification is build on create
            assert mock_build.called
            # only request receiver should get notification
>           assert len(outbox) == 1
E           assert 0 == 1
E            +  where 0 = len([])
tests/services/events/test_request_events_service.py:273: AssertionError
------------------------------ Captured log call -------------------------------
ERROR    celery.app.trace:trace.py:267 Task invenio_notifications.tasks.broadcast_notification[8a216bf1-dd18-403d-8f12-559b6914c65b] raised unexpected: KeyError('identity')
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/celery/app/trace.py", line 453, in trace_task
    R = retval = fun(*args, **kwargs)
                 ~~~^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_notifications/tasks.py", line 21, in broadcast_notification
    current_notifications_manager.handle_broadcast(Notification(**notification))
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_notifications/manager.py", line 45, in handle_broadcast
    builder.resolve_context(notification)
    ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/builders.py", line 43, in resolve_context
    ctx_func(notification)
    ~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/generators.py", line 80, in __call__
    entity = EntityResolverRegistry.resolve_entity(entity_ref)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/registry.py", line 57, in resolve_entity
    return proxy.resolve()
           ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/base.py", line 86, in resolve
    self._entity = self._resolve()
                   ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/results.py", line 28, in _resolve
    return self.service.read(system_identity, id_).to_dict()
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/invenio_requests/services/requests/results.py", line 101, in to_dict
    res = self.data
          ^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/invenio_requests/services/requests/results.py", line 76, in data
    self._data = self._schema.dump(
                 ~~~~~~~~~~~~~~~~~^
        self._obj,
        ^^^^^^^^^^
    ...<3 lines>
        },
        ^^
    )
    ^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py", line 118, in dump
    return self.schema(**schema_args).dump(data)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 656, in _serialize
    return schema.dump(nested_obj, many=many)
           ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 2026, in _serialize
    return self._serialize_method(obj)
           ~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/invenio_requests/services/schemas.py", line 50, in get_permissions
    self.context["identity"],
    ~~~~~~~~~~~~^^^^^^^^^^^^
KeyError: 'identity'
ERROR    celery.app.trace:trace.py:267 Task invenio_notifications.tasks.broadcast_notification[beb70eda-f68e-45b4-9bee-b58b2fab9a49] raised unexpected: KeyError('identity')
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/celery/app/trace.py", line 453, in trace_task
    R = retval = fun(*args, **kwargs)
                 ~~~^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_notifications/tasks.py", line 21, in broadcast_notification
    current_notifications_manager.handle_broadcast(Notification(**notification))
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_notifications/manager.py", line 45, in handle_broadcast
    builder.resolve_context(notification)
    ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/builders.py", line 43, in resolve_context
    ctx_func(notification)
    ~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/generators.py", line 80, in __call__
    entity = EntityResolverRegistry.resolve_entity(entity_ref)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/registry.py", line 57, in resolve_entity
    return proxy.resolve()
           ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/base.py", line 86, in resolve
    self._entity = self._resolve()
                   ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/results.py", line 28, in _resolve
    return self.service.read(system_identity, id_).to_dict()
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/invenio_requests/services/requests/results.py", line 101, in to_dict
    res = self.data
          ^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/invenio_requests/services/requests/results.py", line 76, in data
    self._data = self._schema.dump(
                 ~~~~~~~~~~~~~~~~~^
        self._obj,
        ^^^^^^^^^^
    ...<3 lines>
        },
        ^^
    )
    ^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py", line 118, in dump
    return self.schema(**schema_args).dump(data)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 656, in _serialize
    return schema.dump(nested_obj, many=many)
           ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 2026, in _serialize
    return self._serialize_method(obj)
           ~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/invenio_requests/services/schemas.py", line 50, in get_permissions
    self.context["identity"],
    ~~~~~~~~~~~~^^^^^^^^^^^^
KeyError: 'identity'
______________________ test_notification_without_profile _______________________
app = <Flask 'invenio'>
events_service_data = {'comment': {'payload': {'content': 'This is a comment.', 'format': 'html'}, 'type': 'C'}, 'log': {'payload': {'content': 'This is a log event.', 'event': 'LOG_EVENT', 'format': 'html'}, 'type': 'L'}}
submit_request = <function submit_request.<locals>._submit_request at 0x7f6ab843b1c0>
request_events_service = <invenio_requests.services.events.service.RequestEventsService object at 0x7f6ab89ff770>
user1 = <pytest_invenio.user.UserFixtureBase object at 0x7f6ab858d180>
user_without_profile = <pytest_invenio.user.UserFixtureBase object at 0x7f6ab843b280>
superuser = <pytest_invenio.user.UserFixtureBase object at 0x7f6ab858e620>
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7f6ab877d320>
    def test_notification_without_profile(
        app,
        events_service_data,
        submit_request,
        request_events_service,
        user1,
        user_without_profile,
        superuser,
        monkeypatch,
    ):
        """Test notification being sent on request comment create for user without profile."""
>       _test_comment_request_event_notification(
            app,
            events_service_data,
            submit_request,
            request_events_service,
            user1,
            user_without_profile,
            superuser,
            monkeypatch,
        )
tests/services/events/test_request_events_service.py:217: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
app = <Flask 'invenio'>
events_service_data = {'comment': {'payload': {'content': 'This is a comment.', 'format': 'html'}, 'type': 'C'}, 'log': {'payload': {'content': 'This is a log event.', 'event': 'LOG_EVENT', 'format': 'html'}, 'type': 'L'}}
submit_request = <function submit_request.<locals>._submit_request at 0x7f6ab843b1c0>
request_events_service = <invenio_requests.services.events.service.RequestEventsService object at 0x7f6ab89ff770>
user1 = <pytest_invenio.user.UserFixtureBase object at 0x7f6ab858d180>
user2 = <pytest_invenio.user.UserFixtureBase object at 0x7f6ab843b280>
superuser = <pytest_invenio.user.UserFixtureBase object at 0x7f6ab858e620>
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7f6ab877d320>
    def _test_comment_request_event_notification(
        app,
        events_service_data,
        submit_request,
        request_events_service,
        user1,
        user2,
        superuser,
        monkeypatch,
    ):
        original_builder = CommentRequestEventCreateNotificationBuilder
        # mock build to observe calls
        mock_build = MagicMock()
        mock_build.side_effect = original_builder.build
        monkeypatch.setattr(original_builder, "build", mock_build)
        # setting specific builder for test case
        monkeypatch.setattr(
            current_notifications_manager,
            "builders",
            {
                **current_notifications_manager.builders,
                original_builder.type: original_builder,
            },
        )
        assert not mock_build.called
        mail = app.extensions.get("mail")
        assert mail
        request = submit_request(user2.identity, receiver=user1.user)
        request_id = request.id
        comment = events_service_data["comment"]
        with mail.record_messages() as outbox:
            # Create a comment as creator
            request_events_service.create(
                user2.identity, request_id, dict(**comment), CommentEventType
            )
            # check notification is build on create
            assert mock_build.called
            # only request receiver should get notification
>           assert len(outbox) == 1
E           assert 0 == 1
E            +  where 0 = len([])
tests/services/events/test_request_events_service.py:273: AssertionError
------------------------------ Captured log call -------------------------------
ERROR    celery.app.trace:trace.py:267 Task invenio_notifications.tasks.broadcast_notification[e0b3e14d-75b9-4f9c-aa1b-83acb34d646c] raised unexpected: KeyError('identity')
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/celery/app/trace.py", line 453, in trace_task
    R = retval = fun(*args, **kwargs)
                 ~~~^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_notifications/tasks.py", line 21, in broadcast_notification
    current_notifications_manager.handle_broadcast(Notification(**notification))
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_notifications/manager.py", line 45, in handle_broadcast
    builder.resolve_context(notification)
    ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/builders.py", line 43, in resolve_context
    ctx_func(notification)
    ~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/generators.py", line 80, in __call__
    entity = EntityResolverRegistry.resolve_entity(entity_ref)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/registry.py", line 57, in resolve_entity
    return proxy.resolve()
           ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/base.py", line 86, in resolve
    self._entity = self._resolve()
                   ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/results.py", line 28, in _resolve
    return self.service.read(system_identity, id_).to_dict()
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/invenio_requests/services/requests/results.py", line 101, in to_dict
    res = self.data
          ^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/invenio_requests/services/requests/results.py", line 76, in data
    self._data = self._schema.dump(
                 ~~~~~~~~~~~~~~~~~^
        self._obj,
        ^^^^^^^^^^
    ...<3 lines>
        },
        ^^
    )
    ^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py", line 118, in dump
    return self.schema(**schema_args).dump(data)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 656, in _serialize
    return schema.dump(nested_obj, many=many)
           ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 2026, in _serialize
    return self._serialize_method(obj)
           ~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/invenio_requests/services/schemas.py", line 50, in get_permissions
    self.context["identity"],
    ~~~~~~~~~~~~^^^^^^^^^^^^
KeyError: 'identity'
ERROR    celery.app.trace:trace.py:267 Task invenio_notifications.tasks.broadcast_notification[d530431a-76d5-4695-91a5-edf7d1138b05] raised unexpected: KeyError('identity')
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/celery/app/trace.py", line 453, in trace_task
    R = retval = fun(*args, **kwargs)
                 ~~~^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_notifications/tasks.py", line 21, in broadcast_notification
    current_notifications_manager.handle_broadcast(Notification(**notification))
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_notifications/manager.py", line 45, in handle_broadcast
    builder.resolve_context(notification)
    ~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/builders.py", line 43, in resolve_context
    ctx_func(notification)
    ~~~~~~~~^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_notifications/services/generators.py", line 80, in __call__
    entity = EntityResolverRegistry.resolve_entity(entity_ref)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/registry.py", line 57, in resolve_entity
    return proxy.resolve()
           ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/base.py", line 86, in resolve
    self._entity = self._resolve()
                   ~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_records_resources/references/entity_resolvers/results.py", line 28, in _resolve
    return self.service.read(system_identity, id_).to_dict()
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/invenio_requests/services/requests/results.py", line 101, in to_dict
    res = self.data
          ^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/invenio_requests/services/requests/results.py", line 76, in data
    self._data = self._schema.dump(
                 ~~~~~~~~~~~~~~~~~^
        self._obj,
        ^^^^^^^^^^
    ...<3 lines>
        },
        ^^
    )
    ^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py", line 118, in dump
    return self.schema(**schema_args).dump(data)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 656, in _serialize
    return schema.dump(nested_obj, many=many)
           ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 621, in dump
    result = self._serialize(processed_obj, many=many)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/marshmallow/schema.py", line 589, in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 348, in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/marshmallow/fields.py", line 2026, in _serialize
    return self._serialize_method(obj)
           ~~~~~~~~~~~~~~~~~~~~~~^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/invenio_requests/services/schemas.py", line 50, in get_permissions
    self.context["identity"],
    ~~~~~~~~~~~~^^^^^^^^^^^^
KeyError: 'identity'
_________________________ test_create_component_called _________________________
app = <Flask 'invenio'>
identity_simple = <Identity id="1" auth_type="None" provides={Need(method='system_role', value='authenticated_user'), Need(method='id', value=1), Need(method='system_role', value='any_user')}>
events_service_data = {'comment': {'payload': {'content': 'This is a comment.', 'format': 'html'}, 'type': 'C'}, 'log': {'payload': {'content': 'This is a log event.', 'event': 'LOG_EVENT', 'format': 'html'}, 'type': 'L'}}
create_request = <function create_request.<locals>._create_request at 0x7f6ab83aceb0>
request_events_service = <invenio_requests.services.events.service.RequestEventsService object at 0x7f6ab89ff770>
    def test_create_component_called(
        app, identity_simple, events_service_data, create_request, request_events_service
    ):
        """The component `add` method is called and modifies the supplied arguments."""
        class MockAddComponent(ServiceComponent):
            def create(
                self, identity, data=None, event=None, errors=None, uow=None, **kwargs
            ):
                event.update(
                    {"payload": {"content": "An edited comment", "format": "html"}}
                )
        app.config["REQUESTS_EVENTS_SERVICE_COMPONENTS"] = [MockAddComponent]
        request = create_request(identity_simple)
        request_id = request.id
        comment = events_service_data["comment"]
        # Create a comment
        item = request_events_service.create(
            identity_simple, request_id, dict(**comment), CommentEventType
        )
>       item_dict = item.to_dict()
                    ^^^^^^^^^^^^^^
tests/services/events/test_request_events_service.py:339: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:106: in to_dict
    res = self.data
          ^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:78: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <GeneratedSchema(many=False)>
obj = {'$schema': 'local://requestevents/requestevent-v1.0.0.json', 'request_id': '9bf30ec2-1426-4d50-9209-ffab846908e4', 'payload': {'content': 'An edited comment', 'format': 'html'}, 'created_by': {'user': '1'}}
    def get_permissions(self, obj):
        """Return permissions to act on comments or empty dict."""
        is_comment = obj.type == CommentEventType
        if is_comment:
            service = current_requests.request_events_service
            return {
                "can_update_comment": service.check_permission(
>                   self.context["identity"],
                    ^^^^^^^^^^^^^^^^^^^^^^^^
                    "update_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
                "can_delete_comment": service.check_permission(
                    self.context["identity"],
                    "delete_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
            }
E           KeyError: 'identity'
invenio_requests/services/schemas.py:50: KeyError
_________________________ test_update_component_called _________________________
app = <Flask 'invenio'>
identity_simple = <Identity id="1" auth_type="None" provides={Need(method='system_role', value='authenticated_user'), Need(method='id', value=1), Need(method='system_role', value='any_user')}>
events_service_data = {'comment': {'payload': {'content': 'This is a comment.', 'format': 'html'}, 'type': 'C'}, 'log': {'payload': {'content': 'This is a log event.', 'event': 'LOG_EVENT', 'format': 'html'}, 'type': 'L'}}
create_request = <function create_request.<locals>._create_request at 0x7f6ab876f1c0>
request_events_service = <invenio_requests.services.events.service.RequestEventsService object at 0x7f6ab89ff770>
    def test_update_component_called(
        app, identity_simple, events_service_data, create_request, request_events_service
    ):
        """The component `update_comment` method is called and modifies the event."""
        class MockUpdateComponent(ServiceComponent):
            def update_comment(
                self, identity, data=None, event=None, request=None, uow=None, **kwargs
            ):
                event.update(
                    {"payload": {"content": "Component modified content", "format": "html"}}
                )
        app.config["REQUESTS_EVENTS_SERVICE_COMPONENTS"] = [MockUpdateComponent]
        request = create_request(identity_simple)
        request_id = request.id
        comment = events_service_data["comment"]
        item = request_events_service.create(
            identity_simple, request_id, dict(**comment), CommentEventType
        )
        comment_id = item.id
>       data = item.to_dict()
               ^^^^^^^^^^^^^^
tests/services/events/test_request_events_service.py:371: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:106: in to_dict
    res = self.data
          ^^^^^^^^^
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/results.py:78: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <GeneratedSchema(many=False)>
obj = {'$schema': 'local://requestevents/requestevent-v1.0.0.json', 'request_id': 'e8987d61-1fee-42ea-9301-a1d03ba7e3c3', 'payload': {'content': 'This is a comment.', 'format': 'html'}, 'created_by': {'user': '1'}}
    def get_permissions(self, obj):
        """Return permissions to act on comments or empty dict."""
        is_comment = obj.type == CommentEventType
        if is_comment:
            service = current_requests.request_events_service
            return {
                "can_update_comment": service.check_permission(
>                   self.context["identity"],
                    ^^^^^^^^^^^^^^^^^^^^^^^^
                    "update_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
                "can_delete_comment": service.check_permission(
                    self.context["identity"],
                    "delete_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
            }
E           KeyError: 'identity'
invenio_requests/services/schemas.py:50: KeyError
__________________ test_only_system_can_update_closed_request __________________
app = <Flask 'invenio'>
identity_simple = <Identity id="1" auth_type="None" provides={Need(method='system_role', value='authenticated_user'), Need(method='id', value=1), Need(method='system_role', value='any_user')}>
identity_simple_2 = <Identity id="2" auth_type="None" provides={Need(method='system_role', value='authenticated_user'), Need(method='id', value=2), Need(method='system_role', value='any_user')}>
identity_stranger = <Identity id="4" auth_type="None" provides={Need(method='system_role', value='any_user'), Need(method='id', value=4)}>
requests_service = <invenio_requests.services.requests.service.RequestsService object at 0x7f6ab8eec650>
submit_request = <function submit_request.<locals>._submit_request at 0x7f6ab8ea9850>
    def test_only_system_can_update_closed_request(
        app,
        identity_simple,
        identity_simple_2,
        identity_stranger,
        requests_service,
        submit_request,
    ):
        request = submit_request(identity_simple)
        request_id = request.id
        result = requests_service.execute_action(system_identity, request_id, "decline")
>       data = result.to_dict()
               ^^^^^^^^^^^^^^^^
tests/services/requests/test_request_permissions.py:260: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_requests/services/requests/results.py:101: in to_dict
    res = self.data
          ^^^^^^^^^
invenio_requests/services/requests/results.py:76: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:656: in _serialize
    return schema.dump(nested_obj, many=many)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <RequestEventSchema(many=False)>
obj = {'$schema': 'local://requestevents/requestevent-v1.0.0.json', 'payload': {'format': 'html', 'content': 'Can I belong to the community?'}, 'created_by': {'user': '1'}, 'request_id': '61a87e22-8a14-44f5-a0df-4d46db5ed318'}
    def get_permissions(self, obj):
        """Return permissions to act on comments or empty dict."""
        is_comment = obj.type == CommentEventType
        if is_comment:
            service = current_requests.request_events_service
            return {
                "can_update_comment": service.check_permission(
>                   self.context["identity"],
                    ^^^^^^^^^^^^^^^^^^^^^^^^
                    "update_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
                "can_delete_comment": service.check_permission(
                    self.context["identity"],
                    "delete_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
            }
E           KeyError: 'identity'
invenio_requests/services/schemas.py:50: KeyError
_____________________________ test_submit_request ______________________________
app = <Flask 'invenio'>
identity_simple = <Identity id="1" auth_type="None" provides={Need(method='system_role', value='authenticated_user'), Need(method='id', value=1), Need(method='system_role', value='any_user')}>
submit_request = <function submit_request.<locals>._submit_request at 0x7f6ab84412d0>
request_events_service = <invenio_requests.services.events.service.RequestEventsService object at 0x7f6aba16d910>
    def test_submit_request(app, identity_simple, submit_request, request_events_service):
        request = submit_request(identity_simple)
        request_id = request.id
        RequestEvent.index.refresh()
        assert "submitted" == request.status
        results = request_events_service.search(identity_simple, request_id)
        assert 1 == results.total
>       hits = list(results.hits)
               ^^^^^^^^^^^^^^^^^^
tests/services/requests/test_requests_service.py:27: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_requests/services/events/config.py:63: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <GeneratedSchema(many=False)>
obj = {'$schema': 'local://requestevents/requestevent-v1.0.0.json', 'request_id': '337a1ea8-a8f2-4d63-9c49-32c649639b99', 'payload': {'content': 'Can I belong to the community?', 'format': 'html'}, 'created_by': {'user': '1'}}
    def get_permissions(self, obj):
        """Return permissions to act on comments or empty dict."""
        is_comment = obj.type == CommentEventType
        if is_comment:
            service = current_requests.request_events_service
            return {
                "can_update_comment": service.check_permission(
>                   self.context["identity"],
                    ^^^^^^^^^^^^^^^^^^^^^^^^
                    "update_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
                "can_delete_comment": service.check_permission(
                    self.context["identity"],
                    "delete_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
            }
E           KeyError: 'identity'
invenio_requests/services/schemas.py:50: KeyError
---------------------------- Captured stderr setup -----------------------------
JSONSCHEMAS_HOST is set to localhost
[2026-02-17 10:02:18,943] WARNING in ext: JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
------------------------------ Captured log setup ------------------------------
WARNING  invenio:ext.py:291 JSONSCHEMAS_HOST is set to localhost
_____________________________ test_update_request ______________________________
app = <Flask 'invenio'>
identity_simple = <Identity id="1" auth_type="None" provides={Need(method='system_role', value='authenticated_user'), Need(method='id', value=1), Need(method='system_role', value='any_user')}>
submit_request = <function submit_request.<locals>._submit_request at 0x7f6ab94d92d0>
requests_service = <invenio_requests.services.requests.service.RequestsService object at 0x7f6aba16c050>
    def test_update_request(app, identity_simple, submit_request, requests_service):
        request = submit_request(identity_simple)
        request_id = request.id
        request = requests_service.update(
            identity_simple, request_id, {"title": "Zim boum ba", "type": "default-request"}
        )
>       request_dict = request.to_dict()
                       ^^^^^^^^^^^^^^^^^
tests/services/requests/test_requests_service.py:146: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_requests/services/requests/results.py:101: in to_dict
    res = self.data
          ^^^^^^^^^
invenio_requests/services/requests/results.py:76: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:656: in _serialize
    return schema.dump(nested_obj, many=many)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <RequestEventSchema(many=False)>
obj = {'$schema': 'local://requestevents/requestevent-v1.0.0.json', 'payload': {'format': 'html', 'content': 'Can I belong to the community?'}, 'created_by': {'user': '1'}, 'request_id': '528963c7-fe9a-4de6-96a8-2690edbaf60a'}
    def get_permissions(self, obj):
        """Return permissions to act on comments or empty dict."""
        is_comment = obj.type == CommentEventType
        if is_comment:
            service = current_requests.request_events_service
            return {
                "can_update_comment": service.check_permission(
>                   self.context["identity"],
                    ^^^^^^^^^^^^^^^^^^^^^^^^
                    "update_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
                "can_delete_comment": service.check_permission(
                    self.context["identity"],
                    "delete_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
            }
E           KeyError: 'identity'
invenio_requests/services/schemas.py:50: KeyError
__________________________ test_search_user_requests ___________________________
app = <Flask 'invenio'>
identity_simple = <Identity id="1" auth_type="None" provides={Need(method='system_role', value='authenticated_user'), Need(method='id', value=1), Need(method='system_role', value='any_user')}>
identity_simple_2 = <Identity id="2" auth_type="None" provides={Need(method='system_role', value='authenticated_user'), Need(method='id', value=2), Need(method='system_role', value='any_user')}>
user1 = <pytest_invenio.user.UserFixtureBase object at 0x7f6ab844afc0>
submit_request = <function submit_request.<locals>._submit_request at 0x7f6ab94b4300>
requests_service = <invenio_requests.services.requests.service.RequestsService object at 0x7f6aba16c050>
create_request = <function create_request.<locals>._create_request at 0x7f6ab94b43b0>
    def test_search_user_requests(
        app,
        identity_simple,
        identity_simple_2,
        user1,
        submit_request,
        requests_service,
        create_request,
    ):
        request = submit_request(identity_simple, receiver=user1.user)
        request_id = request.id
        Request.index.refresh()
        # creator can see the requests
>       hits = requests_service.search_user_requests(identity_simple).to_dict()["hits"][
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
            "hits"
        ]
tests/services/requests/test_requests_service.py:164: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_requests/services/requests/results.py:187: in to_dict
    hits = list(self.hits)
           ^^^^^^^^^^^^^^^
invenio_requests/services/requests/results.py:167: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:656: in _serialize
    return schema.dump(nested_obj, many=many)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <RequestEventSchema(many=False)>
obj = {'$schema': 'local://requestevents/requestevent-v1.0.0.json', 'payload': {'format': 'html', 'content': 'Can I belong to the community?'}, 'created_by': {'user': '1'}, 'request_id': 'fd026701-0e0f-4baa-8bf5-f7def34e701c'}
    def get_permissions(self, obj):
        """Return permissions to act on comments or empty dict."""
        is_comment = obj.type == CommentEventType
        if is_comment:
            service = current_requests.request_events_service
            return {
                "can_update_comment": service.check_permission(
>                   self.context["identity"],
                    ^^^^^^^^^^^^^^^^^^^^^^^^
                    "update_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
                "can_delete_comment": service.check_permission(
                    self.context["identity"],
                    "delete_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
            }
E           KeyError: 'identity'
invenio_requests/services/schemas.py:50: KeyError
_________________________ test_check_expired_requests __________________________
app = <Flask 'invenio'>
identity_simple = <Identity id="1" auth_type="None" provides={Need(method='system_role', value='authenticated_user'), Need(method='id', value=1), Need(method='system_role', value='any_user')}>
create_request = <function create_request.<locals>._create_request at 0x7f6ab87c4250>
submit_request = <function submit_request.<locals>._submit_request at 0x7f6ab87c41a0>
requests_service = <invenio_requests.services.requests.service.RequestsService object at 0x7f6ab9dc6e90>
    def test_check_expired_requests(
        app, identity_simple, create_request, submit_request, requests_service
    ):
        """Test if the expired system field works as intended."""
        now = datetime.utcnow()
        # created only should not be picked up
        created_request = create_request(
            identity=identity_simple, expires_at=now.isoformat()
        )
        Request.index.refresh()
        check_expired_requests()
        Request.index.refresh()
        request_list = requests_service.search(
            identity=system_identity,
            extra_filter=dsl.query.Bool(
                "must",
                must=[
                    dsl.Q("term", **{"is_closed": True}),
                ],
            ),
        )
        assert request_list.total == 0
        # no expires_at should not be touched
        s1 = submit_request(identity_simple)
        Request.index.refresh()
        check_expired_requests()
        Request.index.refresh()
        request_list = requests_service.search(
            identity=system_identity,
            extra_filter=dsl.query.Bool(
                "must",
                must=[
                    dsl.Q("term", **{"is_closed": True}),
                ],
            ),
        )
        assert request_list.total == 0
        # expiry date in future should not be touched
        s2 = submit_request(
            identity_simple, expires_at=(now + timedelta(days=1)).isoformat()
        )
        Request.index.refresh()
        check_expired_requests()
        Request.index.refresh()
        request_list = requests_service.search(
            identity=system_identity,
            extra_filter=dsl.query.Bool(
                "must",
                must=[
                    dsl.Q("term", **{"is_closed": True}),
                ],
            ),
        )
        assert request_list.total == 0
        s3 = submit_request(identity_simple, expires_at=now.isoformat())
        Request.index.refresh()
>       check_expired_requests()
tests/services/requests/test_requests_tasks.py:80: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/celery/local.py:182: in __call__
    return self._get_current_object()(*a, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/celery/app/task.py:411: in __call__
    return self.run(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^
invenio_requests/tasks.py:42: in check_expired_requests
    for r in requests_list:
             ^^^^^^^^^^^^^
invenio_requests/services/requests/results.py:167: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:656: in _serialize
    return schema.dump(nested_obj, many=many)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <RequestEventSchema(many=False)>
obj = {'$schema': 'local://requestevents/requestevent-v1.0.0.json', 'payload': {'format': 'html', 'content': 'Can I belong to the community?'}, 'created_by': {'user': '1'}, 'request_id': 'e32f0dec-604b-4052-8a8e-681a68abea16'}
    def get_permissions(self, obj):
        """Return permissions to act on comments or empty dict."""
        is_comment = obj.type == CommentEventType
        if is_comment:
            service = current_requests.request_events_service
            return {
                "can_update_comment": service.check_permission(
>                   self.context["identity"],
                    ^^^^^^^^^^^^^^^^^^^^^^^^
                    "update_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
                "can_delete_comment": service.check_permission(
                    self.context["identity"],
                    "delete_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
            }
E           KeyError: 'identity'
invenio_requests/services/schemas.py:50: KeyError
---------------------------- Captured stderr setup -----------------------------
JSONSCHEMAS_HOST is set to localhost
[2026-02-17 10:02:23,165] WARNING in ext: JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
JSONSCHEMAS_HOST is set to localhost
------------------------------ Captured log setup ------------------------------
WARNING  invenio:ext.py:291 JSONSCHEMAS_HOST is set to localhost
____________________________ test_search_moderation ____________________________
app = <Flask 'invenio'>
es_clear = <OpenSearch([{'host': 'localhost', 'port': 9200}])>
users = {'user1': <pytest_invenio.user.UserFixtureBase object at 0x7f6ab883fa10>, 'user2': <pytest_invenio.user.UserFixtureBas...ser.UserFixtureBase object at 0x7f6ab87c78b0>, 'user4': <pytest_invenio.user.UserFixtureBase object at 0x7f6ab87c7750>}
submit_request = <function submit_request.<locals>._submit_request at 0x7f6ab7eee400>
mod_identity = <Identity id="5" auth_type="None" provides={Need(method='system_role', value='authenticated_user'), Need(method='role', value='administration-moderation')}>
    def test_search_moderation(app, es_clear, users, submit_request, mod_identity):
        """Tests the search for request moderation."""
        user = users["user2"]
        service = current_user_moderation_service
        request_item = service.request_moderation(system_identity, user_id=user.id)
        assert request_item
        # Create a generic request to test the user moderation search filter
        request = submit_request(system_identity, receiver=user.user)
        assert request
        # The user can search user moderation requests but can't see anything
        user_identity = get_identity(user.user)
        user_identity.provides.add(Need(method="system_role", value="authenticated_user"))
        search = current_requests_service.search(user_identity)
        assert search.total == 1  # User can see generic request
>       assert search.to_dict()["hits"]["hits"][0]["type"] == "base-request"
               ^^^^^^^^^^^^^^^^
tests/services/user_moderation/test_user_moderation_service.py:68: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_requests/services/requests/results.py:187: in to_dict
    hits = list(self.hits)
           ^^^^^^^^^^^^^^^
invenio_requests/services/requests/results.py:167: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:656: in _serialize
    return schema.dump(nested_obj, many=many)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <RequestEventSchema(many=False)>
obj = {'$schema': 'local://requestevents/requestevent-v1.0.0.json', 'payload': {'format': 'html', 'content': 'Can I belong to the community?'}, 'created_by': {'user': 'system'}, 'request_id': '9cbe153f-932c-4361-aa2f-df7e16cbb452'}
    def get_permissions(self, obj):
        """Return permissions to act on comments or empty dict."""
        is_comment = obj.type == CommentEventType
        if is_comment:
            service = current_requests.request_events_service
            return {
                "can_update_comment": service.check_permission(
>                   self.context["identity"],
                    ^^^^^^^^^^^^^^^^^^^^^^^^
                    "update_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
                "can_delete_comment": service.check_permission(
                    self.context["identity"],
                    "delete_comment",
                    event=obj,
                    request=self.context.get("request", None),
                ),
            }
E           KeyError: 'identity'
invenio_requests/services/schemas.py:50: KeyError
=============================== warnings summary ===============================
venv/lib/python3.14/site-packages/invenio_records/resolver.py:14
venv/lib/python3.14/site-packages/invenio_records/resolver.py:14
    from jsonschema import RefResolutionError, RefResolver
venv/lib/python3.14/site-packages/invenio_records/resolver.py:14
venv/lib/python3.14/site-packages/invenio_records/resolver.py:14
    from jsonschema import RefResolutionError, RefResolver
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:9
    pyparsing.ParserElement.enablePackrat()
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:52
    oneThru12 = oneOf(["%.2d" % i for i in range(1, 13)])
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:53
    oneThru13 = oneOf(["%.2d" % i for i in range(1, 14)])
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:54
    oneThru23 = oneOf(["%.2d" % i for i in range(1, 24)])
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:55
    zeroThru23 = oneOf(["%.2d" % i for i in range(0, 24)])
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:56
    oneThru29 = oneOf(["%.2d" % i for i in range(1, 30)])
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:57
    oneThru30 = oneOf(["%.2d" % i for i in range(1, 31)])
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:58
    oneThru31 = oneOf(["%.2d" % i for i in range(1, 32)])
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:59
    oneThru59 = oneOf(["%.2d" % i for i in range(1, 60)])
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:60
    zeroThru59 = oneOf(["%.2d" % i for i in range(0, 60)])
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:63
    positiveDigit = Word(nums, exact=1, excludeChars="0")
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:73
    (oneOf("01 03 05 07 08 10 12")("month") + "-" + oneThru31("day"))
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:74
    ^ (oneOf("04 06 09 11")("month") + "-" + oneThru30("day"))
    p.addParseAction(cls.parse_action)
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:119
    UASymbol = Combine(oneOf("? ~ %"))
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:122
    seasonNumber = oneOf("21 22 23 24")
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:155
    l1Start.addParseAction(f)
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:157
    l1End.addParseAction(f)
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:199
    monthWithX = Combine(oneOf("0X 1X") ^ ("X" + digitOrX))("month")
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:303
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:303
    earlier = L("..").addParseAction(f)("lower") + date("upper").addParseAction(f)
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:304
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:304
    later = date("lower").addParseAction(f) + L("..").addParseAction(f)("upper")
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:325
    seasonL2Number = oneOf("21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41")
venv/lib/python3.14/site-packages/invenio_users_resources/services/domains/config.py:91
    "self": Link("{+api}/domains/{domain}", vars=domainvar),
venv/lib/python3.14/site-packages/invenio_users_resources/services/domains/config.py:92
    "admin_self_html": Link(
venv/lib/python3.14/site-packages/invenio_users_resources/services/domains/config.py:95
    "admin_users_html": Link(
venv/lib/python3.14/site-packages/invenio_users_resources/services/domains/config.py:99
    links_search = pagination_links("{+api}/domains{?args*}")
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/links.py:57
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/links.py:57
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/links.py:57
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/links.py:57
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/links.py:57
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/links.py:57
    "prev": Link(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/links.py:64
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/links.py:64
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/links.py:64
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/links.py:64
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/links.py:64
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/links.py:64
    "self": Link(tpl),
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/links.py:65
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/links.py:65
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/links.py:65
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/links.py:65
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/links.py:65
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/links.py:65
    "next": Link(
venv/lib/python3.14/site-packages/invenio_users_resources/services/groups/config.py:78
    "self": Link("{+api}/groups/{id}"),
venv/lib/python3.14/site-packages/invenio_users_resources/services/groups/config.py:79
    "avatar": Link("{+api}/groups/{id}/avatar.svg"),
venv/lib/python3.14/site-packages/invenio_users_resources/services/groups/config.py:81
    links_search = pagination_links("{+api}/groups{?args*}")
venv/lib/python3.14/site-packages/invenio_users_resources/services/users/config.py:203
    "self": Link("{+api}/users/{id}"),
venv/lib/python3.14/site-packages/invenio_users_resources/services/users/config.py:204
    "avatar": Link("{+api}/users/{id}/avatar.svg"),
venv/lib/python3.14/site-packages/invenio_users_resources/services/users/config.py:205
    "records_html": Link("{+ui}/search/records?q=parent.access.owned_by.user:{id}"),
venv/lib/python3.14/site-packages/invenio_users_resources/services/users/config.py:206
    "admin_records_html": Link(
venv/lib/python3.14/site-packages/invenio_users_resources/services/users/config.py:210
    "admin_drafts_html": Link(
venv/lib/python3.14/site-packages/invenio_users_resources/services/users/config.py:214
    "admin_moderation_html": Link(
venv/lib/python3.14/site-packages/invenio_users_resources/services/users/config.py:219
    links_search = pagination_links("{+api}/users{?args*}")
invenio_requests/services/events/config.py:109
    "self": RequestEventLink("{+api}/requests/{request_id}/comments/{id}"),
invenio_requests/services/events/config.py:110
    "self_html": RequestEventLink("{+ui}/requests/{request_id}#commentevent-{id}"),
invenio_requests/services/events/config.py:112
    links_search = pagination_links("{+api}/requests/{request_id}/timeline{?args*}")
invenio_requests/services/requests/config.py:107
    "self": RequestLink("{+api}/requests/{id}"),
invenio_requests/services/requests/config.py:108
    "self_html": RequestLink("{+ui}/requests/{id}"),
invenio_requests/services/requests/config.py:109
    "comments": RequestLink("{+api}/requests/{id}/comments"),
invenio_requests/services/requests/config.py:110
    "timeline": RequestLink("{+api}/requests/{id}/timeline"),
invenio_requests/services/requests/config.py:111
    "timeline_focused": RequestLink("{+api}/requests/{id}/timeline_focused"),
invenio_requests/services/requests/config.py:112
    "lock": RequestLink("{+api}/requests/{id}/lock"),
invenio_requests/services/requests/config.py:113
    "unlock": RequestLink("{+api}/requests/{id}/unlock"),
invenio_requests/services/requests/config.py:115
    links_search = pagination_links("{+api}/requests{?args*}")
invenio_requests/services/requests/config.py:116
    links_user_requests_search = pagination_links("{+api}/user/requests{?args*}")
invenio_requests/services/requests/config.py:117
    action_link = RequestLink(
tests/customizations/test_request_types.py:33
  /home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/tests/customizations/test_request_types.py:33: PytestCollectionWarning: cannot collect test class 'TestAction' because it has a __init__ constructor (from: tests/customizations/test_request_types.py)
    class TestAction(RequestAction):
    self._confirmed = datetime.utcnow() if confirmed else None
    return util.wrap_callable(lambda ctx: fn(), fn)  # type: ignore
  /home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/flask_security/datastore.py:235: LegacyAPIWarning: The Query.get() method is considered legacy as of the 1.x series of SQLAlchemy and becomes a legacy construct in 2.0. The method is now available as Session.get() (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    return self.user_model.query.get(identifier)
    target.updated = datetime.utcnow()
    self.init_app(app)
    self._set_cache(app, config)
tests/records/systemfields/test_calculated_systemfield.py::test_expired_systemfield
    now = datetime.utcnow()
tests/records/systemfields/test_calculated_systemfield.py::test_expired_systemfield
tests/services/requests/test_requests_tasks.py::test_check_expired_requests
    now = datetime.utcnow()
tests/records/test_systemfield_relatedrecord.py::test_no_assignment
tests/records/test_systemfield_relatedrecord.py::test_record_assignment
tests/records/test_systemfield_relatedrecord.py::test_id_assignment
tests/records/test_systemfield_relatedrecord.py::test_remove_assignment
tests/records/test_systemfield_relatedrecord.py::test_dump_created_by
  /home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_records/api.py:335: SAWarning: nested transaction already deassociated from connection
    with db.session.begin_nested():
    target.updated = datetime.utcnow()
    _security.datetime_factory(),
    created = datetime.utcnow()
    return cls(int(id_s, 16), datetime.utcfromtimestamp(int(created_s, 16)))
    now = now or datetime.utcnow()
    warn(
tests/resources/user_moderation/test_user_moderation_resources.py::test_moderate
tests/resources/user_moderation/test_user_moderation_resources.py::test_links
tests/resources/user_moderation/test_user_moderation_resources.py::test_links
tests/services/user_moderation/test_user_moderation_service.py::test_moderation_accept
tests/services/user_moderation/test_user_moderation_service.py::test_moderation_accept
tests/services/user_moderation/test_user_moderation_service.py::test_moderation_decline
tests/services/user_moderation/test_user_moderation_service.py::test_moderation_decline
    self._created = datetime.utcnow()
tests/resources/user_moderation/test_user_moderation_resources.py::test_moderate
tests/services/user_moderation/test_user_moderation_service.py::test_moderation_accept
    now = datetime.utcnow()
tests/resources/user_moderation/test_user_moderation_resources.py::test_links
tests/services/user_moderation/test_user_moderation_service.py::test_moderation_decline
    now = datetime.utcnow()
tests/services/requests/test_requests_tasks.py::test_check_expired_requests
    now = datetime.utcnow()
tests/services/requests/test_requests_tasks.py::test_check_expired_requests
    now = datetime.utcnow().isoformat()
tests/test_alembic.py::test_alembic
    util.warn_deprecated(
tests/test_alembic.py::test_alembic
    current_date = datetime.utcnow()
tests/test_alembic.py::test_alembic
    super().alter_column(
tests/test_alembic.py::test_alembic
    insp = Inspector.from_engine(ctx.connection.engine)
tests/test_alembic.py::test_alembic
    insp = Inspector.from_engine(ctx.connection.engine)
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.14.2-final-0 ________________
Name                                                                             Stmts   Miss  Cover   Missing
invenio_requests/__init__.py                                                         5      0   100%
invenio_requests/alembic/5cd30a3503c9_create_requests_branch.py                      8      0   100%
invenio_requests/alembic/1759321170_add_index_to_request_events_request_id_.py       9      0   100%
invenio_requests/alembic/a14fa442680f_create_tables.py                              18      0   100%
invenio_requests/config.py                                                          37      0   100%
invenio_requests/customizations/__init__.py                                          5      0   100%
invenio_requests/customizations/actions.py                                          64      1    98%   89
invenio_requests/customizations/event_types.py                                      65      5    92%   60-62, 67, 71
invenio_requests/customizations/request_types.py                                    91      8    91%   125, 176-181, 226-227, 274
invenio_requests/customizations/states.py                                            5      0   100%
invenio_requests/customizations/user_moderation/__init__.py                          2      0   100%
invenio_requests/customizations/user_moderation/user_moderation.py                  29      0   100%
invenio_requests/errors.py                                                          32      3    91%   72, 88, 92
invenio_requests/ext.py                                                             66      2    97%   124, 133
invenio_requests/notifications/__init__.py                                           0      0   100%
invenio_requests/notifications/builders.py                                          18      0   100%
invenio_requests/notifications/filters.py                                           14      7    50%   25-36
invenio_requests/notifications/generators.py                                        33     21    36%   29-40, 44-80
invenio_requests/proxies.py                                                         16      0   100%
invenio_requests/records/__init__.py                                                 3      0   100%
invenio_requests/records/api.py                                                     72      0   100%
invenio_requests/records/dumpers/__init__.py                                         3      0   100%
invenio_requests/records/dumpers/calculated.py                                      10      0   100%
invenio_requests/records/dumpers/granttokens.py                                     20      2    90%   36-37
invenio_requests/records/jsonschemas/__init__.py                                     0      0   100%
invenio_requests/records/mappings/__init__.py                                        0      0   100%
invenio_requests/records/mappings/os-v1/__init__.py                                  0      0   100%
invenio_requests/records/mappings/os-v2/__init__.py                                  0      0   100%
invenio_requests/records/mappings/v7/__init__.py                                     0      0   100%
invenio_requests/records/models.py                                                  45      0   100%
invenio_requests/records/systemfields/__init__.py                                    9      0   100%
invenio_requests/records/systemfields/computed.py                                   63      2    97%   102, 120
invenio_requests/records/systemfields/entity_reference.py                           15      0   100%
invenio_requests/records/systemfields/event_type.py                                 48      2    96%   32, 62
invenio_requests/records/systemfields/expired_state.py                              14      1    93%   36
invenio_requests/records/systemfields/identity.py                                   11      2    82%   20-21
invenio_requests/records/systemfields/relatedrecord.py                              94     19    80%   32-34, 42-44, 52-53, 60-62, 131-132, 151-154, 165-166, 178
invenio_requests/records/systemfields/request_state.py                              10      0   100%
invenio_requests/records/systemfields/request_type.py                               30      1    97%   41
invenio_requests/records/systemfields/status.py                                     11      0   100%
invenio_requests/registry.py                                                        17      0   100%
invenio_requests/resolvers/__init__.py                                               1      0   100%
invenio_requests/resolvers/registry.py                                               6      0   100%
invenio_requests/resolvers/requests.py                                              15      4    73%   28, 37, 47, 56
invenio_requests/resources/__init__.py                                               3      0   100%
invenio_requests/resources/events/__init__.py                                        3      0   100%
invenio_requests/resources/events/config.py                                         15      0   100%
invenio_requests/resources/events/resource.py                                       56      8    86%   92-97, 106-113, 119-124, 150-158
invenio_requests/resources/requests/__init__.py                                      3      0   100%
invenio_requests/resources/requests/config.py                                       22      0   100%
invenio_requests/resources/requests/fields.py                                       16      6    62%   30, 32, 41-46
invenio_requests/resources/requests/resource.py                                     67      6    91%   87-93, 115-121, 127-131
invenio_requests/services/__init__.py                                                4      0   100%
invenio_requests/services/events/__init__.py                                         3      0   100%
invenio_requests/services/events/config.py                                          44      0   100%
invenio_requests/services/events/service.py                                        143     33    77%   90, 159-164, 189, 199, 341-380, 407-416, 443, 456
invenio_requests/services/generators.py                                             89      9    90%   49, 74, 112, 141, 172, 178, 185, 195, 199
invenio_requests/services/permissions.py                                            22      0   100%
invenio_requests/services/requests/__init__.py                                       6      0   100%
invenio_requests/services/requests/components.py                                    96      5    95%   176-185
invenio_requests/services/requests/config.py                                        39      0   100%
invenio_requests/services/requests/facets.py                                         5      0   100%
invenio_requests/services/requests/links.py                                         28      0   100%
invenio_requests/services/requests/params.py                                        57     11    81%   33, 59, 80, 82, 109-123, 136-137
invenio_requests/services/requests/results.py                                       84      8    90%   53, 63, 88-90, 97, 103, 118
invenio_requests/services/requests/service.py                                      107      2    98%   50, 339
invenio_requests/services/results.py                                                50     20    60%   32, 62-63, 67, 80-83, 88-90, 95-101, 105-107
invenio_requests/services/schemas.py                                                39      0   100%
invenio_requests/services/user_moderation/__init__.py                                2      0   100%
invenio_requests/services/user_moderation/errors.py                                  5      0   100%
invenio_requests/services/user_moderation/service.py                                36      1    97%   98
invenio_requests/tasks.py                                                           25      9    64%   43-49, 61-66
invenio_requests/views/__init__.py                                                   5      0   100%
invenio_requests/views/api.py                                                        6      0   100%
invenio_requests/views/decorators.py                                                13      9    31%   21-34
invenio_requests/views/requests.py                                                   0      0   100%
invenio_requests/views/ui.py                                                        19      5    74%   23, 28, 33-36
invenio_requests/webpack.py                                                          2      0   100%
TOTAL                                                                             2128    212    90%
=========================== short test summary info ============================
FAILED tests/records/systemfields/test_last_activity_field.py::test_last_activity_search - KeyError: 'identity'
FAILED tests/records/systemfields/test_last_activity_field.py::test_last_activity_sorting - KeyError: 'identity'
FAILED tests/records/systemfields/test_last_reply_field.py::test_last_reply_search - KeyError: 'identity'
FAILED tests/records/systemfields/test_last_reply_field.py::test_search_index_last_reply - KeyError: 'identity'
FAILED tests/resources/events/test_request_events_resources.py::test_simple_comment_flow - KeyError: 'identity'
FAILED tests/resources/events/test_request_events_resources.py::test_timeline_links - KeyError: 'identity'
FAILED tests/resources/events/test_request_events_resources.py::test_empty_comment - KeyError: 'identity'
FAILED tests/services/events/test_event_permissions.py::test_creator_can_see_timeline - KeyError: 'identity'
FAILED tests/services/events/test_event_permissions.py::test_receiver_can_see_timeline_of_open_request - KeyError: 'identity'
FAILED tests/services/events/test_event_permissions.py::test_commenting_on_locked_request - KeyError: 'identity'
FAILED tests/services/events/test_request_events_service.py::test_simple_flow - KeyError: 'identity'
FAILED tests/services/events/test_request_events_service.py::test_cannot_change_event_type - KeyError: 'identity'
FAILED tests/services/events/test_request_events_service.py::test_events_are_searchable - KeyError: 'identity'
FAILED tests/services/events/test_request_events_service.py::test_comment_request_event_notification - assert 0 == 1
 +  where 0 = len([])
FAILED tests/services/events/test_request_events_service.py::test_notification_without_profile - assert 0 == 1
 +  where 0 = len([])
FAILED tests/services/events/test_request_events_service.py::test_create_component_called - KeyError: 'identity'
FAILED tests/services/events/test_request_events_service.py::test_update_component_called - KeyError: 'identity'
FAILED tests/services/requests/test_request_permissions.py::test_only_system_can_update_closed_request - KeyError: 'identity'
FAILED tests/services/requests/test_requests_service.py::test_submit_request - KeyError: 'identity'
FAILED tests/services/requests/test_requests_service.py::test_update_request - KeyError: 'identity'
FAILED tests/services/requests/test_requests_service.py::test_search_user_requests - KeyError: 'identity'
FAILED tests/services/requests/test_requests_tasks.py::test_check_expired_requests - KeyError: 'identity'
FAILED tests/services/user_moderation/test_user_moderation_service.py::test_search_moderation - KeyError: 'identity'
=========== 23 failed, 93 passed, 1170 warnings in 71.79s (0:01:11) ============
/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/_pytest/unraisableexception.py:67: PytestUnraisableExceptionWarning: Exception ignored while closing generator <generator object scan at 0x7f6ab94a86c0>: None
Traceback (most recent call last):
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/opensearchpy/helpers/actions.py", line 625, in scan
    client.clear_scroll(
    ^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/werkzeug/local.py", line 318, in __get__
    obj = instance._get_current_object()
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/werkzeug/local.py", line 526, in _get_current_object
    return get_name(local())
                    ~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_search/proxies.py", line 22, in _get_current_search_client
    return _get_current_search().client
           ~~~~~~~~~~~~~~~~~~~^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/invenio_search/proxies.py", line 17, in _get_current_search
    return current_app.extensions["invenio-search"]
           ^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/werkzeug/local.py", line 318, in __get__
    obj = instance._get_current_object()
  File "/home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-requests/original/.venv/lib/python3.14/site-packages/werkzeug/local.py", line 519, in _get_current_object
    raise RuntimeError(unbound_message) from None
RuntimeError: Working outside of application context
This typically means that you attempted to use functionality that needed
the current application. To solve this, set up an application context
with app.app_context(). See the documentation for more information
  warnings.warn(pytest.PytestUnraisableExceptionWarning(msg))
 Container docker_services_cli-redis-1  Stopping
 Container docker_services_cli-opensearch-1  Stopping
 Container docker_services_cli-postgresql-1  Stopping
 Container docker_services_cli-redis-1  Stopped
 Container docker_services_cli-redis-1  Removing
 Container docker_services_cli-redis-1  Removed
 Container docker_services_cli-postgresql-1  Stopped
 Container docker_services_cli-postgresql-1  Removing
 Container docker_services_cli-postgresql-1  Removed
 Container docker_services_cli-opensearch-1  Stopped
 Container docker_services_cli-opensearch-1  Removing
 Container docker_services_cli-opensearch-1  Removed
 Network docker_services_cli_default  Removing
 Network docker_services_cli_default  Removed
