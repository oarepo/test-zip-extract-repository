running extract_messages
extracting messages from invenio_users_resources/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/config.py (encoding="utf-8")
extracting messages from invenio_users_resources/entity_resolvers.py (encoding="utf-8")
extracting messages from invenio_users_resources/ext.py (encoding="utf-8")
extracting messages from invenio_users_resources/forms.py (encoding="utf-8")
extracting messages from invenio_users_resources/models.py (encoding="utf-8")
extracting messages from invenio_users_resources/permissions.py (encoding="utf-8")
extracting messages from invenio_users_resources/proxies.py (encoding="utf-8")
extracting messages from invenio_users_resources/views.py (encoding="utf-8")
extracting messages from invenio_users_resources/notifications/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/notifications/filters.py (encoding="utf-8")
extracting messages from invenio_users_resources/notifications/generators.py (encoding="utf-8")
extracting messages from invenio_users_resources/records/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/records/api.py (encoding="utf-8")
extracting messages from invenio_users_resources/records/hooks.py (encoding="utf-8")
extracting messages from invenio_users_resources/records/models.py (encoding="utf-8")
extracting messages from invenio_users_resources/records/dumpers/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/records/dumpers/email.py (encoding="utf-8")
extracting messages from invenio_users_resources/records/mappings/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/records/mappings/os-v1/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/records/mappings/os-v2/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/records/mappings/v7/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/records/systemfields/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/resources/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/resources/domains/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/resources/domains/config.py (encoding="utf-8")
extracting messages from invenio_users_resources/resources/domains/resource.py (encoding="utf-8")
extracting messages from invenio_users_resources/resources/groups/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/resources/groups/config.py (encoding="utf-8")
extracting messages from invenio_users_resources/resources/groups/resource.py (encoding="utf-8")
extracting messages from invenio_users_resources/resources/users/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/resources/users/config.py (encoding="utf-8")
extracting messages from invenio_users_resources/resources/users/errors.py (encoding="utf-8")
extracting messages from invenio_users_resources/resources/users/resource.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/common.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/generators.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/params.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/permissions.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/results.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/schemas.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/domains/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/domains/components.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/domains/config.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/domains/facets.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/domains/service.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/domains/tasks.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/groups/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/groups/config.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/groups/results.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/groups/service.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/groups/tasks.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/users/__init__.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/users/config.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/users/facets.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/users/lock.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/users/results.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/users/search_params.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/users/service.py (encoding="utf-8")
extracting messages from invenio_users_resources/services/users/tasks.py (encoding="utf-8")
extracting messages from invenio_users_resources/templates/security/email/new_user_via_admin.html (encoding="utf-8")
extracting messages from invenio_users_resources/templates/semantic-ui/invenio_users_resources/settings/notifications.html (encoding="utf-8")
writing PO template file to /dev/null
 rabbitmq Pulling 
 redis Pulling 
 opensearch Pulling 
 postgresql Pulling 
 4f4fb700ef54 Already exists 
 4f4fb700ef54 Already exists 
 redis Pulled 
 rabbitmq Pulled 
 postgresql Pulled 
 opensearch Pulled 
 Network docker_services_cli_default  Creating
 Network docker_services_cli_default  Created
 Container docker_services_cli-postgresql-1  Creating
 Container docker_services_cli-rabbitmq-1  Creating
 Container docker_services_cli-opensearch-1  Creating
 Container docker_services_cli-redis-1  Creating
 Container docker_services_cli-postgresql-1  Created
 Container docker_services_cli-rabbitmq-1  Created
 Container docker_services_cli-redis-1  Created
 Container docker_services_cli-opensearch-1  Created
 Container docker_services_cli-postgresql-1  Starting
 Container docker_services_cli-rabbitmq-1  Starting
 Container docker_services_cli-opensearch-1  Starting
 Container docker_services_cli-redis-1  Starting
 Container docker_services_cli-redis-1  Started
 Container docker_services_cli-postgresql-1  Started
 Container docker_services_cli-rabbitmq-1  Started
 Container docker_services_cli-opensearch-1  Started
============================= test session starts ==============================
platform linux -- Python 3.14.2, pytest-8.4.2, pluggy-1.6.0
rootdir: /home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-users-resources/original
configfile: setup.cfg
testpaths: docs, tests, invenio_users_resources
plugins: isort-4.0.0, flask-1.3.0, black-ng-0.4.1, invenio-3.4.2, github-actions-annotate-failures-0.3.0, pydocstyle-2.4.0, cov-7.0.0, pycodestyle-2.5.0
collected 96 items
tests/resources/test_resources_domains.py 
                     [ 10%]
tests/resources/test_resources_groups.py 
                               [ 11%]
tests/resources/test_resources_users.py ::error file=workdir/tests/invenio-users-resources/original/tests/resources/test_resources_users.py,line=23::test_read_self_serialization%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-users-resources/original/tests/resources/test_resources_users.py,line=91::test_read_logged_in_serialization[pub]%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-users-resources/original/tests/resources/test_resources_users.py,line=91::test_read_logged_in_serialization[pubres]%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-users-resources/original/tests/resources/test_resources_users.py,line=161::test_create_user%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-users-resources/original/tests/resources/test_resources_users.py,line=183::test_approve_user%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-users-resources/original/tests/resources/test_resources_users.py,line=198::test_block_user%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-users-resources/original/tests/resources/test_resources_users.py,line=216::test_deactivate_user%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-users-resources/original/tests/resources/test_resources_users.py,line=238::test_impersonate_user%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-users-resources/original/tests/resources/test_resources_users.py,line=282::test_admin_links[admin_records_html-/administration/records?q=parent.access.owned_by.user:{id}&f=allversions]%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-users-resources/original/tests/resources/test_resources_users.py,line=282::test_admin_links[admin_drafts_html-/administration/drafts?q=parent.access.owned_by.user:{id}&f=allversions]%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-users-resources/original/tests/resources/test_resources_users.py,line=282::test_admin_links[admin_moderation_html-/administration/moderation?q=topic.user:{id}]%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-users-resources/original/tests/resources/test_resources_users.py,line=304::test_admin_links_visibility[user_moderator-True]%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-users-resources/original/tests/resources/test_resources_users.py,line=304::test_admin_links_visibility[pub-False]%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-users-resources/original/tests/resources/test_resources_users.py,line=304::test_admin_links_visibility[res-False]%0A%0AKeyError: 'identity'
F
              [ 31%]
tests/services/test_generators.py 
                                      [ 32%]
tests/services/test_service_groups.py 
                          [ 41%]
tests/services/test_service_tasks_domains.py 
                          [ 43%]
tests/services/users/test_service_users.py ::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_service_users.py,line=44::test_search_restricted%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_service_users.py,line=50::test_search_public_users%0A%0AKeyError: 'identity'
F::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_service_users.py,line=74::test_admin_search_field[affiliations:CERN]%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_service_users.py,line=74::test_admin_search_field[affiliation:CERN]%0A%0AKeyError: 'identity'
F::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_service_users.py,line=74::test_admin_search_field[name:Jose affiliation:CERN]%0A%0AKeyError: 'identity'
F::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_service_users.py,line=74::test_admin_search_field[+name:Jose +affiliation:CERN]%0A%0AKeyError: 'identity'
F::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_service_users.py,line=74::test_admin_search_field[CERN]%0A%0AKeyError: 'identity'
F::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_service_users.py,line=74::test_admin_search_field[Tim]%0A%0AKeyError: 'identity'
F::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_service_users.py,line=74::test_admin_search_field[Tim CERN]%0A%0AKeyError: 'identity'
F::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_service_users.py,line=74::test_admin_search_field[Jose]%0A%0AKeyError: 'identity'
F::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_service_users.py,line=74::test_admin_search_field[Jos]%0A%0AKeyError: 'identity'
F::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_service_users.py,line=74::test_admin_search_field[Jose CERN]%0A%0AKeyError: 'identity'
F::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_service_users.py,line=74::test_admin_search_field[email:pub@inveniosoftware.org]%0A%0AKeyError: 'identity'
F::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_service_users.py,line=74::test_admin_search_field[username:pub]%0A%0AKeyError: 'identity'
F........::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_service_users.py,line=114::test_user_search_field[CERN]%0A%0AKeyError: 'identity'
F::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_service_users.py,line=114::test_user_search_field[Jose CERN]%0A%0AKeyError: 'identity'
F::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_service_users.py,line=114::test_user_search_field[Jose AND CERN]%0A%0AKeyError: 'identity'
F::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_service_users.py,line=114::test_user_search_field[Tim]%0A%0AKeyError: 'identity'
F::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_service_users.py,line=114::test_user_search_field[Tim CERN]%0A%0AKeyError: 'identity'
F::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_service_users.py,line=114::test_user_search_field[Jose]%0A%0AKeyError: 'identity'
F::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_service_users.py,line=114::test_user_search_field[Jos]%0A%0AKeyError: 'identity'
F [ 73%]
::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_service_users.py,line=114::test_user_search_field[pub@inveniosoftware.org]%0A%0AKeyError: 'identity'
F::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_service_users.py,line=114::test_user_search_field[pub]%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_service_users.py,line=144::test_read_with_logged_in%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_service_users.py,line=179::test_read_self[pub]%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_service_users.py,line=179::test_read_self[pubres]%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_service_users.py,line=179::test_read_self[res]%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_service_users.py,line=229::test_create_user%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_service_users.py,line=303::test_create_user_errors%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_service_users.py,line=327::test_block%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_service_users.py,line=358::test_approve%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_service_users.py,line=377::test_deactivate%0A%0AKeyError: 'identity'
F
::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_service_users.py,line=406::test_restore%0A%0AKeyError: 'identity'
F
                                                         [ 90%]
tests/services/users/test_user_moderation.py 
::error file=workdir/tests/invenio-users-resources/original/tests/services/users/test_user_moderation.py,line=74::test_moderation_callbacks_failure%0A%0AKeyError: 'identity'
F
                       [ 95%]
tests/test_invenio_users_resources.py ..                                 [ 97%]
tests/test_notifications.py 
                                           [100%]
=================================== FAILURES ===================================
_________________________ test_read_self_serialization _________________________
client = <FlaskClient <Flask 'invenio'>>
headers = {'accept': 'application/json', 'content-type': 'application/json'}
users = {'accented': <pytest_invenio.user.UserFixtureBase object at 0x7f7e182d8e90>, 'inactive': <pytest_invenio.user.UserFixt...object at 0x7f7e182d8590>, 'notification_enabled': <pytest_invenio.user.UserFixtureBase object at 0x7f7e182d8110>, ...}
user_pub = <pytest_invenio.user.UserFixtureBase object at 0x7f7e1833b590>
    def test_read_self_serialization(client, headers, users, user_pub):
        """Read self user."""
        client = user_pub.login(client)
>       r = client.get(f"/users/{user_pub.id}", headers=headers)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/resources/test_resources_users.py:23: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/werkzeug/test.py:1162: in get
    return self.open(*args, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/testing.py:235: in open
    response = super().open(
venv/lib/python3.14/site-packages/werkzeug/test.py:1116: in open
    response_parts = self.run_wsgi_app(request.environ, buffered=buffered)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:988: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:1264: in run_wsgi_app
    app_rv = app(environ, start_response)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1536: in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1514: in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1511: in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:919: in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:917: in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:902: in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/resources.py:65: in view
    return view_meth()
           ^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/content_negotiation.py:116: in inner_content_negotiation
    return f(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:51: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/responses.py:39: in inner
    res = f(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^
invenio_users_resources/resources/users/resource.py:105: in read
    return item.to_dict(), 200
           ^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:81: in to_dict
    res = self.data
          ^^^^^^^^^
invenio_users_resources/services/users/results.py:61: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 2, 'version_id': 2, 'email': 'pub@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'usern...etime.datetime(2026, 2, 17, 10, 4, 22, 381055), 'current_login_at': datetime.datetime(2026, 2, 17, 10, 4, 22, 380261)}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
____________________ test_read_logged_in_serialization[pub] ____________________
client = <FlaskClient <Flask 'invenio'>>
headers = {'accept': 'application/json', 'content-type': 'application/json'}
users = {'accented': <pytest_invenio.user.UserFixtureBase object at 0x7f7e182d8e90>, 'inactive': <pytest_invenio.user.UserFixt...object at 0x7f7e182d8590>, 'notification_enabled': <pytest_invenio.user.UserFixtureBase object at 0x7f7e182d8110>, ...}
user_accented = <pytest_invenio.user.UserFixtureBase object at 0x7f7e182d8e90>
username = 'pub'
    @pytest.mark.parametrize(
        "username",
        ["pub", "pubres", "res"],
    )
    def test_read_logged_in_serialization(client, headers, users, user_accented, username):
        """Read user profile/email as logged in."""
        # login as random non-admin user
        client = user_accented.login(client)
        u = users[username]
        is_visibility_public = u.user.preferences["visibility"] != "restricted"
        is_email_public = u.user.preferences["email_visibility"] != "restricted"
        # when profile is restricted, it should return 404 to hide the existence/non-existence of the user
        expected_status_code = 200 if is_visibility_public or is_email_public else 404
>       r = client.get(f"/users/{u.id}", headers=headers)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/resources/test_resources_users.py:91: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/werkzeug/test.py:1162: in get
    return self.open(*args, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/testing.py:235: in open
    response = super().open(
venv/lib/python3.14/site-packages/werkzeug/test.py:1116: in open
    response_parts = self.run_wsgi_app(request.environ, buffered=buffered)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:988: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:1264: in run_wsgi_app
    app_rv = app(environ, start_response)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1536: in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1514: in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1511: in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:919: in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:917: in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:902: in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/resources.py:65: in view
    return view_meth()
           ^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/content_negotiation.py:116: in inner_content_negotiation
    return f(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:51: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/responses.py:39: in inner
    res = f(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^
invenio_users_resources/resources/users/resource.py:105: in read
    return item.to_dict(), 200
           ^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:81: in to_dict
    res = self.data
          ^^^^^^^^^
invenio_users_resources/services/users/results.py:61: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 2, 'version_id': 2, 'email': 'pub@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'usern...etime.datetime(2026, 2, 17, 10, 4, 22, 381055), 'current_login_at': datetime.datetime(2026, 2, 17, 10, 4, 22, 380261)}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
__________________ test_read_logged_in_serialization[pubres] ___________________
client = <FlaskClient <Flask 'invenio'>>
headers = {'accept': 'application/json', 'content-type': 'application/json'}
users = {'accented': <pytest_invenio.user.UserFixtureBase object at 0x7f7e182d8e90>, 'inactive': <pytest_invenio.user.UserFixt...object at 0x7f7e182d8590>, 'notification_enabled': <pytest_invenio.user.UserFixtureBase object at 0x7f7e182d8110>, ...}
user_accented = <pytest_invenio.user.UserFixtureBase object at 0x7f7e182d8e90>
username = 'pubres'
    @pytest.mark.parametrize(
        "username",
        ["pub", "pubres", "res"],
    )
    def test_read_logged_in_serialization(client, headers, users, user_accented, username):
        """Read user profile/email as logged in."""
        # login as random non-admin user
        client = user_accented.login(client)
        u = users[username]
        is_visibility_public = u.user.preferences["visibility"] != "restricted"
        is_email_public = u.user.preferences["email_visibility"] != "restricted"
        # when profile is restricted, it should return 404 to hide the existence/non-existence of the user
        expected_status_code = 200 if is_visibility_public or is_email_public else 404
>       r = client.get(f"/users/{u.id}", headers=headers)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/resources/test_resources_users.py:91: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/werkzeug/test.py:1162: in get
    return self.open(*args, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/testing.py:235: in open
    response = super().open(
venv/lib/python3.14/site-packages/werkzeug/test.py:1116: in open
    response_parts = self.run_wsgi_app(request.environ, buffered=buffered)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:988: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:1264: in run_wsgi_app
    app_rv = app(environ, start_response)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1536: in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1514: in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1511: in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:919: in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:917: in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:902: in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/resources.py:65: in view
    return view_meth()
           ^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/content_negotiation.py:116: in inner_content_negotiation
    return f(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:51: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/responses.py:39: in inner
    res = f(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^
invenio_users_resources/resources/users/resource.py:105: in read
    return item.to_dict(), 200
           ^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:81: in to_dict
    res = self.data
          ^^^^^^^^^
invenio_users_resources/services/users/results.py:61: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 1, 'version_id': 1, 'email': 'pubres@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'us...2026, 2, 17, 10, 4, 22, 55759), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 22, 55764), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
_______________________________ test_create_user _______________________________
client = <FlaskClient <Flask 'invenio'>>
headers = {'accept': 'application/json', 'content-type': 'application/json'}
user_moderator = <pytest_invenio.user.UserFixtureBase object at 0x7f7e182d8a10>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>
    def test_create_user(client, headers, user_moderator, db):
        """Tests create user."""
        client = user_moderator.login(client)
>       res = client.post(
            "/users",
            json={
                "username": "newuser",
                "email": "newuser@inveniosoftware.org",
            },
            headers=headers,
        )
tests/resources/test_resources_users.py:161: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/werkzeug/test.py:1167: in post
    return self.open(*args, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/testing.py:235: in open
    response = super().open(
venv/lib/python3.14/site-packages/werkzeug/test.py:1116: in open
    response_parts = self.run_wsgi_app(request.environ, buffered=buffered)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:988: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:1264: in run_wsgi_app
    app_rv = app(environ, start_response)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1536: in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1514: in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1511: in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:919: in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:917: in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:902: in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/resources.py:65: in view
    return view_meth()
           ^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/content_negotiation.py:116: in inner_content_negotiation
    return f(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:51: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:90: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/responses.py:39: in inner
    res = f(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^
invenio_users_resources/resources/users/resource.py:192: in create
    return item.to_dict(), 201
           ^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:81: in to_dict
    res = self.data
          ^^^^^^^^^
invenio_users_resources/services/users/results.py:61: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 10, 'version_id': 1, 'email': 'newuser@inveniosoftware.org', 'domain': 'inveniosoftware.org', '...26, 2, 17, 10, 4, 23, 181051), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 23, 181055), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
----------------------------- Captured stdout call -----------------------------
Content-Type: multipart/mixed; boundary="===============0035620680786011695=="
MIME-Version: 1.0
Subject: Password reset instructions
From: no-reply@localhost
To: newuser@inveniosoftware.org
Date: Tue, 17 Feb 2026 10:04:23 +0000
Message-ID: <177132266358.5722.9802696569668425317@runnervmjduv7.dtyrjvhj1jdubpegzc4liecpve.ex.internal.cloudapp.net>
--===============0035620680786011695==
Content-Type: multipart/alternative; boundary="===============6622005411483162751=="
MIME-Version: 1.0
--===============6622005411483162751==
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Your new account has been created
Click the link below to create a new password:
http://localhost/lost-password/WyIxMCIsIiQ1JHJvdW5kcz01MzUwMDAkdC5WR1RnZXA0MGVxT0ZKUSR2N1VYRnJwWnZiY3BqcDk2Wk4xSUZqTExta1VIS2t4TVpNZ09BdmZQTjgyIl0.aZQ9Jw.QZIz4lZsgpqnGko8ivIW3OS065g
--===============6622005411483162751==
Content-Type: text/html; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
<p>Your new account has been created</p>
<p>
  <a href="http://localhost/lost-password/WyIxMCIsIiQ1JHJvdW5kcz01MzUwMDAkdC5WR1RnZXA0MGVxT0ZKUSR2N1VYRnJwWnZiY3BqcDk2Wk4xSUZqTExta1VIS2t4TVpNZ09BdmZQTjgyIl0.aZQ9Jw.QZIz4lZsgpqnGko8ivIW3OS065g">Click here to create a new password</a>
</p>
--===============6622005411483162751==--
--===============0035620680786011695==--
______________________________ test_approve_user _______________________________
client = <FlaskClient <Flask 'invenio'>>
headers = {'accept': 'application/json', 'content-type': 'application/json'}
user_pub = <pytest_invenio.user.UserFixtureBase object at 0x7f7e1833b590>
user_moderator = <pytest_invenio.user.UserFixtureBase object at 0x7f7e182d8a10>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>
    def test_approve_user(client, headers, user_pub, user_moderator, db):
        """Tests approve user endpoint."""
        client = user_moderator.login(client)
        res = client.post(f"/users/{user_pub.id}/approve", headers=headers)
        assert res.status_code == 200
>       res = client.get(f"/users/{user_pub.id}")
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/resources/test_resources_users.py:183: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/werkzeug/test.py:1162: in get
    return self.open(*args, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/testing.py:235: in open
    response = super().open(
venv/lib/python3.14/site-packages/werkzeug/test.py:1116: in open
    response_parts = self.run_wsgi_app(request.environ, buffered=buffered)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:988: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:1264: in run_wsgi_app
    app_rv = app(environ, start_response)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1536: in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1514: in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1511: in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:919: in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:917: in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:902: in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/resources.py:65: in view
    return view_meth()
           ^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/content_negotiation.py:116: in inner_content_negotiation
    return f(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:51: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/responses.py:39: in inner
    res = f(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^
invenio_users_resources/resources/users/resource.py:105: in read
    return item.to_dict(), 200
           ^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:81: in to_dict
    res = self.data
          ^^^^^^^^^
invenio_users_resources/services/users/results.py:61: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 2, 'version_id': 3, 'email': 'pub@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'usern...etime.datetime(2026, 2, 17, 10, 4, 23, 771343), 'current_login_at': datetime.datetime(2026, 2, 17, 10, 4, 22, 380261)}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
_______________________________ test_block_user ________________________________
client = <FlaskClient <Flask 'invenio'>>
headers = {'accept': 'application/json', 'content-type': 'application/json'}
user_pub = <pytest_invenio.user.UserFixtureBase object at 0x7f7e1833b590>
user_moderator = <pytest_invenio.user.UserFixtureBase object at 0x7f7e182d8a10>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>
    def test_block_user(client, headers, user_pub, user_moderator, db):
        """Tests block user endpoint."""
        client = user_moderator.login(client)
        res = client.post(f"/users/{user_pub.id}/block", headers=headers)
        assert res.status_code == 200
>       res = client.get(f"/users/{user_pub.id}")
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/resources/test_resources_users.py:198: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/werkzeug/test.py:1162: in get
    return self.open(*args, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/testing.py:235: in open
    response = super().open(
venv/lib/python3.14/site-packages/werkzeug/test.py:1116: in open
    response_parts = self.run_wsgi_app(request.environ, buffered=buffered)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:988: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:1264: in run_wsgi_app
    app_rv = app(environ, start_response)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1536: in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1514: in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1511: in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:919: in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:917: in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:902: in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/resources.py:65: in view
    return view_meth()
           ^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/content_negotiation.py:116: in inner_content_negotiation
    return f(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:51: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/responses.py:39: in inner
    res = f(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^
invenio_users_resources/resources/users/resource.py:105: in read
    return item.to_dict(), 200
           ^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:81: in to_dict
    res = self.data
          ^^^^^^^^^
invenio_users_resources/services/users/results.py:61: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 2, 'version_id': 3, 'email': 'pub@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'usern...etime.datetime(2026, 2, 17, 10, 4, 23, 974595), 'current_login_at': datetime.datetime(2026, 2, 17, 10, 4, 22, 380261)}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
_____________________________ test_deactivate_user _____________________________
client = <FlaskClient <Flask 'invenio'>>
headers = {'accept': 'application/json', 'content-type': 'application/json'}
user_pub = <pytest_invenio.user.UserFixtureBase object at 0x7f7e1833b590>
user_moderator = <pytest_invenio.user.UserFixtureBase object at 0x7f7e182d8a10>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>
    def test_deactivate_user(client, headers, user_pub, user_moderator, db):
        """Tests deactivate user endpoint."""
        client = user_moderator.login(client)
        res = client.post(f"/users/{user_pub.id}/deactivate", headers=headers)
        assert res.status_code == 200
>       res = client.get(f"/users/{user_pub.id}")
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/resources/test_resources_users.py:216: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/werkzeug/test.py:1162: in get
    return self.open(*args, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/testing.py:235: in open
    response = super().open(
venv/lib/python3.14/site-packages/werkzeug/test.py:1116: in open
    response_parts = self.run_wsgi_app(request.environ, buffered=buffered)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:988: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:1264: in run_wsgi_app
    app_rv = app(environ, start_response)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1536: in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1514: in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1511: in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:919: in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:917: in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:902: in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/resources.py:65: in view
    return view_meth()
           ^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/content_negotiation.py:116: in inner_content_negotiation
    return f(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:51: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/responses.py:39: in inner
    res = f(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^
invenio_users_resources/resources/users/resource.py:105: in read
    return item.to_dict(), 200
           ^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:81: in to_dict
    res = self.data
          ^^^^^^^^^
invenio_users_resources/services/users/results.py:61: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 2, 'version_id': 3, 'email': 'pub@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'usern...etime.datetime(2026, 2, 17, 10, 4, 24, 185732), 'current_login_at': datetime.datetime(2026, 2, 17, 10, 4, 22, 380261)}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
____________________________ test_impersonate_user _____________________________
client = <FlaskClient <Flask 'invenio'>>
headers = {'accept': 'application/json', 'content-type': 'application/json'}
user_pub = <pytest_invenio.user.UserFixtureBase object at 0x7f7e1833b590>
user_moderator = <pytest_invenio.user.UserFixtureBase object at 0x7f7e182d8a10>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>
    def test_impersonate_user(client, headers, user_pub, user_moderator, db):
        """Tests user impersonation endpoint."""
        client = user_moderator.login(client)
>       res = client.get(f"/users/{user_moderator.id}")
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/resources/test_resources_users.py:238: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/werkzeug/test.py:1162: in get
    return self.open(*args, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/testing.py:235: in open
    response = super().open(
venv/lib/python3.14/site-packages/werkzeug/test.py:1116: in open
    response_parts = self.run_wsgi_app(request.environ, buffered=buffered)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:988: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:1264: in run_wsgi_app
    app_rv = app(environ, start_response)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1536: in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1514: in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1511: in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:919: in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:917: in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:902: in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/resources.py:65: in view
    return view_meth()
           ^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/content_negotiation.py:116: in inner_content_negotiation
    return f(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:51: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/responses.py:39: in inner
    res = f(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^
invenio_users_resources/resources/users/resource.py:105: in read
    return item.to_dict(), 200
           ^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:81: in to_dict
    res = self.data
          ^^^^^^^^^
invenio_users_resources/services/users/results.py:61: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 8, 'version_id': 3, 'email': 'user_moderator@inveniosoftware.org', 'domain': 'inveniosoftware.o...etime.datetime(2026, 2, 17, 10, 4, 24, 438287), 'current_login_at': datetime.datetime(2026, 2, 17, 10, 4, 24, 437677)}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
_ test_admin_links[admin_records_html-/administration/records?q=parent.access.owned_by.user:{id}&f=allversions] _
client = <FlaskClient <Flask 'invenio'>>
headers = {'accept': 'application/json', 'content-type': 'application/json'}
user_moderator = <pytest_invenio.user.UserFixtureBase object at 0x7f7e182d8a10>
user_pub = <pytest_invenio.user.UserFixtureBase object at 0x7f7e1833b590>
link_name = 'admin_records_html'
expected_url = '/administration/records?q=parent.access.owned_by.user:{id}&f=allversions'
    @pytest.mark.parametrize(
        "link_name,expected_url",
        [
            (
                "admin_records_html",
                "/administration/records?q=parent.access.owned_by.user:{id}&f=allversions",
            ),
            (
                "admin_drafts_html",
                "/administration/drafts?q=parent.access.owned_by.user:{id}&f=allversions",
            ),
            ("admin_moderation_html", "/administration/moderation?q=topic.user:{id}"),
        ],
    )
    def test_admin_links(
        client, headers, user_moderator, user_pub, link_name, expected_url
    ):
        """Test admin links."""
        client = user_moderator.login(client)
>       res = client.get(f"/users/{user_pub.id}", headers=headers)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/resources/test_resources_users.py:282: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/werkzeug/test.py:1162: in get
    return self.open(*args, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/testing.py:235: in open
    response = super().open(
venv/lib/python3.14/site-packages/werkzeug/test.py:1116: in open
    response_parts = self.run_wsgi_app(request.environ, buffered=buffered)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:988: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:1264: in run_wsgi_app
    app_rv = app(environ, start_response)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1536: in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1514: in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1511: in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:919: in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:917: in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:902: in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/resources.py:65: in view
    return view_meth()
           ^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/content_negotiation.py:116: in inner_content_negotiation
    return f(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:51: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/responses.py:39: in inner
    res = f(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^
invenio_users_resources/resources/users/resource.py:105: in read
    return item.to_dict(), 200
           ^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:81: in to_dict
    res = self.data
          ^^^^^^^^^
invenio_users_resources/services/users/results.py:61: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 2, 'version_id': 2, 'email': 'pub@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'usern...etime.datetime(2026, 2, 17, 10, 4, 22, 381055), 'current_login_at': datetime.datetime(2026, 2, 17, 10, 4, 22, 380261)}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
_ test_admin_links[admin_drafts_html-/administration/drafts?q=parent.access.owned_by.user:{id}&f=allversions] _
client = <FlaskClient <Flask 'invenio'>>
headers = {'accept': 'application/json', 'content-type': 'application/json'}
user_moderator = <pytest_invenio.user.UserFixtureBase object at 0x7f7e182d8a10>
user_pub = <pytest_invenio.user.UserFixtureBase object at 0x7f7e1833b590>
link_name = 'admin_drafts_html'
expected_url = '/administration/drafts?q=parent.access.owned_by.user:{id}&f=allversions'
    @pytest.mark.parametrize(
        "link_name,expected_url",
        [
            (
                "admin_records_html",
                "/administration/records?q=parent.access.owned_by.user:{id}&f=allversions",
            ),
            (
                "admin_drafts_html",
                "/administration/drafts?q=parent.access.owned_by.user:{id}&f=allversions",
            ),
            ("admin_moderation_html", "/administration/moderation?q=topic.user:{id}"),
        ],
    )
    def test_admin_links(
        client, headers, user_moderator, user_pub, link_name, expected_url
    ):
        """Test admin links."""
        client = user_moderator.login(client)
>       res = client.get(f"/users/{user_pub.id}", headers=headers)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/resources/test_resources_users.py:282: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/werkzeug/test.py:1162: in get
    return self.open(*args, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/testing.py:235: in open
    response = super().open(
venv/lib/python3.14/site-packages/werkzeug/test.py:1116: in open
    response_parts = self.run_wsgi_app(request.environ, buffered=buffered)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:988: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:1264: in run_wsgi_app
    app_rv = app(environ, start_response)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1536: in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1514: in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1511: in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:919: in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:917: in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:902: in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/resources.py:65: in view
    return view_meth()
           ^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/content_negotiation.py:116: in inner_content_negotiation
    return f(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:51: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/responses.py:39: in inner
    res = f(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^
invenio_users_resources/resources/users/resource.py:105: in read
    return item.to_dict(), 200
           ^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:81: in to_dict
    res = self.data
          ^^^^^^^^^
invenio_users_resources/services/users/results.py:61: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 2, 'version_id': 2, 'email': 'pub@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'usern...etime.datetime(2026, 2, 17, 10, 4, 22, 381055), 'current_login_at': datetime.datetime(2026, 2, 17, 10, 4, 22, 380261)}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
_ test_admin_links[admin_moderation_html-/administration/moderation?q=topic.user:{id}] _
client = <FlaskClient <Flask 'invenio'>>
headers = {'accept': 'application/json', 'content-type': 'application/json'}
user_moderator = <pytest_invenio.user.UserFixtureBase object at 0x7f7e182d8a10>
user_pub = <pytest_invenio.user.UserFixtureBase object at 0x7f7e1833b590>
link_name = 'admin_moderation_html'
expected_url = '/administration/moderation?q=topic.user:{id}'
    @pytest.mark.parametrize(
        "link_name,expected_url",
        [
            (
                "admin_records_html",
                "/administration/records?q=parent.access.owned_by.user:{id}&f=allversions",
            ),
            (
                "admin_drafts_html",
                "/administration/drafts?q=parent.access.owned_by.user:{id}&f=allversions",
            ),
            ("admin_moderation_html", "/administration/moderation?q=topic.user:{id}"),
        ],
    )
    def test_admin_links(
        client, headers, user_moderator, user_pub, link_name, expected_url
    ):
        """Test admin links."""
        client = user_moderator.login(client)
>       res = client.get(f"/users/{user_pub.id}", headers=headers)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/resources/test_resources_users.py:282: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/werkzeug/test.py:1162: in get
    return self.open(*args, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/testing.py:235: in open
    response = super().open(
venv/lib/python3.14/site-packages/werkzeug/test.py:1116: in open
    response_parts = self.run_wsgi_app(request.environ, buffered=buffered)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:988: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:1264: in run_wsgi_app
    app_rv = app(environ, start_response)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1536: in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1514: in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1511: in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:919: in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:917: in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:902: in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/resources.py:65: in view
    return view_meth()
           ^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/content_negotiation.py:116: in inner_content_negotiation
    return f(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:51: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/responses.py:39: in inner
    res = f(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^
invenio_users_resources/resources/users/resource.py:105: in read
    return item.to_dict(), 200
           ^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:81: in to_dict
    res = self.data
          ^^^^^^^^^
invenio_users_resources/services/users/results.py:61: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 2, 'version_id': 2, 'email': 'pub@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'usern...etime.datetime(2026, 2, 17, 10, 4, 22, 381055), 'current_login_at': datetime.datetime(2026, 2, 17, 10, 4, 22, 380261)}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
_______________ test_admin_links_visibility[user_moderator-True] _______________
client = <FlaskClient <Flask 'invenio'>>
headers = {'accept': 'application/json', 'content-type': 'application/json'}
users = {'accented': <pytest_invenio.user.UserFixtureBase object at 0x7f7e182d8e90>, 'inactive': <pytest_invenio.user.UserFixt...object at 0x7f7e182d8590>, 'notification_enabled': <pytest_invenio.user.UserFixtureBase object at 0x7f7e182d8110>, ...}
username = 'user_moderator', expected_admin_links = True
    @pytest.mark.parametrize(
        "username,expected_admin_links",
        [
            ("user_moderator", True),  # user_moderator should have admin links
            ("pub", False),  # regular user should not have admin links
            ("res", False),  # regular user should not have admin links
        ],
    )
    def test_admin_links_visibility(client, headers, users, username, expected_admin_links):
        """Test admin links visibility based on user permissions."""
        user = users[username]
        client = user.login(client)
>       res = client.get(f"/users/{user.id}", headers=headers)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/resources/test_resources_users.py:304: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/werkzeug/test.py:1162: in get
    return self.open(*args, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/testing.py:235: in open
    response = super().open(
venv/lib/python3.14/site-packages/werkzeug/test.py:1116: in open
    response_parts = self.run_wsgi_app(request.environ, buffered=buffered)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:988: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:1264: in run_wsgi_app
    app_rv = app(environ, start_response)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1536: in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1514: in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1511: in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:919: in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:917: in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:902: in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/resources.py:65: in view
    return view_meth()
           ^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/content_negotiation.py:116: in inner_content_negotiation
    return f(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:51: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/responses.py:39: in inner
    res = f(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^
invenio_users_resources/resources/users/resource.py:105: in read
    return item.to_dict(), 200
           ^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:81: in to_dict
    res = self.data
          ^^^^^^^^^
invenio_users_resources/services/users/results.py:61: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 8, 'version_id': 3, 'email': 'user_moderator@inveniosoftware.org', 'domain': 'inveniosoftware.o...etime.datetime(2026, 2, 17, 10, 4, 24, 606620), 'current_login_at': datetime.datetime(2026, 2, 17, 10, 4, 25, 154731)}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
____________________ test_admin_links_visibility[pub-False] ____________________
client = <FlaskClient <Flask 'invenio'>>
headers = {'accept': 'application/json', 'content-type': 'application/json'}
users = {'accented': <pytest_invenio.user.UserFixtureBase object at 0x7f7e182d8e90>, 'inactive': <pytest_invenio.user.UserFixt...object at 0x7f7e182d8590>, 'notification_enabled': <pytest_invenio.user.UserFixtureBase object at 0x7f7e182d8110>, ...}
username = 'pub', expected_admin_links = False
    @pytest.mark.parametrize(
        "username,expected_admin_links",
        [
            ("user_moderator", True),  # user_moderator should have admin links
            ("pub", False),  # regular user should not have admin links
            ("res", False),  # regular user should not have admin links
        ],
    )
    def test_admin_links_visibility(client, headers, users, username, expected_admin_links):
        """Test admin links visibility based on user permissions."""
        user = users[username]
        client = user.login(client)
>       res = client.get(f"/users/{user.id}", headers=headers)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/resources/test_resources_users.py:304: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/werkzeug/test.py:1162: in get
    return self.open(*args, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/testing.py:235: in open
    response = super().open(
venv/lib/python3.14/site-packages/werkzeug/test.py:1116: in open
    response_parts = self.run_wsgi_app(request.environ, buffered=buffered)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:988: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:1264: in run_wsgi_app
    app_rv = app(environ, start_response)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1536: in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1514: in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1511: in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:919: in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:917: in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:902: in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/resources.py:65: in view
    return view_meth()
           ^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/content_negotiation.py:116: in inner_content_negotiation
    return f(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:51: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/responses.py:39: in inner
    res = f(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^
invenio_users_resources/resources/users/resource.py:105: in read
    return item.to_dict(), 200
           ^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:81: in to_dict
    res = self.data
          ^^^^^^^^^
invenio_users_resources/services/users/results.py:61: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 2, 'version_id': 2, 'email': 'pub@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'usern...etime.datetime(2026, 2, 17, 10, 4, 22, 381055), 'current_login_at': datetime.datetime(2026, 2, 17, 10, 4, 25, 316561)}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
____________________ test_admin_links_visibility[res-False] ____________________
client = <FlaskClient <Flask 'invenio'>>
headers = {'accept': 'application/json', 'content-type': 'application/json'}
users = {'accented': <pytest_invenio.user.UserFixtureBase object at 0x7f7e182d8e90>, 'inactive': <pytest_invenio.user.UserFixt...object at 0x7f7e182d8590>, 'notification_enabled': <pytest_invenio.user.UserFixtureBase object at 0x7f7e182d8110>, ...}
username = 'res', expected_admin_links = False
    @pytest.mark.parametrize(
        "username,expected_admin_links",
        [
            ("user_moderator", True),  # user_moderator should have admin links
            ("pub", False),  # regular user should not have admin links
            ("res", False),  # regular user should not have admin links
        ],
    )
    def test_admin_links_visibility(client, headers, users, username, expected_admin_links):
        """Test admin links visibility based on user permissions."""
        user = users[username]
        client = user.login(client)
>       res = client.get(f"/users/{user.id}", headers=headers)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/resources/test_resources_users.py:304: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.14/site-packages/werkzeug/test.py:1162: in get
    return self.open(*args, **kw)
           ^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/testing.py:235: in open
    response = super().open(
venv/lib/python3.14/site-packages/werkzeug/test.py:1116: in open
    response_parts = self.run_wsgi_app(request.environ, buffered=buffered)
                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:988: in run_wsgi_app
    rv = run_wsgi_app(self.application, environ, buffered=buffered)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/werkzeug/test.py:1264: in run_wsgi_app
    app_rv = app(environ, start_response)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1536: in __call__
    return self.wsgi_app(environ, start_response)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1514: in wsgi_app
    response = self.handle_exception(e)
               ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:1511: in wsgi_app
    response = self.full_dispatch_request()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:919: in full_dispatch_request
    rv = self.handle_user_exception(e)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:917: in full_dispatch_request
    rv = self.dispatch_request()
         ^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask/app.py:902: in dispatch_request
    return self.ensure_sync(self.view_functions[rule.endpoint])(**view_args)  # type: ignore[no-any-return]
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/resources.py:65: in view
    return view_meth()
           ^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/content_negotiation.py:116: in inner_content_negotiation
    return f(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/parsers/decorators.py:51: in inner
    return f(self, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/flask_resources/responses.py:39: in inner
    res = f(*args, **kwargs)
          ^^^^^^^^^^^^^^^^^^
invenio_users_resources/resources/users/resource.py:105: in read
    return item.to_dict(), 200
           ^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:81: in to_dict
    res = self.data
          ^^^^^^^^^
invenio_users_resources/services/users/results.py:61: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 3, 'version_id': 2, 'email': 'res@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'usern...etime.datetime(2026, 2, 17, 10, 4, 25, 491332), 'current_login_at': datetime.datetime(2026, 2, 17, 10, 4, 25, 490610)}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
____________________________ test_search_restricted ____________________________
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17bed480>
anon_identity = <AnonymousIdentity id="None" auth_type="None" provides={Need(method='system_role', value='any_user')}>
user_pub = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17aa6ed0>
    def test_search_restricted(user_service, anon_identity, user_pub):
        """Only authenticated users can search."""
        # Anon identity
        pytest.raises(
            # TODO: Should be mapped to a 404
            PermissionDeniedError,
            user_service.search,
            anon_identity,
        )
        # Authenticated identity
>       res = user_service.search(user_pub.identity).to_dict()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/services/users/test_service_users.py:44: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:121: in to_dict
    "hits": list(self.hits),
            ^^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:101: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 2, 'version_id': 1, 'email': 'pub@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'usern...26, 2, 17, 10, 4, 30, 434500), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 30, 434503), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
___________________________ test_search_public_users ___________________________
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17bed480>
user_pub = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17aa6ed0>
    def test_search_public_users(user_service, user_pub):
        """Only public users are shown in search."""
>       res = user_service.search(user_pub.identity).to_dict()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/services/users/test_service_users.py:50: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:121: in to_dict
    "hits": list(self.hits),
            ^^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:101: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 2, 'version_id': 1, 'email': 'pub@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'usern...26, 2, 17, 10, 4, 30, 434500), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 30, 434503), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
__________________ test_admin_search_field[affiliations:CERN] __________________
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17bed480>
user_moderator = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17904350>
query = 'affiliations:CERN'
    @pytest.mark.parametrize(
        "query",
        [
            "affiliations:CERN",
            "affiliation:CERN",
            "name:Jose affiliation:CERN",
            "+name:Jose +affiliation:CERN",
            "CERN",
            "Tim",
            "Tim CERN",
            "Jose",
            "Jos",
            "Jose CERN",
            "email:pub@inveniosoftware.org",
            "username:pub",
        ],
    )
    def test_admin_search_field(user_service, user_moderator, query):
        """Make sure certain fields ARE searchable."""
>       res = user_service.search_all(user_moderator.identity, q=query).to_dict()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/services/users/test_service_users.py:74: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:121: in to_dict
    "hits": list(self.hits),
            ^^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:101: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 1, 'version_id': 1, 'email': 'pubres@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'us...26, 2, 17, 10, 4, 30, 404931), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 30, 404936), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
__________________ test_admin_search_field[affiliation:CERN] ___________________
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17bed480>
user_moderator = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17904350>
query = 'affiliation:CERN'
    @pytest.mark.parametrize(
        "query",
        [
            "affiliations:CERN",
            "affiliation:CERN",
            "name:Jose affiliation:CERN",
            "+name:Jose +affiliation:CERN",
            "CERN",
            "Tim",
            "Tim CERN",
            "Jose",
            "Jos",
            "Jose CERN",
            "email:pub@inveniosoftware.org",
            "username:pub",
        ],
    )
    def test_admin_search_field(user_service, user_moderator, query):
        """Make sure certain fields ARE searchable."""
>       res = user_service.search_all(user_moderator.identity, q=query).to_dict()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/services/users/test_service_users.py:74: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:121: in to_dict
    "hits": list(self.hits),
            ^^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:101: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 1, 'version_id': 1, 'email': 'pubres@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'us...26, 2, 17, 10, 4, 30, 404931), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 30, 404936), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
_____________ test_admin_search_field[name:Jose affiliation:CERN] ______________
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17bed480>
user_moderator = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17904350>
query = 'name:Jose affiliation:CERN'
    @pytest.mark.parametrize(
        "query",
        [
            "affiliations:CERN",
            "affiliation:CERN",
            "name:Jose affiliation:CERN",
            "+name:Jose +affiliation:CERN",
            "CERN",
            "Tim",
            "Tim CERN",
            "Jose",
            "Jos",
            "Jose CERN",
            "email:pub@inveniosoftware.org",
            "username:pub",
        ],
    )
    def test_admin_search_field(user_service, user_moderator, query):
        """Make sure certain fields ARE searchable."""
>       res = user_service.search_all(user_moderator.identity, q=query).to_dict()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/services/users/test_service_users.py:74: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:121: in to_dict
    "hits": list(self.hits),
            ^^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:101: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 2, 'version_id': 1, 'email': 'pub@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'usern...26, 2, 17, 10, 4, 30, 434500), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 30, 434503), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
____________ test_admin_search_field[+name:Jose +affiliation:CERN] _____________
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17bed480>
user_moderator = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17904350>
query = '+name:Jose +affiliation:CERN'
    @pytest.mark.parametrize(
        "query",
        [
            "affiliations:CERN",
            "affiliation:CERN",
            "name:Jose affiliation:CERN",
            "+name:Jose +affiliation:CERN",
            "CERN",
            "Tim",
            "Tim CERN",
            "Jose",
            "Jos",
            "Jose CERN",
            "email:pub@inveniosoftware.org",
            "username:pub",
        ],
    )
    def test_admin_search_field(user_service, user_moderator, query):
        """Make sure certain fields ARE searchable."""
>       res = user_service.search_all(user_moderator.identity, q=query).to_dict()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/services/users/test_service_users.py:74: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:121: in to_dict
    "hits": list(self.hits),
            ^^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:101: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 2, 'version_id': 1, 'email': 'pub@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'usern...26, 2, 17, 10, 4, 30, 434500), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 30, 434503), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
________________________ test_admin_search_field[CERN] _________________________
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17bed480>
user_moderator = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17904350>
query = 'CERN'
    @pytest.mark.parametrize(
        "query",
        [
            "affiliations:CERN",
            "affiliation:CERN",
            "name:Jose affiliation:CERN",
            "+name:Jose +affiliation:CERN",
            "CERN",
            "Tim",
            "Tim CERN",
            "Jose",
            "Jos",
            "Jose CERN",
            "email:pub@inveniosoftware.org",
            "username:pub",
        ],
    )
    def test_admin_search_field(user_service, user_moderator, query):
        """Make sure certain fields ARE searchable."""
>       res = user_service.search_all(user_moderator.identity, q=query).to_dict()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/services/users/test_service_users.py:74: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:121: in to_dict
    "hits": list(self.hits),
            ^^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:101: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 1, 'version_id': 1, 'email': 'pubres@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'us...26, 2, 17, 10, 4, 30, 404931), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 30, 404936), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
_________________________ test_admin_search_field[Tim] _________________________
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17bed480>
user_moderator = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17904350>
query = 'Tim'
    @pytest.mark.parametrize(
        "query",
        [
            "affiliations:CERN",
            "affiliation:CERN",
            "name:Jose affiliation:CERN",
            "+name:Jose +affiliation:CERN",
            "CERN",
            "Tim",
            "Tim CERN",
            "Jose",
            "Jos",
            "Jose CERN",
            "email:pub@inveniosoftware.org",
            "username:pub",
        ],
    )
    def test_admin_search_field(user_service, user_moderator, query):
        """Make sure certain fields ARE searchable."""
>       res = user_service.search_all(user_moderator.identity, q=query).to_dict()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/services/users/test_service_users.py:74: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:121: in to_dict
    "hits": list(self.hits),
            ^^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:101: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 1, 'version_id': 1, 'email': 'pubres@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'us...26, 2, 17, 10, 4, 30, 404931), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 30, 404936), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
______________________ test_admin_search_field[Tim CERN] _______________________
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17bed480>
user_moderator = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17904350>
query = 'Tim CERN'
    @pytest.mark.parametrize(
        "query",
        [
            "affiliations:CERN",
            "affiliation:CERN",
            "name:Jose affiliation:CERN",
            "+name:Jose +affiliation:CERN",
            "CERN",
            "Tim",
            "Tim CERN",
            "Jose",
            "Jos",
            "Jose CERN",
            "email:pub@inveniosoftware.org",
            "username:pub",
        ],
    )
    def test_admin_search_field(user_service, user_moderator, query):
        """Make sure certain fields ARE searchable."""
>       res = user_service.search_all(user_moderator.identity, q=query).to_dict()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/services/users/test_service_users.py:74: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:121: in to_dict
    "hits": list(self.hits),
            ^^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:101: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 1, 'version_id': 1, 'email': 'pubres@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'us...26, 2, 17, 10, 4, 30, 404931), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 30, 404936), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
________________________ test_admin_search_field[Jose] _________________________
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17bed480>
user_moderator = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17904350>
query = 'Jose'
    @pytest.mark.parametrize(
        "query",
        [
            "affiliations:CERN",
            "affiliation:CERN",
            "name:Jose affiliation:CERN",
            "+name:Jose +affiliation:CERN",
            "CERN",
            "Tim",
            "Tim CERN",
            "Jose",
            "Jos",
            "Jose CERN",
            "email:pub@inveniosoftware.org",
            "username:pub",
        ],
    )
    def test_admin_search_field(user_service, user_moderator, query):
        """Make sure certain fields ARE searchable."""
>       res = user_service.search_all(user_moderator.identity, q=query).to_dict()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/services/users/test_service_users.py:74: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:121: in to_dict
    "hits": list(self.hits),
            ^^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:101: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 2, 'version_id': 1, 'email': 'pub@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'usern...26, 2, 17, 10, 4, 30, 434500), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 30, 434503), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
_________________________ test_admin_search_field[Jos] _________________________
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17bed480>
user_moderator = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17904350>
query = 'Jos'
    @pytest.mark.parametrize(
        "query",
        [
            "affiliations:CERN",
            "affiliation:CERN",
            "name:Jose affiliation:CERN",
            "+name:Jose +affiliation:CERN",
            "CERN",
            "Tim",
            "Tim CERN",
            "Jose",
            "Jos",
            "Jose CERN",
            "email:pub@inveniosoftware.org",
            "username:pub",
        ],
    )
    def test_admin_search_field(user_service, user_moderator, query):
        """Make sure certain fields ARE searchable."""
>       res = user_service.search_all(user_moderator.identity, q=query).to_dict()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/services/users/test_service_users.py:74: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:121: in to_dict
    "hits": list(self.hits),
            ^^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:101: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 2, 'version_id': 1, 'email': 'pub@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'usern...26, 2, 17, 10, 4, 30, 434500), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 30, 434503), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
______________________ test_admin_search_field[Jose CERN] ______________________
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17bed480>
user_moderator = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17904350>
query = 'Jose CERN'
    @pytest.mark.parametrize(
        "query",
        [
            "affiliations:CERN",
            "affiliation:CERN",
            "name:Jose affiliation:CERN",
            "+name:Jose +affiliation:CERN",
            "CERN",
            "Tim",
            "Tim CERN",
            "Jose",
            "Jos",
            "Jose CERN",
            "email:pub@inveniosoftware.org",
            "username:pub",
        ],
    )
    def test_admin_search_field(user_service, user_moderator, query):
        """Make sure certain fields ARE searchable."""
>       res = user_service.search_all(user_moderator.identity, q=query).to_dict()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/services/users/test_service_users.py:74: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:121: in to_dict
    "hits": list(self.hits),
            ^^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:101: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 2, 'version_id': 1, 'email': 'pub@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'usern...26, 2, 17, 10, 4, 30, 434500), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 30, 434503), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
____________ test_admin_search_field[email:pub@inveniosoftware.org] ____________
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17bed480>
user_moderator = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17904350>
query = 'email:pub@inveniosoftware.org'
    @pytest.mark.parametrize(
        "query",
        [
            "affiliations:CERN",
            "affiliation:CERN",
            "name:Jose affiliation:CERN",
            "+name:Jose +affiliation:CERN",
            "CERN",
            "Tim",
            "Tim CERN",
            "Jose",
            "Jos",
            "Jose CERN",
            "email:pub@inveniosoftware.org",
            "username:pub",
        ],
    )
    def test_admin_search_field(user_service, user_moderator, query):
        """Make sure certain fields ARE searchable."""
>       res = user_service.search_all(user_moderator.identity, q=query).to_dict()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/services/users/test_service_users.py:74: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:121: in to_dict
    "hits": list(self.hits),
            ^^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:101: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 2, 'version_id': 1, 'email': 'pub@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'usern...26, 2, 17, 10, 4, 30, 434500), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 30, 434503), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
____________________ test_admin_search_field[username:pub] _____________________
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17bed480>
user_moderator = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17904350>
query = 'username:pub'
    @pytest.mark.parametrize(
        "query",
        [
            "affiliations:CERN",
            "affiliation:CERN",
            "name:Jose affiliation:CERN",
            "+name:Jose +affiliation:CERN",
            "CERN",
            "Tim",
            "Tim CERN",
            "Jose",
            "Jos",
            "Jose CERN",
            "email:pub@inveniosoftware.org",
            "username:pub",
        ],
    )
    def test_admin_search_field(user_service, user_moderator, query):
        """Make sure certain fields ARE searchable."""
>       res = user_service.search_all(user_moderator.identity, q=query).to_dict()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/services/users/test_service_users.py:74: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:121: in to_dict
    "hits": list(self.hits),
            ^^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:101: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 1, 'version_id': 1, 'email': 'pubres@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'us...26, 2, 17, 10, 4, 30, 404931), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 30, 404936), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
_________________________ test_user_search_field[CERN] _________________________
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17bed480>
user_pub = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17aa6ed0>
query = 'CERN'
    @pytest.mark.parametrize(
        "query",
        [
            "CERN",
            "Jose CERN",
            "Jose AND CERN",
            "Tim",
            "Tim CERN",
            "Jose",
            "Jos",
            "pub@inveniosoftware.org",
            "pub",
        ],
    )
    def test_user_search_field(user_service, user_pub, query):
        """Make sure certain fields ARE searchable."""
>       res = user_service.search(user_pub.identity, suggest=query).to_dict()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/services/users/test_service_users.py:114: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:121: in to_dict
    "hits": list(self.hits),
            ^^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:101: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 1, 'version_id': 1, 'email': 'pubres@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'us...26, 2, 17, 10, 4, 30, 404931), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 30, 404936), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
______________________ test_user_search_field[Jose CERN] _______________________
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17bed480>
user_pub = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17aa6ed0>
query = 'Jose CERN'
    @pytest.mark.parametrize(
        "query",
        [
            "CERN",
            "Jose CERN",
            "Jose AND CERN",
            "Tim",
            "Tim CERN",
            "Jose",
            "Jos",
            "pub@inveniosoftware.org",
            "pub",
        ],
    )
    def test_user_search_field(user_service, user_pub, query):
        """Make sure certain fields ARE searchable."""
>       res = user_service.search(user_pub.identity, suggest=query).to_dict()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/services/users/test_service_users.py:114: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:121: in to_dict
    "hits": list(self.hits),
            ^^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:101: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 2, 'version_id': 1, 'email': 'pub@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'usern...26, 2, 17, 10, 4, 30, 434500), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 30, 434503), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
____________________ test_user_search_field[Jose AND CERN] _____________________
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17bed480>
user_pub = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17aa6ed0>
query = 'Jose AND CERN'
    @pytest.mark.parametrize(
        "query",
        [
            "CERN",
            "Jose CERN",
            "Jose AND CERN",
            "Tim",
            "Tim CERN",
            "Jose",
            "Jos",
            "pub@inveniosoftware.org",
            "pub",
        ],
    )
    def test_user_search_field(user_service, user_pub, query):
        """Make sure certain fields ARE searchable."""
>       res = user_service.search(user_pub.identity, suggest=query).to_dict()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/services/users/test_service_users.py:114: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:121: in to_dict
    "hits": list(self.hits),
            ^^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:101: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 2, 'version_id': 1, 'email': 'pub@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'usern...26, 2, 17, 10, 4, 30, 434500), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 30, 434503), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
_________________________ test_user_search_field[Tim] __________________________
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17bed480>
user_pub = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17aa6ed0>
query = 'Tim'
    @pytest.mark.parametrize(
        "query",
        [
            "CERN",
            "Jose CERN",
            "Jose AND CERN",
            "Tim",
            "Tim CERN",
            "Jose",
            "Jos",
            "pub@inveniosoftware.org",
            "pub",
        ],
    )
    def test_user_search_field(user_service, user_pub, query):
        """Make sure certain fields ARE searchable."""
>       res = user_service.search(user_pub.identity, suggest=query).to_dict()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/services/users/test_service_users.py:114: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:121: in to_dict
    "hits": list(self.hits),
            ^^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:101: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 1, 'version_id': 1, 'email': 'pubres@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'us...26, 2, 17, 10, 4, 30, 404931), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 30, 404936), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
_______________________ test_user_search_field[Tim CERN] _______________________
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17bed480>
user_pub = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17aa6ed0>
query = 'Tim CERN'
    @pytest.mark.parametrize(
        "query",
        [
            "CERN",
            "Jose CERN",
            "Jose AND CERN",
            "Tim",
            "Tim CERN",
            "Jose",
            "Jos",
            "pub@inveniosoftware.org",
            "pub",
        ],
    )
    def test_user_search_field(user_service, user_pub, query):
        """Make sure certain fields ARE searchable."""
>       res = user_service.search(user_pub.identity, suggest=query).to_dict()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/services/users/test_service_users.py:114: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:121: in to_dict
    "hits": list(self.hits),
            ^^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:101: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 1, 'version_id': 1, 'email': 'pubres@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'us...26, 2, 17, 10, 4, 30, 404931), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 30, 404936), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
_________________________ test_user_search_field[Jose] _________________________
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17bed480>
user_pub = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17aa6ed0>
query = 'Jose'
    @pytest.mark.parametrize(
        "query",
        [
            "CERN",
            "Jose CERN",
            "Jose AND CERN",
            "Tim",
            "Tim CERN",
            "Jose",
            "Jos",
            "pub@inveniosoftware.org",
            "pub",
        ],
    )
    def test_user_search_field(user_service, user_pub, query):
        """Make sure certain fields ARE searchable."""
>       res = user_service.search(user_pub.identity, suggest=query).to_dict()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/services/users/test_service_users.py:114: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:121: in to_dict
    "hits": list(self.hits),
            ^^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:101: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 2, 'version_id': 1, 'email': 'pub@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'usern...26, 2, 17, 10, 4, 30, 434500), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 30, 434503), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
_________________________ test_user_search_field[Jos] __________________________
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17bed480>
user_pub = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17aa6ed0>
query = 'Jos'
    @pytest.mark.parametrize(
        "query",
        [
            "CERN",
            "Jose CERN",
            "Jose AND CERN",
            "Tim",
            "Tim CERN",
            "Jose",
            "Jos",
            "pub@inveniosoftware.org",
            "pub",
        ],
    )
    def test_user_search_field(user_service, user_pub, query):
        """Make sure certain fields ARE searchable."""
>       res = user_service.search(user_pub.identity, suggest=query).to_dict()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/services/users/test_service_users.py:114: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:121: in to_dict
    "hits": list(self.hits),
            ^^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:101: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 2, 'version_id': 1, 'email': 'pub@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'usern...26, 2, 17, 10, 4, 30, 434500), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 30, 434503), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
_______________ test_user_search_field[pub@inveniosoftware.org] ________________
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17bed480>
user_pub = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17aa6ed0>
query = 'pub@inveniosoftware.org'
    @pytest.mark.parametrize(
        "query",
        [
            "CERN",
            "Jose CERN",
            "Jose AND CERN",
            "Tim",
            "Tim CERN",
            "Jose",
            "Jos",
            "pub@inveniosoftware.org",
            "pub",
        ],
    )
    def test_user_search_field(user_service, user_pub, query):
        """Make sure certain fields ARE searchable."""
>       res = user_service.search(user_pub.identity, suggest=query).to_dict()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/services/users/test_service_users.py:114: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:121: in to_dict
    "hits": list(self.hits),
            ^^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:101: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 2, 'version_id': 1, 'email': 'pub@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'usern...26, 2, 17, 10, 4, 30, 434500), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 30, 434503), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
_________________________ test_user_search_field[pub] __________________________
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17bed480>
user_pub = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17aa6ed0>
query = 'pub'
    @pytest.mark.parametrize(
        "query",
        [
            "CERN",
            "Jose CERN",
            "Jose AND CERN",
            "Tim",
            "Tim CERN",
            "Jose",
            "Jos",
            "pub@inveniosoftware.org",
            "pub",
        ],
    )
    def test_user_search_field(user_service, user_pub, query):
        """Make sure certain fields ARE searchable."""
>       res = user_service.search(user_pub.identity, suggest=query).to_dict()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/services/users/test_service_users.py:114: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:121: in to_dict
    "hits": list(self.hits),
            ^^^^^^^^^^^^^^^
invenio_users_resources/services/users/results.py:101: in hits
    projection = schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 2, 'version_id': 1, 'email': 'pub@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'usern...26, 2, 17, 10, 4, 30, 434500), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 30, 434503), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
___________________________ test_read_with_logged_in ___________________________
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17bed480>
auth_identity = <function auth_identity.<locals>.make_identity at 0x7f7e1865eae0>
user_accented = <pytest_invenio.user.UserFixtureBase object at 0x7f7e179047d0>
user_pub = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17aa6ed0>
user_pubres = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17aa5b50>
user_res = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17aa71d0>
    def test_read_with_logged_in(
        user_service, auth_identity, user_accented, user_pub, user_pubres, user_res
    ):
        """Logged in users can read public users only."""
        random_identity = auth_identity(user_accented.id)
>       res = user_service.read(random_identity, user_pub.id).to_dict()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/services/users/test_service_users.py:144: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:81: in to_dict
    res = self.data
          ^^^^^^^^^
invenio_users_resources/services/users/results.py:61: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 2, 'version_id': 1, 'email': 'pub@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'usern...26, 2, 17, 10, 4, 30, 434500), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 30, 434503), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
_____________________________ test_read_self[pub] ______________________________
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17bed480>
users = {'accented': <pytest_invenio.user.UserFixtureBase object at 0x7f7e179047d0>, 'inactive': <pytest_invenio.user.UserFixt...object at 0x7f7e17aa7e90>, 'notification_enabled': <pytest_invenio.user.UserFixtureBase object at 0x7f7e17aa7a10>, ...}
username = 'pub'
    @pytest.mark.parametrize(
        "username",
        [
            "pub",
            "pubres",
            "res",
        ],
    )
    def test_read_self(user_service, users, username):
        """Users can read themselves."""
        user = users[username]
>       res = user_service.read(user.identity, user.id).to_dict()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/services/users/test_service_users.py:179: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:81: in to_dict
    res = self.data
          ^^^^^^^^^
invenio_users_resources/services/users/results.py:61: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 2, 'version_id': 1, 'email': 'pub@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'usern...26, 2, 17, 10, 4, 30, 434500), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 30, 434503), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
____________________________ test_read_self[pubres] ____________________________
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17bed480>
users = {'accented': <pytest_invenio.user.UserFixtureBase object at 0x7f7e179047d0>, 'inactive': <pytest_invenio.user.UserFixt...object at 0x7f7e17aa7e90>, 'notification_enabled': <pytest_invenio.user.UserFixtureBase object at 0x7f7e17aa7a10>, ...}
username = 'pubres'
    @pytest.mark.parametrize(
        "username",
        [
            "pub",
            "pubres",
            "res",
        ],
    )
    def test_read_self(user_service, users, username):
        """Users can read themselves."""
        user = users[username]
>       res = user_service.read(user.identity, user.id).to_dict()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/services/users/test_service_users.py:179: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:81: in to_dict
    res = self.data
          ^^^^^^^^^
invenio_users_resources/services/users/results.py:61: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 1, 'version_id': 1, 'email': 'pubres@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'us...26, 2, 17, 10, 4, 30, 404931), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 30, 404936), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
_____________________________ test_read_self[res] ______________________________
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17bed480>
users = {'accented': <pytest_invenio.user.UserFixtureBase object at 0x7f7e179047d0>, 'inactive': <pytest_invenio.user.UserFixt...object at 0x7f7e17aa7e90>, 'notification_enabled': <pytest_invenio.user.UserFixtureBase object at 0x7f7e17aa7a10>, ...}
username = 'res'
    @pytest.mark.parametrize(
        "username",
        [
            "pub",
            "pubres",
            "res",
        ],
    )
    def test_read_self(user_service, users, username):
        """Users can read themselves."""
        user = users[username]
>       res = user_service.read(user.identity, user.id).to_dict()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/services/users/test_service_users.py:179: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:81: in to_dict
    res = self.data
          ^^^^^^^^^
invenio_users_resources/services/users/results.py:61: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 3, 'version_id': 1, 'email': 'res@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'usern...26, 2, 17, 10, 4, 30, 460805), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 30, 460808), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
_______________________________ test_create_user _______________________________
app = <Flask 'invenio'>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17bed480>
user_moderator = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17904350>
user_res = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17aa71d0>
clear_cache = None
search_clear = <OpenSearch([{'host': 'localhost', 'port': 9200}])>
    def test_create_user(
        app, db, user_service, user_moderator, user_res, clear_cache, search_clear
    ):
        """Test user create."""
        data = {
            "username": "newuser",
            "email": "newuser@inveniosoftware.org",
        }
>       res = user_service.create(user_moderator.identity, data).to_dict()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/services/users/test_service_users.py:229: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:81: in to_dict
    res = self.data
          ^^^^^^^^^
invenio_users_resources/services/users/results.py:61: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 10, 'version_id': 1, 'email': 'newuser@inveniosoftware.org', 'domain': 'inveniosoftware.org', '...26, 2, 17, 10, 4, 34, 240367), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 34, 240372), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
----------------------------- Captured stdout call -----------------------------
Content-Type: multipart/mixed; boundary="===============8900316870234666981=="
MIME-Version: 1.0
Subject: Password reset instructions
From: no-reply@localhost
To: newuser@inveniosoftware.org
Date: Tue, 17 Feb 2026 10:04:34 +0000
Message-ID: <177132267463.5722.11083005472911568977@runnervmjduv7.dtyrjvhj1jdubpegzc4liecpve.ex.internal.cloudapp.net>
--===============8900316870234666981==
Content-Type: multipart/alternative; boundary="===============4321039498645580394=="
MIME-Version: 1.0
--===============4321039498645580394==
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Your new account has been created
Click the link below to create a new password:
http://localhost/lost-password/WyIxMCIsIiQ1JHJvdW5kcz01MzUwMDAkVU44Ym4vWWxDWEl1OTYxQyRGTEM4Q3hBZC4xUmMzL1JUR0kzVlI3SGQyS3Q2SS85clB4UlFUaFNBN284Il0.aZQ9Mg.BIus0nmAtTAzaotHKVak29w1i4M
--===============4321039498645580394==
Content-Type: text/html; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
<p>Your new account has been created</p>
<p>
  <a href="http://localhost/lost-password/WyIxMCIsIiQ1JHJvdW5kcz01MzUwMDAkVU44Ym4vWWxDWEl1OTYxQyRGTEM4Q3hBZC4xUmMzL1JUR0kzVlI3SGQyS3Q2SS85clB4UlFUaFNBN284Il0.aZQ9Mg.BIus0nmAtTAzaotHKVak29w1i4M">Click here to create a new password</a>
</p>
--===============4321039498645580394==--
--===============8900316870234666981==--
___________________________ test_create_user_errors ____________________________
app = <Flask 'invenio'>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17bed480>
user_moderator = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17904350>
user_res = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17aa71d0>
clear_cache = None
search_clear = <OpenSearch([{'host': 'localhost', 'port': 9200}])>
    def test_create_user_errors(
        app, db, user_service, user_moderator, user_res, clear_cache, search_clear
    ):
        """Test user create errors."""
        # Invalid values
        with pytest.raises(ValidationError) as exc_info:
            user_service.create(
                user_moderator.identity,
                {
                    "username": "a",
                    "email": "invalid",
                },
            )
        assert exc_info.value.messages == {
            "email": ["Not a valid email address."],
            "username": [
                "Username must start with a letter, be at least three characters long "
                "and only contain alphanumeric characters, dashes and underscores.",
            ],
        }
        # Invalid values for username not starting with alpha
        with pytest.raises(ValidationError) as exc_info:
            user_service.create(
                user_moderator.identity,
                {
                    "username": "_aaa",
                    "email": "valid@up.com",
                },
            )
        assert exc_info.value.messages == {
            "username": [
                "Username must start with a letter, be at least three "
                "characters long and only contain alphanumeric characters, dashes and "
                "underscores."
            ],
        }
        # Invalid values for username with non alpha, dash or underscore
        with pytest.raises(ValidationError) as exc_info:
            user_service.create(
                user_moderator.identity,
                {
                    "username": "aaaa_1-:",
                    "email": "valid@up.com",
                },
            )
        assert exc_info.value.messages == {
            "username": [
                "Username must start with a letter, be at least three "
                "characters long and only contain alphanumeric characters, dashes and "
                "underscores."
            ],
        }
        data = {
            "username": "newuser",
            "email": "newuser@inveniosoftware.org",
        }
>       user_service.create(user_moderator.identity, data).to_dict()
tests/services/users/test_service_users.py:303: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:81: in to_dict
    res = self.data
          ^^^^^^^^^
invenio_users_resources/services/users/results.py:61: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 11, 'version_id': 1, 'email': 'newuser@inveniosoftware.org', 'domain': 'inveniosoftware.org', '...26, 2, 17, 10, 4, 35, 162688), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 35, 162694), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
----------------------------- Captured stdout call -----------------------------
Content-Type: multipart/mixed; boundary="===============0455144728411898392=="
MIME-Version: 1.0
Subject: Password reset instructions
From: no-reply@localhost
To: newuser@inveniosoftware.org
Date: Tue, 17 Feb 2026 10:04:35 +0000
Message-ID: <177132267556.5722.5756152235033905334@runnervmjduv7.dtyrjvhj1jdubpegzc4liecpve.ex.internal.cloudapp.net>
--===============0455144728411898392==
Content-Type: multipart/alternative; boundary="===============5422115247412489083=="
MIME-Version: 1.0
--===============5422115247412489083==
Content-Type: text/plain; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Your new account has been created
Click the link below to create a new password:
http://localhost/lost-password/WyIxMSIsIiQ1JHJvdW5kcz01MzUwMDAkcTJZVmZaRG9QMXNjTXF3WSRxbXFKOUxZNzVVQTQ3TzJ0eU1VNWRUbmVheVVFU2VaVVRnNVFEOUNhWGMuIl0.aZQ9Mw.gOlHKQV7B_1YvTyY8bm-UTQ-43k
--===============5422115247412489083==
Content-Type: text/html; charset="utf-8"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
<p>Your new account has been created</p>
<p>
  <a href="http://localhost/lost-password/WyIxMSIsIiQ1JHJvdW5kcz01MzUwMDAkcTJZVmZaRG9QMXNjTXF3WSRxbXFKOUxZNzVVQTQ3TzJ0eU1VNWRUbmVheVVFU2VaVVRnNVFEOUNhWGMuIl0.aZQ9Mw.gOlHKQV7B_1YvTyY8bm-UTQ-43k">Click here to create a new password</a>
</p>
--===============5422115247412489083==--
--===============0455144728411898392==--
__________________________________ test_block __________________________________
app = <Flask 'invenio'>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17bed480>
user_moderator = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17904350>
user_res = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17aa71d0>
clear_cache = None
search_clear = <OpenSearch([{'host': 'localhost', 'port': 9200}])>
    def test_block(
        app, db, user_service, user_moderator, user_res, clear_cache, search_clear
    ):
        """Test user block."""
        with pytest.raises(PermissionDeniedError):
            user_service.block(user_res.identity, user_res.id)
        blocked = user_service.block(user_moderator.identity, user_res.id)
        assert blocked
        ur = user_service.read(user_res.identity, user_res.id)
        # User can't see when it was blocked
>       assert not "blocked_at" in ur.data
                                   ^^^^^^^
tests/services/users/test_service_users.py:327: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:61: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 3, 'version_id': 2, 'email': 'res@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'usern...026, 2, 17, 10, 4, 30, 460805), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 36, 65240), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
_________________________________ test_approve _________________________________
app = <Flask 'invenio'>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17bed480>
user_res = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17aa71d0>
user_moderator = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17904350>
clear_cache = None
search_clear = <OpenSearch([{'host': 'localhost', 'port': 9200}])>
    def test_approve(
        app, db, user_service, user_res, user_moderator, clear_cache, search_clear
    ):
        """Test approval of an user."""
        with pytest.raises(PermissionDeniedError):
            user_service.block(user_res.identity, user_res.id)
        approved = user_service.approve(user_moderator.identity, user_res.id)
        assert approved
        ur = user_service.read(user_res.identity, user_res.id)
        # User can't see when it was approved
>       assert not "verified_at" in ur.data
                                    ^^^^^^^
tests/services/users/test_service_users.py:358: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:61: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 3, 'version_id': 2, 'email': 'res@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'usern...26, 2, 17, 10, 4, 30, 460805), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 36, 605788), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
_______________________________ test_deactivate ________________________________
app = <Flask 'invenio'>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17bed480>
user_res = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17aa71d0>
user_moderator = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17904350>
clear_cache = None
    def test_deactivate(app, db, user_service, user_res, user_moderator, clear_cache):
        """Test deactivation of an user."""
        with pytest.raises(PermissionDeniedError):
            user_service.block(user_res.identity, user_res.id)
        deactivated = user_service.deactivate(user_moderator.identity, user_res.id)
        assert deactivated
        ur = user_service.read(user_res.identity, user_res.id)
        # User can see it's not active
>       assert ur.data["active"] is False
               ^^^^^^^
tests/services/users/test_service_users.py:377: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:61: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 3, 'version_id': 2, 'email': 'res@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'usern...26, 2, 17, 10, 4, 30, 460805), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 37, 105485), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
_________________________________ test_restore _________________________________
app = <Flask 'invenio'>
db = <SQLAlchemy postgresql+psycopg2://invenio:***@localhost:5432/invenio>
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17bed480>
user_res = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17aa71d0>
user_moderator = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17904350>
clear_cache = None
    def test_restore(app, db, user_service, user_res, user_moderator, clear_cache):
        """Test restore of a user."""
        blocked = user_service.block(user_moderator.identity, user_res.id)
        assert blocked
        ur = user_service.read(user_moderator.identity, user_res.id)
>       assert ur.data["active"] == False
               ^^^^^^^
tests/services/users/test_service_users.py:406: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:61: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 3, 'version_id': 2, 'email': 'res@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'usern...26, 2, 17, 10, 4, 30, 460805), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 37, 218531), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
______________________ test_moderation_callbacks_failure _______________________
user_service = <invenio_users_resources.services.users.service.UsersService object at 0x7f7e17801f20>
user_res = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17d9f350>
user_moderator = <pytest_invenio.user.UserFixtureBase object at 0x7f7e17d09cd0>
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x7f7e18785be0>
unblocked = None, clear_cache = None
    def test_moderation_callbacks_failure(
        user_service, user_res, user_moderator, monkeypatch, unblocked, clear_cache
    ):
        """Test moderation actions (post block)
        This aims to test multiple behaviours:
        - If a callback fails, no changes are committed
        - Even if a callback fails, the user block is committed
        """
        def _block_action_success(user_id, uow=None):
            """Action to execute after blocking a user."""
            user_service.approve(system_identity, user_id, uow=uow)
        def _block_action_failure(user_id, uow=None):
            """Action raises an exception."""
            raise Exception("Callback failed")
        monkeypatch.setitem(
            current_actions_registry,
            "block",
            [_block_action_success, _block_action_failure],
        )
        blocked = user_service.block(user_moderator.identity, user_res.id)
        assert blocked
        # Registered callbacks will fail and their result won't be committed
        ur = user_service.read(user_moderator.identity, user_res.id)
>       assert ur.data["active"] == False
               ^^^^^^^
tests/services/users/test_user_moderation.py:74: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
invenio_users_resources/services/users/results.py:61: in data
    self._data = self._schema.dump(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/schema.py:118: in dump
    return self.schema(**schema_args).dump(data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:621: in dump
    result = self._serialize(processed_obj, many=many)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/schema.py:589: in _serialize
    value = field_obj.serialize(attr_name, obj, accessor=self.get_attribute)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:348: in serialize
    return self._serialize(value, attr, obj, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.14/site-packages/marshmallow/fields.py:2026: in _serialize
    return self._serialize_method(obj)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
self = <UserSchema(many=False)>
obj = <UserAggregate: {'id': 3, 'version_id': 4, 'email': 'res@inveniosoftware.org', 'domain': 'inveniosoftware.org', 'usern...26, 2, 17, 10, 4, 38, 199029), 'updated': datetime.datetime(2026, 2, 17, 10, 4, 38, 552864), 'current_login_at': None}>
    def is_self(self, obj):
        """Determine if identity is the current identity."""
>       current_identity = self.context["identity"]
                           ^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'identity'
invenio_users_resources/services/schemas.py:130: KeyError
----------------------------- Captured stderr call -----------------------------
Could not execute action 'block' for user: Error on lock: <Lock user_moderation_lock.3>: Lock failed to be acquired
[2026-02-17 10:04:38,586] WARNING in tasks: Could not execute action 'block' for user: Error on lock: <Lock user_moderation_lock.3>: Lock failed to be acquired
Could not execute action 'block' for user: Error on lock: <Lock user_moderation_lock.3>: Lock failed to be acquired
Could not execute action 'block' for user: Error on lock: <Lock user_moderation_lock.3>: Lock failed to be acquired
Could not execute action 'block' for user: Error on lock: <Lock user_moderation_lock.3>: Lock failed to be acquired
Could not execute action 'block' for user: Error on lock: <Lock user_moderation_lock.3>: Lock failed to be acquired
Could not execute action 'block' for user: Error on lock: <Lock user_moderation_lock.3>: Lock failed to be acquired
Could not execute action 'block' for user: Error on lock: <Lock user_moderation_lock.3>: Lock failed to be acquired
Could not execute action 'block' for user: Error on lock: <Lock user_moderation_lock.3>: Lock failed to be acquired
------------------------------ Captured log call -------------------------------
WARNING  invenio:tasks.py:96 Could not execute action 'block' for user: Error on lock: <Lock user_moderation_lock.3>: Lock failed to be acquired
=============================== warnings summary ===============================
venv/lib/python3.14/site-packages/invenio_records/resolver.py:14
venv/lib/python3.14/site-packages/invenio_records/resolver.py:14
    from jsonschema import RefResolutionError, RefResolver
venv/lib/python3.14/site-packages/invenio_records/resolver.py:14
venv/lib/python3.14/site-packages/invenio_records/resolver.py:14
    from jsonschema import RefResolutionError, RefResolver
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:9
    pyparsing.ParserElement.enablePackrat()
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:52
    oneThru12 = oneOf(["%.2d" % i for i in range(1, 13)])
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:53
    oneThru13 = oneOf(["%.2d" % i for i in range(1, 14)])
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:54
    oneThru23 = oneOf(["%.2d" % i for i in range(1, 24)])
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:55
    zeroThru23 = oneOf(["%.2d" % i for i in range(0, 24)])
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:56
    oneThru29 = oneOf(["%.2d" % i for i in range(1, 30)])
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:57
    oneThru30 = oneOf(["%.2d" % i for i in range(1, 31)])
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:58
    oneThru31 = oneOf(["%.2d" % i for i in range(1, 32)])
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:59
    oneThru59 = oneOf(["%.2d" % i for i in range(1, 60)])
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:60
    zeroThru59 = oneOf(["%.2d" % i for i in range(0, 60)])
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:63
    positiveDigit = Word(nums, exact=1, excludeChars="0")
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:73
    (oneOf("01 03 05 07 08 10 12")("month") + "-" + oneThru31("day"))
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:74
    ^ (oneOf("04 06 09 11")("month") + "-" + oneThru30("day"))
    p.addParseAction(cls.parse_action)
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:119
    UASymbol = Combine(oneOf("? ~ %"))
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:122
    seasonNumber = oneOf("21 22 23 24")
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:155
    l1Start.addParseAction(f)
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:157
    l1End.addParseAction(f)
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:199
    monthWithX = Combine(oneOf("0X 1X") ^ ("X" + digitOrX))("month")
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:303
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:303
    earlier = L("..").addParseAction(f)("lower") + date("upper").addParseAction(f)
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:304
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:304
    later = date("lower").addParseAction(f) + L("..").addParseAction(f)("upper")
venv/lib/python3.14/site-packages/edtf/parser/grammar.py:325
    seasonL2Number = oneOf("21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41")
invenio_users_resources/services/domains/config.py:91
    "self": Link("{+api}/domains/{domain}", vars=domainvar),
invenio_users_resources/services/domains/config.py:92
    "admin_self_html": Link(
invenio_users_resources/services/domains/config.py:95
    "admin_users_html": Link(
invenio_users_resources/services/domains/config.py:99
    links_search = pagination_links("{+api}/domains{?args*}")
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/links.py:57
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/links.py:57
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/links.py:57
    "prev": Link(
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/links.py:64
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/links.py:64
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/links.py:64
    "self": Link(tpl),
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/links.py:65
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/links.py:65
venv/lib/python3.14/site-packages/invenio_records_resources/services/records/links.py:65
    "next": Link(
invenio_users_resources/services/groups/config.py:78
    "self": Link("{+api}/groups/{id}"),
invenio_users_resources/services/groups/config.py:79
    "avatar": Link("{+api}/groups/{id}/avatar.svg"),
invenio_users_resources/services/groups/config.py:81
    links_search = pagination_links("{+api}/groups{?args*}")
invenio_users_resources/services/users/config.py:203
    "self": Link("{+api}/users/{id}"),
invenio_users_resources/services/users/config.py:204
    "avatar": Link("{+api}/users/{id}/avatar.svg"),
invenio_users_resources/services/users/config.py:205
    "records_html": Link("{+ui}/search/records?q=parent.access.owned_by.user:{id}"),
invenio_users_resources/services/users/config.py:206
    "admin_records_html": Link(
invenio_users_resources/services/users/config.py:210
    "admin_drafts_html": Link(
invenio_users_resources/services/users/config.py:214
    "admin_moderation_html": Link(
invenio_users_resources/services/users/config.py:219
    links_search = pagination_links("{+api}/users{?args*}")
    warnings.warn(
    _security.datetime_factory(),
    target.updated = datetime.utcnow()
    created = datetime.utcnow()
    return util.wrap_callable(lambda ctx: fn(), fn)  # type: ignore
    return cls(int(id_s, 16), datetime.utcfromtimestamp(int(created_s, 16)))
    now = now or datetime.utcnow()
tests/resources/test_resources_domains.py::test_domains_read
    current_app.logger.warn(
tests/resources/test_resources_groups.py::test_group_avatar
tests/resources/test_resources_users.py::test_read_self_serialization
tests/services/test_generators.py::test_group_not_managed_generator
tests/services/test_service_groups.py::test_groups_sort
tests/services/test_service_tasks_domains.py::test_import_domain_blocklist
tests/services/users/test_service_users.py::test_search_restricted
tests/services/users/test_user_moderation.py::test_moderation_callbacks_success
tests/test_notifications.py::test_user_recipient_generator
    self.init_app(app)
tests/resources/test_resources_groups.py::test_group_avatar
tests/resources/test_resources_users.py::test_read_self_serialization
tests/services/test_generators.py::test_group_not_managed_generator
tests/services/test_service_groups.py::test_groups_sort
tests/services/test_service_tasks_domains.py::test_import_domain_blocklist
tests/services/users/test_service_users.py::test_search_restricted
tests/services/users/test_user_moderation.py::test_moderation_callbacks_success
tests/test_notifications.py::test_user_recipient_generator
    self._set_cache(app, config)
    self._confirmed = datetime.utcnow() if confirmed else None
  /home/runner/work/test-zip-extract-repository/test-zip-extract-repository/workdir/tests/invenio-users-resources/original/.venv/lib/python3.14/site-packages/flask_security/datastore.py:235: LegacyAPIWarning: The Query.get() method is considered legacy as of the 1.x series of SQLAlchemy and becomes a legacy construct in 2.0. The method is now available as Session.get() (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    return self.user_model.query.get(identifier)
tests/resources/test_resources_groups.py::test_group_avatar
tests/resources/test_resources_users.py::test_user_avatar
tests/resources/test_resources_users.py::test_user_avatar_non_ascii
    max_age = datetime.utcnow() - timedelta(days=7)
tests/resources/test_resources_users.py::test_create_user
tests/services/users/test_service_users.py::test_create_user
tests/services/users/test_service_users.py::test_create_user_errors
    user.confirmed_at = datetime.utcnow()
tests/resources/test_resources_users.py::test_create_user
tests/resources/test_resources_users.py::test_approve_user
tests/services/users/test_service_users.py::test_create_user
tests/services/users/test_service_users.py::test_create_user_errors
tests/services/users/test_service_users.py::test_approve
    now = datetime.utcnow()
    self._created = datetime.utcnow()
tests/resources/test_resources_users.py::test_block_user
tests/services/users/test_service_users.py::test_block
tests/services/users/test_service_users.py::test_restore
tests/services/users/test_user_moderation.py::test_moderation_callbacks_success
tests/services/users/test_user_moderation.py::test_moderation_callbacks_failure
tests/services/users/test_user_moderation.py::test_moderation_callbacks_lock
tests/services/users/test_user_moderation.py::test_moderation_callbacks_lock_renewal[1-10-True]
tests/services/users/test_user_moderation.py::test_moderation_callbacks_lock_renewal[2-2-False]
    now = datetime.utcnow()
tests/services/users/test_user_moderation.py::test_moderation_callbacks_failure
tests/services/users/test_user_moderation.py::test_moderation_callbacks_lock_renewal[2-2-False]
    current_app.logger.warn(
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.14.2-final-0 ________________
Name                                                                      Stmts   Miss  Cover   Missing
invenio_users_resources/__init__.py                                           2      0   100%
invenio_users_resources/config.py                                            30      0   100%
invenio_users_resources/entity_resolvers.py                                  82     45    45%   36-43, 47-53, 57, 61-62, 66-90, 102-103, 107, 111, 115, 119, 128-136, 140-145, 149-150, 160, 173-174, 178, 182, 186, 190
invenio_users_resources/ext.py                                               64      5    92%   115-118, 126
invenio_users_resources/forms.py                                             14      5    64%   30-32, 38-39
invenio_users_resources/models.py                                            10      4    60%   21, 25, 29, 39
invenio_users_resources/notifications/__init__.py                             0      0   100%
invenio_users_resources/notifications/filters.py                             11      1    91%   23
invenio_users_resources/notifications/generators.py                          37     15    59%   25, 47, 51-53, 61-62, 67-68, 76-77, 80-85
invenio_users_resources/permissions.py                                        3      0   100%
invenio_users_resources/proxies.py                                           12      0   100%
invenio_users_resources/records/__init__.py                                   2      0   100%
invenio_users_resources/records/api.py                                      266     20    92%   93, 102, 108, 134, 138, 140, 228-232, 251-254, 263, 270, 277, 284, 296, 367
invenio_users_resources/records/dumpers/__init__.py                           2      0   100%
invenio_users_resources/records/dumpers/email.py                             15      0   100%
invenio_users_resources/records/hooks.py                                     45     16    64%   36-41, 44-49, 73, 78, 82, 88
invenio_users_resources/records/mappings/__init__.py                          0      0   100%
invenio_users_resources/records/mappings/os-v1/__init__.py                    0      0   100%
invenio_users_resources/records/mappings/os-v2/__init__.py                    0      0   100%
invenio_users_resources/records/mappings/v7/__init__.py                       0      0   100%
invenio_users_resources/records/models.py                                    98     11    89%   54, 85, 90, 152-154, 178-182
invenio_users_resources/records/systemfields/__init__.py                     72      0   100%
invenio_users_resources/resources/__init__.py                                 4      0   100%
invenio_users_resources/resources/domains/__init__.py                         3      0   100%
invenio_users_resources/resources/domains/config.py                          11      0   100%
invenio_users_resources/resources/domains/resource.py                         6      0   100%
invenio_users_resources/resources/groups/__init__.py                          3      0   100%
invenio_users_resources/resources/groups/config.py                           11      0   100%
invenio_users_resources/resources/groups/resource.py                         24      4    83%   44-49, 55-59
invenio_users_resources/resources/users/__init__.py                           3      0   100%
invenio_users_resources/resources/users/config.py                            19      0   100%
invenio_users_resources/resources/users/errors.py                             4      0   100%
invenio_users_resources/resources/users/resource.py                          74     12    84%   50, 79, 86-91, 149-153, 167-171, 176-181
invenio_users_resources/services/__init__.py                                  4      0   100%
invenio_users_resources/services/common.py                                    5      0   100%
invenio_users_resources/services/domains/__init__.py                          3      0   100%
invenio_users_resources/services/domains/components.py                       27      6    78%   50-59
invenio_users_resources/services/domains/config.py                           29      0   100%
invenio_users_resources/services/domains/facets.py                            7      0   100%
invenio_users_resources/services/domains/service.py                           8      0   100%
invenio_users_resources/services/domains/tasks.py                            61     15    75%   25-30, 36-41, 71-73
invenio_users_resources/services/generators.py                               80     11    86%   37, 54-59, 86, 95, 104, 106, 161
invenio_users_resources/services/groups/__init__.py                           3      0   100%
invenio_users_resources/services/groups/config.py                            30      0   100%
invenio_users_resources/services/groups/results.py                           57      6    89%   39, 43, 59, 77, 83, 126
invenio_users_resources/services/groups/service.py                           26      7    73%   32, 38-39, 48, 54-58
invenio_users_resources/services/groups/tasks.py                             21      8    62%   27-28, 34-39
invenio_users_resources/services/params.py                                    9      0   100%
invenio_users_resources/services/permissions.py                              31      0   100%
invenio_users_resources/services/results.py                                  29      0   100%
invenio_users_resources/services/schemas.py                                 144     12    92%   132-134, 199-202, 210, 213, 216, 259, 271, 281
invenio_users_resources/services/users/__init__.py                            3      0   100%
invenio_users_resources/services/users/config.py                             44      6    86%   47-49, 54-57
invenio_users_resources/services/users/facets.py                              7      0   100%
invenio_users_resources/services/users/lock.py                               11      0   100%
invenio_users_resources/services/users/results.py                            57     15    74%   39, 43, 48, 59, 69-72, 77, 82-84, 110-113, 127
invenio_users_resources/services/users/search_params.py                      23      8    65%   37-55
invenio_users_resources/services/users/service.py                           134     24    82%   142, 148-149, 158, 164-166, 184, 204-219, 231, 254, 266, 277-283
invenio_users_resources/services/users/tasks.py                              49      8    84%   56-57, 63-68
invenio_users_resources/templates/security/email/new_user_via_admin.txt       3      1    67%   3
invenio_users_resources/views.py                                             11      0   100%
TOTAL                                                                      1843    265    86%
=========================== short test summary info ============================
FAILED tests/resources/test_resources_users.py::test_read_self_serialization - KeyError: 'identity'
FAILED tests/resources/test_resources_users.py::test_read_logged_in_serialization[pub] - KeyError: 'identity'
FAILED tests/resources/test_resources_users.py::test_read_logged_in_serialization[pubres] - KeyError: 'identity'
FAILED tests/resources/test_resources_users.py::test_create_user - KeyError: 'identity'
FAILED tests/resources/test_resources_users.py::test_approve_user - KeyError: 'identity'
FAILED tests/resources/test_resources_users.py::test_block_user - KeyError: 'identity'
FAILED tests/resources/test_resources_users.py::test_deactivate_user - KeyError: 'identity'
FAILED tests/resources/test_resources_users.py::test_impersonate_user - KeyError: 'identity'
FAILED tests/resources/test_resources_users.py::test_admin_links[admin_records_html-/administration/records?q=parent.access.owned_by.user:{id}&f=allversions] - KeyError: 'identity'
FAILED tests/resources/test_resources_users.py::test_admin_links[admin_drafts_html-/administration/drafts?q=parent.access.owned_by.user:{id}&f=allversions] - KeyError: 'identity'
FAILED tests/resources/test_resources_users.py::test_admin_links[admin_moderation_html-/administration/moderation?q=topic.user:{id}] - KeyError: 'identity'
FAILED tests/resources/test_resources_users.py::test_admin_links_visibility[user_moderator-True] - KeyError: 'identity'
FAILED tests/resources/test_resources_users.py::test_admin_links_visibility[pub-False] - KeyError: 'identity'
FAILED tests/resources/test_resources_users.py::test_admin_links_visibility[res-False] - KeyError: 'identity'
FAILED tests/services/users/test_service_users.py::test_search_restricted - KeyError: 'identity'
FAILED tests/services/users/test_service_users.py::test_search_public_users - KeyError: 'identity'
FAILED tests/services/users/test_service_users.py::test_admin_search_field[affiliations:CERN] - KeyError: 'identity'
FAILED tests/services/users/test_service_users.py::test_admin_search_field[affiliation:CERN] - KeyError: 'identity'
FAILED tests/services/users/test_service_users.py::test_admin_search_field[name:Jose affiliation:CERN] - KeyError: 'identity'
FAILED tests/services/users/test_service_users.py::test_admin_search_field[+name:Jose +affiliation:CERN] - KeyError: 'identity'
FAILED tests/services/users/test_service_users.py::test_admin_search_field[CERN] - KeyError: 'identity'
FAILED tests/services/users/test_service_users.py::test_admin_search_field[Tim] - KeyError: 'identity'
FAILED tests/services/users/test_service_users.py::test_admin_search_field[Tim CERN] - KeyError: 'identity'
FAILED tests/services/users/test_service_users.py::test_admin_search_field[Jose] - KeyError: 'identity'
FAILED tests/services/users/test_service_users.py::test_admin_search_field[Jos] - KeyError: 'identity'
FAILED tests/services/users/test_service_users.py::test_admin_search_field[Jose CERN] - KeyError: 'identity'
FAILED tests/services/users/test_service_users.py::test_admin_search_field[email:pub@inveniosoftware.org] - KeyError: 'identity'
FAILED tests/services/users/test_service_users.py::test_admin_search_field[username:pub] - KeyError: 'identity'
FAILED tests/services/users/test_service_users.py::test_user_search_field[CERN] - KeyError: 'identity'
FAILED tests/services/users/test_service_users.py::test_user_search_field[Jose CERN] - KeyError: 'identity'
FAILED tests/services/users/test_service_users.py::test_user_search_field[Jose AND CERN] - KeyError: 'identity'
FAILED tests/services/users/test_service_users.py::test_user_search_field[Tim] - KeyError: 'identity'
FAILED tests/services/users/test_service_users.py::test_user_search_field[Tim CERN] - KeyError: 'identity'
FAILED tests/services/users/test_service_users.py::test_user_search_field[Jose] - KeyError: 'identity'
FAILED tests/services/users/test_service_users.py::test_user_search_field[Jos] - KeyError: 'identity'
FAILED tests/services/users/test_service_users.py::test_user_search_field[pub@inveniosoftware.org] - KeyError: 'identity'
FAILED tests/services/users/test_service_users.py::test_user_search_field[pub] - KeyError: 'identity'
FAILED tests/services/users/test_service_users.py::test_read_with_logged_in - KeyError: 'identity'
FAILED tests/services/users/test_service_users.py::test_read_self[pub] - KeyError: 'identity'
FAILED tests/services/users/test_service_users.py::test_read_self[pubres] - KeyError: 'identity'
FAILED tests/services/users/test_service_users.py::test_read_self[res] - KeyError: 'identity'
FAILED tests/services/users/test_service_users.py::test_create_user - KeyError: 'identity'
FAILED tests/services/users/test_service_users.py::test_create_user_errors - KeyError: 'identity'
FAILED tests/services/users/test_service_users.py::test_block - KeyError: 'identity'
FAILED tests/services/users/test_service_users.py::test_approve - KeyError: 'identity'
FAILED tests/services/users/test_service_users.py::test_deactivate - KeyError: 'identity'
FAILED tests/services/users/test_service_users.py::test_restore - KeyError: 'identity'
FAILED tests/services/users/test_user_moderation.py::test_moderation_callbacks_failure - KeyError: 'identity'
================= 48 failed, 48 passed, 550 warnings in 27.12s =================
 Container docker_services_cli-redis-1  Stopping
 Container docker_services_cli-rabbitmq-1  Stopping
 Container docker_services_cli-postgresql-1  Stopping
 Container docker_services_cli-opensearch-1  Stopping
 Container docker_services_cli-redis-1  Stopped
 Container docker_services_cli-redis-1  Removing
 Container docker_services_cli-postgresql-1  Stopped
 Container docker_services_cli-postgresql-1  Removing
 Container docker_services_cli-redis-1  Removed
 Container docker_services_cli-postgresql-1  Removed
 Container docker_services_cli-opensearch-1  Stopped
 Container docker_services_cli-opensearch-1  Removing
 Container docker_services_cli-opensearch-1  Removed
 Container docker_services_cli-rabbitmq-1  Stopped
 Container docker_services_cli-rabbitmq-1  Removing
 Container docker_services_cli-rabbitmq-1  Removed
 Network docker_services_cli_default  Removing
 Network docker_services_cli_default  Removed
